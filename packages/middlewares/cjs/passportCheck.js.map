{"version":3,"sources":["../src/passportCheck.js"],"sourcesContent":["/**\n * Middleware to check user logged in status based on passport\n * @module Middleware_PassportCheck\n */\n\nimport { HttpCode } from '@kitmi/types';\n\nconst middlewareName = 'passportCheck';\n\n/**\n * Initialize ensureLoggedIn middleware\n * @param {object} options\n * @property {string} [options.loginUrl] - If given, will redirect to loginUrl if not loggedIn\n * @property {boolean} [options.successReturnToOrRedirect] - If given, will redirect to loginUrl if not loggedIn\n * @param {Routable} app\n */\nconst passportCheck = (options, app) => {\n    const { successReturnToOrRedirect, loginUrl } = app.middlewareConfig(\n        opt,\n        {\n            schema: {\n                successReturnToOrRedirect: { type: 'boolean', default: false },\n                loginUrl: { type: 'type', optional: true },\n            },\n        },\n        middlewareName\n    );\n\n    app.requireServices(['passport']);\n\n    return async (ctx, next) => {\n        if (ctx.isAuthenticated()) {\n            return next();\n        }\n\n        if (successReturnToOrRedirect && ctx.session) {\n            ctx.session.returnTo = ctx.originalUrl || ctx.url;\n        }\n\n        if (!loginUrl) {\n            ctx.throw(HttpCode.UNAUTHORIZED, 'authentication required');\n        }\n\n        return ctx.redirect(loginUrl);\n    };\n};\n\nexport default passportCheck;\n"],"names":["middlewareName","passportCheck","options","app","successReturnToOrRedirect","loginUrl","middlewareConfig","opt","schema","type","default","optional","requireServices","ctx","next","isAuthenticated","session","returnTo","originalUrl","url","throw","HttpCode","UNAUTHORIZED","redirect"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA;;;CAGC;;;;+BA4CD;;;eAAA;;;uBA1CyB;AAEzB,MAAMA,iBAAiB;AAEvB;;;;;;CAMC,GACD,MAAMC,gBAAgB,CAACC,SAASC;IAC5B,MAAM,EAAEC,yBAAyB,EAAEC,QAAQ,EAAE,GAAGF,IAAIG,gBAAgB,CAChEC,KACA;QACIC,QAAQ;YACJJ,2BAA2B;gBAAEK,MAAM;gBAAWC,SAAS;YAAM;YAC7DL,UAAU;gBAAEI,MAAM;gBAAQE,UAAU;YAAK;QAC7C;IACJ,GACAX;IAGJG,IAAIS,eAAe,CAAC;QAAC;KAAW;IAEhC,OAAO,OAAOC,KAAKC;QACf,IAAID,IAAIE,eAAe,IAAI;YACvB,OAAOD;QACX;QAEA,IAAIV,6BAA6BS,IAAIG,OAAO,EAAE;YAC1CH,IAAIG,OAAO,CAACC,QAAQ,GAAGJ,IAAIK,WAAW,IAAIL,IAAIM,GAAG;QACrD;QAEA,IAAI,CAACd,UAAU;YACXQ,IAAIO,KAAK,CAACC,eAAQ,CAACC,YAAY,EAAE;QACrC;QAEA,OAAOT,IAAIU,QAAQ,CAAClB;IACxB;AACJ;MAEA,WAAeJ"}