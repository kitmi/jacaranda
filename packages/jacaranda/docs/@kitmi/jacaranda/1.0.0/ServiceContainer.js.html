<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ServiceContainer.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="App.html">App</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#addFeatureRegistry">addFeatureRegistry</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#enabled">enabled</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#getService">getService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#hasService">hasService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#loadConfig_">loadConfig_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#logException">logException</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#registerService">registerService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#start_">start_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#stop_">stop_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#toAbsolutePath">toAbsolutePath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="App.html#tryRequire_">tryRequire_</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Installer.html">Installer</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Runnable.html">Runnable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.getLib">getLib</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.getService">getService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.registerLib">registerLib</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.requireFromLib">requireFromLib</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.start_">start_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Runnable.html#.stop_">stop_</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Runnable_.html">Runnable</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ServiceContainer.html">ServiceContainer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#addFeatureRegistry">addFeatureRegistry</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#enabled">enabled</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#getService">getService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#hasService">hasService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#loadConfig_">loadConfig_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#logException">logException</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#registerService">registerService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#start_">start_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#stop_">stop_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#toAbsolutePath">toAbsolutePath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ServiceContainer.html#tryRequire_">tryRequire_</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ServiceInstaller.html">ServiceInstaller</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WebModule.html">WebModule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebModule.html#requireFromApp">requireFromApp</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WebServer.html">WebServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#getAppByAlias">getAppByAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#getAppByRoute">getAppByRoute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#getService">getService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#mountApp">mountApp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#require">require</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebServer.html#requireFromApp">requireFromApp</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-Feature_CommandLine-CommandLine.html">CommandLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_CommandLine-CommandLine.html#validate_">validate_</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-Feature_CommandLine-CommandLineArgumentError.html">CommandLineArgumentError</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-Feature_HttpClient-HttpClient.html">HttpClient</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_HttpClient-HttpClient.html#do">do</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="Feature_Settings%250A%250A_settings__%2520%257B%250A%2520%2520%2520%2520_key__%25201,%250A%2520%2520%2520%2520_env_development__%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520_key__%25202%250A%2520%2520%2520%2520%257D,%250A%2520%2520%2520%2520_stage_ppe__%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520_key__%25203%250A%2520%2520%2520%2520%257D%250A%257Dmodule_.html">Feature_Settings

"settings": {
    "key": 1,
    "env:development": {
        "key": 2
    },
    "stage:ppe": {
        "key": 3
    }
}</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Feature_Settings%25250A%25250A_settings__%252520%25257B%25250A%252520%252520%252520%252520_key__%2525201,%25250A%252520%252520%252520%252520_env_development__%252520%25257B%25250A%252520%252520%252520%252520%252520%252520%252520%252520_key__%2525202%25250A%252520%252520%252520%252520%25257D,%25250A%252520%252520%252520%252520_stage_ppe__%252520%25257B%25250A%252520%252520%252520%252520%252520%252520%252520%252520_key__%2525203%25250A%252520%252520%252520%252520%25257D%25250A%25257Dmodule_.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_AppRouting.html">Feature_AppRouting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_AppRouting.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_CommandLine.html">Feature_CommandLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_CommandLine.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_ConfigByGitUser.html">Feature_ConfigByGitUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_ConfigByGitUser.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_ConfigByHostname.html">Feature_ConfigByHostname</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_ConfigByHostname.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_CustomConfig.html">Feature_CustomConfig</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_CustomConfig.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Env.html">Feature_Env</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Env.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_FeatureRegistry.html">Feature_FeatureRegistry</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_FeatureRegistry.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Hasher.html">Feature_Hasher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Hasher.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_HttpClient.html">Feature_HttpClient</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_ImageProcessor.html">Feature_ImageProcessor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_ImageProcessor.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_LibModules.html">Feature_LibModules</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_LibModules.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Logger.html">Feature_Logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Logger.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_MiddlewareFactory.html">Feature_MiddlewareFactory</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_MiddlewareFactory.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Middlewares.html">Feature_Middlewares</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Middlewares.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Passport.html">Feature_Passport</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Passport.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Routing.html">Feature_Routing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Routing.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_ServiceGroup.html">Feature_ServiceGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_ServiceGroup.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_ThreadPool.html">Feature_ThreadPool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_ThreadPool.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_TtlMemCache.html">Feature_TtlMemCache</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_TtlMemCache.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Version.html">Feature_Version</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_Version.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_AccessLog.html">Middleware_AccessLog</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_Action.html">Middleware_Action</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Middleware_Action.html#~action">action</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_Csrf.html">Middleware_Csrf</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_Favicon.html">Middleware_Favicon</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_JsonError.html">Middleware_JsonError</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_PassportAuth.html">Middleware_PassportAuth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Middleware_PassportAuth.html#~passportAuth">passportAuth</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_PassportCheck.html">Middleware_PassportCheck</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Middleware_PassportCheck.html#~passportCheck">passportCheck</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_ServeStatic.html">Middleware_ServeStatic</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Middleware_ServerPassport.html">Middleware_ServerPassport</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Middleware_ServerPassport.html#~usePassport">usePassport</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Router_JaREST.html">Router_JaREST</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Router_JaREST.html#~jaRestRouter">jaRestRouter</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Router_Module.html">Router_Module</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Router_Module.html#~moduleRouter">moduleRouter</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Router_REST.html">Router_REST</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Router_REST.html#~restRouter">restRouter</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Router_Rule.html">Router_Rule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Router_Rule.html#~load_">load_</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="App.html#event:configLoaded">configLoaded</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="App.html#event:ready">ready</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="App.html#event:stopping">stopping</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="ServiceContainer.html#event:configLoaded">configLoaded</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="ServiceContainer.html#event:ready">ready</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="ServiceContainer.html#event:stopping">stopping</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Feature">Feature</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addRoute_">addRoute_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addRouter">addRouter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#enabled">enabled</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getMiddlewareFactory">getMiddlewareFactory</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getService">getService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hasService">hasService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#httpMethod">httpMethod</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadMiddlewaresFrom">loadMiddlewaresFrom</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#middleware">middleware</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#registerMiddlewareFactory">registerMiddlewareFactory</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#require">require</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#requireFromLib">requireFromLib</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#startLoopWorker">startLoopWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#startQueueWorker">startQueueWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#startWorker">startWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toWebPath">toWebPath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#useMiddleware">useMiddleware</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#useMiddlewares_">useMiddlewares_</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">ServiceContainer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ConfigLoader, { JsonConfigProvider, YamlConfigProvider } from '@kitmi/config';
import { _, pushIntoBucket, eachAsync_, arrayToObject, esmCheck } from '@kitmi/utils';
import { fs, tryRequire as _tryRequire } from '@kitmi/sys';
import { InvalidConfiguration, ValidationError } from '@kitmi/types';
import { Types } from '@kitmi/validators/allSync';
import { TopoSort } from '@kitmi/algo';

import path from 'node:path';

import Feature from './Feature';
import defaultOpts from './defaultOpts';
import AsyncEmitter from './helpers/AsyncEmitter';
import { consoleLogger, makeLogger } from './logger';

const FILE_EXT = ['.js', '.mjs', '.cjs', '.ts'];

const configOverrider = (defConf, envConf) => {
    const { serviceGroup: defServiceGroup, ..._def } = defConf ?? {};
    const { serviceGroup: envServiceGroup, ..._env } = envConf ?? {};

    const serviceGroup = {};

    if (defServiceGroup || envServiceGroup) {
        defServiceGroup &amp;&amp;
            _.each(defServiceGroup, (servicesMap, serviceName) => {
                serviceGroup[serviceName] = servicesMap;
            });

        envServiceGroup &amp;&amp;
            _.each(envServiceGroup, (servicesMap, serviceName) => {
                serviceGroup[serviceName] = {
                    ...serviceGroup[serviceName],
                    ...servicesMap,
                };
            });
    }

    const ret = {
        ..._def,
        ..._env,
    };

    if (!_.isEmpty(serviceGroup)) {
        ret.serviceGroup = serviceGroup;
    }

    return ret;
};

/**
 * Service container class.
 * @class
 */
class ServiceContainer extends AsyncEmitter {
    _loggerLog = (...args) => {
        this.logger.log(...args);
        return this;
    };

    logError = (error, message) => {
        return this.logException('error', error, message);
    };

    logErrorAsWarning = (error, message) => {
        return this.logException('warn', error, message);
    };

    /**
     * @param {string} name - The name of the container instance.
     * @param {object} [options] - Container options
     * @property {string} [options.env] - Environment, default to process.env.NODE_ENV
     * @property {string} [options.workingPath] - App's working path, default to process.cwd()
     * @property {string} [options.configPath="conf"] - App's config path, default to "conf" under workingPath
     * @property {string} [options.configName="app"] - App's config basename, default to "app"
     * @property {string} [options.configType="json"] - App's config type, default to "json"
     * @property {string} [options.disableEnvAwareConfig=false] - Don't use environment-aware config
     * @property {array} [options.allowedFeatures] - A list of enabled feature names
     * @property {boolean} [options.loadConfigFromOptions=false] - Whether to load config from passed-in options
     * @property {object} [options.config] - Config in options, used only when loadConfigFromOptions
     */
    constructor(name, options) {
        super();

        /**
         * Name of the app
         * @member {object}
         **/
        this.name = name;

        /**
         * App options
         * @member {object}
         */
        this.options = {
            ...defaultOpts,
            ...options,
        };

        /**
         * Environment flag
         * @member {string}
         */
        this.env = this.options.env;

        /**
         * Working directory of this cli app
         * @member {string}
         */
        this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();

        /**
         * Config path
         * @member {string}
         */
        this.configPath = this.toAbsolutePath(this.options.configPath);

        /**
         * Source files path.
         * @member {string}
         **/
        this.sourcePath = this.toAbsolutePath(this.options.sourcePath);

        /**
         * Feature path
         */
        this.featuresPath = path.resolve(this.sourcePath, this.options.featuresPath);

        this._logCache = [];

        // dummy
        this.log = (...args) => {
            this._logCache.push(args);
            return this;
        };
    }

    /**
     * Start the container.
     * @fires ServiceContainer#configLoaded
     * @fires ServiceContainer#ready
     * @returns {Promise.&lt;ServiceContainer>}
     */
    async start_() {
        this.log('verbose', `Starting app [${this.name}] ...`);

        await this.emit_('starting', this);

        this._featureRegistry = {
            //firstly look up "features" under current working path, and then try the builtin features path
            '*': this._getFeatureFallbackPath(),
        };

        /**
         * Loaded features, name => feature object
         * @member {object}
         */
        this.features = {};

        /**
         * Loaded services
         * @member {object}
         */
        this.services = {};

        if (this.options.loadConfigFromOptions) {
            this.config = this.options.config;
        } else {
            let configLoader;

            if (this.options.configType === 'yaml') {
                configLoader = this.options.disableEnvAwareConfig
                    ? new ConfigLoader(
                          new YamlConfigProvider(path.join(this.configPath, this.options.configName + '.yaml')),
                          this
                      )
                    : ConfigLoader.createEnvAwareYamlLoader(
                          this.configPath,
                          this.options.configName,
                          this.env,
                          this,
                          configOverrider
                      );
            } else {
                configLoader = this.options.disableEnvAwareConfig
                    ? new ConfigLoader(
                          new JsonConfigProvider(path.join(this.configPath, this.options.configName + '.json')),
                          this
                      )
                    : ConfigLoader.createEnvAwareJsonLoader(
                          this.configPath,
                          this.options.configName,
                          this.env,
                          this,
                          configOverrider
                      );
            }

            /**
             * Configuration loader instance
             * @member {ConfigLoader}
             */
            this.configLoader = configLoader;

            await this.loadConfig_();
        }

        /**
         * Config loaded event.
         * @event ServiceContainer#configLoaded
         */
        await this.emit_('configLoaded', this.config);

        if (!_.isEmpty(this.config)) {
            await this._loadFeatures_();
        } else {            
            this.log('verbose', `Empty configuration! Config path: ${this.configPath}`);
            this.flushLogCache();
        }

        /**
         * App ready
         * @event ServiceContainer#ready
         */
        await this.emit_('ready', this);

        /**
         * Flag showing the app is started or not.
         * @member {bool}
         */
        this.started = true;

        return this;
    }

    /**
     * Stop the container
     * @fires ServiceContainer#stopping
     * @returns {Promise.&lt;ServiceContainer>}
     */
    async stop_() {
        /**
         * App stopping
         * @event ServiceContainer#stopping
         */
        await this.emit_('stopping', this);

        this.log('verbose', `Stopping app [${this.name}] ...`);

        this.started = false;

        delete this.services;
        delete this.features;
        delete this._featureRegistry;

        delete this.config;
        delete this.configLoader;

        await this.emit_('stopped', this);

        this.allOff();
    }

    /**
     * @returns {ServiceContainer}
     */
    async loadConfig_() {
        let configVariables = this._getConfigVariables();

        /**
         * App configuration
         * @member {object}
         */
        this.config = await this.configLoader.load_(configVariables);

        return this;
    }

    /**
     * Translate a relative path of this app module to an absolute path
     * @param {array} args - Array of path parts
     * @returns {string}
     */
    toAbsolutePath(...args) {
        args = args.filter((arg) => arg != null);
        if (args.length === 0) {
            return this.workingPath;
        }

        return path.resolve(this.workingPath, ...args);
    }

    tryRequire(pkgName, local) {
        const obj = local ? require(pkgName) : _tryRequire(pkgName, this.workingPath);
        return esmCheck(obj);
    }

    /**
     * Try to require a package, if it's an esm module, import it.
     * @param {*} pkgName
     * @param {*} useDefault
     * @returns
     */
    async tryRequire_(pkgName, useDefault) {
        try {
            return this.tryRequire(pkgName);
        } catch (error) {
            if (error.code === 'ERR_REQUIRE_ESM') {
                const esmModule = await import(pkgName);
                if (useDefault) {
                    return esmModule.default;
                }
                return esmModule;
            }
            throw error;
        }
    }

    /**
     * Register a service
     * @param {string} name
     * @param {object} serviceObject
     * @param {boolean} override
     */
    registerService(name, serviceObject, override) {
        if (name in this.services &amp;&amp; !override) {
            throw new Error('Service "' + name + '" already registered!');
        }

        this.services[name] = serviceObject;
        this.log('verbose', `Service "${name}" registered.`);
        return this;
    }

    /**
     * Check whether a service exists
     * @param {*} name
     * @returns {boolean}
     */
    hasService(name) {
        return name in this.services;
    }

    /**
     * Get a service from module hierarchy
     * @param name
     * @returns {object}
     */
    getService(name) {
        return this.services[name];
    }

    /**
     * Check whether a feature is enabled in the app.
     * @param {string} feature
     * @returns {bool}
     */
    enabled(feature) {
        return this.features[feature]?.enabled || this.host?.enabled(feature) || false;
    }

    /**
     * Add more or overide current feature registry
     * @param {object} registry
     */
    addFeatureRegistry(registry) {
        // * is used as the fallback location to find a feature
        if (registry.hasOwnProperty('*')) {
            pushIntoBucket(this._featureRegistry, '*', registry['*']);
        }

        Object.assign(this._featureRegistry, _.omit(registry, ['*']));
    }

    /**
     * Helper method to log an exception
     * @param {*} level
     * @param {*} error
     * @param {*} summary
     * @returns {ServiceContainer}
     */
    logException(level, error, summary) {
        this.log(
            level,
            (summary ? summary + '\n' : '') + error.message,
            _.pick(error, ['name', 'status', 'code', 'info', 'stack', 'request'])
        );
        return this;
    }

    trace(...args) {
        return this.log('trace', ...args);
    }

    debug(...args) {
        return this.log('debug', ...args);
    }

    verbose(...args) {
        return this.log('verbose', ...args);
    }

    info(...args) {
        return this.log('info', ...args);
    }

    warn(...args) {
        return this.log('warn', ...args);
    }

    error(...args) {
        return this.log('error', ...args);
    }

    featureConfig(config, typeInfo, name) {
        return this.sanitize(config, typeInfo, name);
    }

    sanitize(config, typeInfo, name, category) {
        try {
            return Types.OBJECT.sanitize(config, { type: 'object', ...typeInfo }, this.i18n, name);
        } catch (err) {
            let message;

            if (err instanceof ValidationError) {
                message = ValidationError.formatError(err);
            } else {
                message = err.message;
            }
            throw new InvalidConfiguration(message, this, category ? `${category}::${name}` : name);
        }
    }

    _getConfigVariables() {
        const processInfo = {
            env: process.env,
            arch: process.arch, // The operating system CPU architecture， 'arm', 'arm64','x64', ...
            argv: process.argv,
            cwd: process.cwd(),
            pid: process.pid,
            platform: process.platform,
        };

        return {
            app: this,
            env: this.env,
            process: processInfo,
        };
    }

    _getFeatureFallbackPath() {
        return [path.resolve(__dirname, 'features'), this.featuresPath];
    }

    _sortFeatures(features) {
        if (features.length === 0) {
            return features;
        }

        const topoSort = new TopoSort();
        features.forEach(([feature]) => {
            topoSort.depends(feature.name, feature.depends);
        });

        const groups = arrayToObject(features, ([feature]) => feature.name);
        const keys = topoSort.sort();

        const sorted = [];
        keys.forEach((key) => {
            const feature = groups[key];
            if (feature) {
                sorted.push(feature);
            } else {
                if (!this.enabled(key)) {
                    throw new InvalidConfiguration(`A prerequisite feature "${key}" is not enabled.`, this);
                }
            }
        });

        return sorted;
    }

    flushLogCache() {
        if (this.runnable &amp;&amp; !('logger' in this.config)) {
            const _makeLogger = (logLevel, channel) => ({
                log: makeLogger(consoleLogger, logLevel, channel),
                child: (arg1, arg2) => _makeLogger(arg2?.level || logLevel, arg1?.module),
            });
            this.logger = _makeLogger(this.options.logLevel);
            this.log = this._loggerLog;
            this._logCache.forEach((log) => this.logger.log(...log));
            this._logCache.length = 0;
        }
    }

    /**
     * Load features
     * @private
     * @returns {bool}
     */
    async _loadFeatures_() {
        try {
            // run config stage separately first
            let configStageFeatures = [];

            // load features
            _.each(this.config, (featureOptions, name) => {
                if (this.options.allowedFeatures &amp;&amp; this.options.allowedFeatures.indexOf(name) === -1) {
                    //skip disabled features
                    return;
                }

                if (this.options.ignoreFeatures &amp;&amp; this.options.ignoreFeatures.indexOf(name) !== -1) {
                    //ignore features, useful for worker to use the same config with server
                    return;
                }

                let feature;
                try {
                    feature = this._loadFeature(name);
                } catch (err) {
                    //ignore the first trial
                    //this.log('warn', err.message, { err });
                }

                if (feature &amp;&amp; feature.stage === Feature.CONF) {
                    configStageFeatures.push([feature, featureOptions]);
                    delete this.config[name];
                }
            });

            if (configStageFeatures.length > 0) {
                await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);

                //reload all features if any type of configuration feature exists
                return this._loadFeatures_();
            }
        } finally {
            // if no logger in config, use console logger
            this.flushLogCache();
        }

        await this.emit_('configFinalized', this.config);

        if (this.options.logConfig &amp;&amp; (this.options.logLevel === 'debug' || this.options.logLevel === 'verbose')) {
            this.log('verbose', 'Finalized config:', this.config);
        }

        let featureGroups = {
            [Feature.INIT]: [],
            [Feature.SERVICE]: [],
            [Feature.PLUGIN]: [],
            [Feature.FINAL]: [],
        };

        // load features
        _.each(this.config, (featureOptions, name) => {
            if (this.options.allowedFeatures &amp;&amp; this.options.allowedFeatures.indexOf(name) === -1) {
                //skip disabled features
                return;
            }

            let feature = this._loadFeature(name);

            if (!(feature.stage in featureGroups)) {
                throw new Error(`Invalid feature stage. Feature: ${name}, type: ${feature.stage}`);
            }

            featureGroups[feature.stage].push([feature, featureOptions]);
        });

        return eachAsync_(featureGroups, (group, stage) => this._loadFeatureGroup_(group, stage));
    }

    async _loadFeatureGroup_(featureGroup, groupStage) {
        featureGroup = this._sortFeatures(featureGroup);

        await this.emit_('before:' + groupStage);
        this.log('verbose', `Loading "${groupStage}" feature group ...`);

        await eachAsync_(featureGroup, async ([feature, options]) => {
            const { name, depends } = feature;
            await this.emit_('before:load:' + name);
            this.log('verbose', `Loading feature "${name}" ...`);

            depends &amp;&amp; this._dependsOn(depends, name);

            await feature.load_(this, options, name);
            this.features[name].enabled = true;
            this.log('verbose', `Feature "${name}" loaded. [OK]`);

            await this.emit_('after:load:' + name);
        });
        this.log('verbose', `Finished loading "${groupStage}" feature group. [OK]`);

        await this.emit_('after:' + groupStage);
    }

    _dependsOn(features, fromFeature) {
        let hasNotEnabled = _.find(_.castArray(features), (feature) => !this.enabled(feature));

        if (hasNotEnabled) {
            throw new Error(`The "${hasNotEnabled}" feature depended by "${fromFeature}" feature is not enabled.`);
        }
    }

    /**
     * Load a feature object by name.
     * @private
     * @param {string} feature
     * @returns {object}
     */
    _loadFeature(feature) {
        let featureObject = this.features[feature];
        if (featureObject) return featureObject;

        let featurePath;

        if (this._featureRegistry.hasOwnProperty(feature)) {
            //load by registry entry
            let loadOption = this._featureRegistry[feature];

            if (Array.isArray(loadOption)) {
                if (loadOption.length === 0) {
                    throw new Error(`Invalid registry value for feature "${feature}".`);
                }

                featurePath = loadOption[0];
                featureObject = this.tryRequire(featurePath);

                if (loadOption.length > 1) {
                    //one module may contains more than one feature
                    featureObject = _.get(featureObject, loadOption[1]);
                }
            } else {
                featurePath = loadOption;
                featureObject = this.tryRequire(featurePath);
            }
        } else {
            //load by fallback paths
            let searchingPath = this._featureRegistry['*'];

            //reverse fallback stack
            let found = _.findLast(searchingPath, (p) =>
                FILE_EXT.find((ext) => {
                    featurePath = path.join(p, feature + ext);
                    return fs.existsSync(featurePath);
                })
            );

            if (!found) {
                throw new InvalidConfiguration(`Don't know where to load feature "${feature}".`, this, {
                    feature,
                    searchingPath,
                });
            }

            featureObject = this.tryRequire(featurePath);
        }

        if (!Feature.validate(featureObject)) {
            throw new Error(`Invalid feature object loaded from "${featurePath}".`);
        }

        featureObject = typeof featureObject === 'function' ? featureObject(this) : featureObject;
        featureObject.name = feature;
        this.features[feature] = featureObject;
        return featureObject;
    }
}

export default ServiceContainer;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sat Dec 09 2023 11:42:03 GMT+0800 (Central Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
