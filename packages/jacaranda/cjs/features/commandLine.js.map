{"version":3,"sources":["../../src/features/commandLine.js"],"sourcesContent":["/**\n * Parse command line arguments using minimist and store the parsed object into app.argv, and add app.showUsage() helper function\n * @module Feature_CommandLine\n */\n\nimport path from 'node:path';\nimport { _, pushIntoBucket, eachAsync_ } from '@kitmi/utils';\nimport { ApplicationError, InvalidConfiguration } from '@kitmi/types';\nimport Feature from '../Feature';\n\nfunction translateMinimistOptions(opts) {\n    let m = {};\n\n    _.forOwn(opts, (detail, name) => {\n        if (detail.bool) {\n            pushIntoBucket(m, 'boolean', name);\n        } else {\n            pushIntoBucket(m, 'string', name);\n        }\n\n        if ('default' in detail) {\n            _.set(m, `default.${name}`, detail.default);\n        }\n\n        if (detail.alias) {\n            _.set(m, `alias.${name}`, detail.alias);\n        }\n    });\n\n    return m;\n}\n\nfunction optionDecorator(name) {\n    return name.length == 1 ? '-' + name : '--' + name;\n}\n\nlet gArgv = process.argv.slice(2);\n\n/**\n * Error caused by command line arguments.\n * @class\n * @extends ApplicationError\n */\nclass CommandLineArgumentError extends ApplicationError {\n    /**\n     * @param {string} message - Error message\n     * @param {string} name - The related config item\n     * @param {boolean} nonOption - Whether it is an option\n     */\n    constructor(message, name, nonOption) {\n        super(message, 'E_CLI_INVALID_ARG', { name, nonOption });\n    }\n}\n\n/**\n * Command line helper object.\n */\nclass CommandLine {\n    constructor(app, usage) {\n        this.app = app;\n        this.usage = usage;        \n\n        this.parse(usage.options);\n    }\n\n    injectUsage(injects) {\n        this.injects = injects;\n    }\n\n    parse(options) {\n        const minimist = this.app.tryRequire('minimist');\n        const minimistOpts = translateMinimistOptions(options);\n        this.argv = minimist(gArgv, minimistOpts);\n    }\n\n    option(name) {\n        return this.argv[name];\n    }\n\n    arg(name) {\n        if (this.args[name]) return this.args[name];\n\n        let index = _.findIndex(this.usage.arguments, (arg) => arg.name === name);\n\n        if (index === -1 || this.argv._.length <= index) {\n            return undefined;\n        }\n\n        this.args || (this.args = {});\n        return (this.args[name] = this.argv._[index]);\n    }\n\n    updateOption(name, value) {\n        this.argv[name] = value;\n        let opts = this.usage.options[name];\n        if (opts.alias) {\n            _.each(opts.alias, (a) => {\n                this.argv[a] = value;\n            });\n        }\n    }\n\n    async valueOrFunctionCall_(functor) {\n        if (typeof functor === 'function') {\n            return await functor(this);\n        }\n\n        return functor;\n    }\n\n    async doFilter_(name, opt, argIndex) {\n        if (opt.filter) {\n            if (typeof argIndex === 'undefined') {\n                if (!(typeof opt.filter !== 'function')) {\n                    throw new InvalidConfiguration(\n                        `The \"filter\" in the inquirer option for argument option \"${name}\" should be a function!`,\n                        this.app,\n                        `commandLine.options[${name}].filter`\n                    );\n                }\n\n                this.updateOption(name, await opt.filter(this.argv[name], this));\n            } else {\n                if (!(typeof opt.filter !== 'function')) {\n                    throw new InvalidConfiguration(\n                        `The \"filter\" in the inquirer option for argument value \"${name}\" at position ${argIndex} should be a function!`,\n                        this.app,\n                        `commandLine.arguments[${argIndex}].filter`\n                    );\n                }\n\n                this.argv._[argIndex] = await opt.filter(this.argv._[argIndex], this);\n            }\n        }\n    }\n\n    argExist(name, argIndex) {\n        return typeof argIndex === 'undefined' ? name in this.argv : this.argv._.length > argIndex;\n    }\n\n    async inquire_() {\n        const inquirer = await this.app.tryRequire_('inquirer');\n\n        const doInquire_ = (item, argIndex) =>\n            inquirer.prompt([item]).then((answers) => {\n                console.log();\n\n                _.forOwn(answers, (ans, name) => {\n                    if (typeof argIndex === 'undefined') {\n                        this.updateOption(name, ans);\n                    } else {\n                        assert: this.argv._.length === argIndex;\n\n                        this.argv._ = this.argv._.concat([ans]);\n                    }\n                });\n            });\n\n        const prepareInquire_ = async (opts, name, argIndex) => {\n            let argExists = this.argExist(name, argIndex);\n\n            if ('inquire' in opts && !argExists) {\n                //need inquire and the value not given through command line\n                let inquire = await this.valueOrFunctionCall_(opts.inquire);\n\n                if (inquire) {\n                    let type;\n                    let q = { name: name, message: opts.promptMessage || opts.desc };\n\n                    if (opts.promptType) {\n                        type = opts.promptType;\n                        if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {\n                            if (!opts.choicesProvider) {\n                                throw new InvalidConfiguration(\n                                    typeof argIndex === 'undefined'\n                                        ? `Missing \"choicesProvider\" in the inquirer option for argument option \"${name}\"!`\n                                        : `Missing \"choicesProvider\" in the inquirer option for argument value \"${name}\" at postion ${argIndex}!`,\n                                    this.app,\n                                    typeof argIndex === 'undefined'\n                                        ? `commandLine.options[${name}].choicesProvider`\n                                        : `commandLine.arguments[${argIndex}].choicesProvider`\n                                );\n                            }\n\n                            q.choices = await this.valueOrFunctionCall_(opts.choicesProvider);\n                        }\n                    } else if (opts.bool) {\n                        type = 'confirm';\n                    } else {\n                        type = 'input';\n                    }\n\n                    q.type = type;\n\n                    if ('promptDefault' in opts) {\n                        q.default = await this.valueOrFunctionCall_(opts.promptDefault);\n                    }\n\n                    await doInquire_(q, argIndex);\n                    await this.doFilter_(name, opts, argIndex);\n\n                    if (opts.afterInquire) {\n                        await opts.afterInquire(this);\n                    }\n                }\n            } else if (argExists) {\n                await this.doFilter_(name, opts, argIndex);\n                if (opts.onArgumentExists) {\n                    await opts.onArgumentExists(this);\n                }\n            }\n\n            if ((await this.valueOrFunctionCall_(this.usage.showArguments)) && this.argExist(name, argIndex)) {\n                if (typeof argIndex === 'undefined') {\n                    console.log('option', name, `(${opts.desc})`, ':', this.argv[name]);\n                } else {\n                    console.log(`<${name}>`, ':', this.argv._[argIndex]);\n                }\n            }\n        };\n\n        if (!_.isEmpty(this.usage.arguments)) {\n            await eachAsync_(this.usage.arguments, async (argOpt, index) => {\n                let { name, ...opts } = argOpt;\n\n                return prepareInquire_(opts, name, index);\n            });\n        }\n\n        return (\n            _.isEmpty(this.usage.options) || eachAsync_(this.usage.options, (opts, name) => prepareInquire_(opts, name))\n        );\n    }\n\n    /**\n     * validate parsed and filled argument options.\n     */\n    async validate_() {\n        const checkRequire_ = (opts) => this.valueOrFunctionCall_(opts.required);\n\n        let errors = [];\n\n        if (!_.isEmpty(this.usage.arguments)) {\n            let argNum = this.argv._.length;\n\n            if (argNum < this.usage.arguments.length) {\n                let args = [];\n\n                let i = 0;\n\n                await eachAsync_(this.usage.arguments, async (arg) => {\n                    let required = await checkRequire_(arg);\n\n                    if (required) {\n                        if (i >= argNum) {\n                            let msg = `Missing required argument \"${arg.name}\"!`;\n\n                            if (this.usage.showUsageOnError) {\n                                errors.push(msg);\n                            } else {\n                                throw new CommandLineArgumentError(msg, arg.name, true);\n                            }\n                        } else {\n                            args.push(this.argv._[i++]);\n                        }\n                    }\n                });\n\n                this.argv._ = args;\n            }\n        }\n\n        this.usage.options &&\n            (await eachAsync_(this.usage.options, async (opts, name) => {\n                let required = await checkRequire_(opts);\n\n                if (required && !(name in this.argv)) {\n                    let msg = `Missing required argument option of \"${name}\"!`;\n\n                    if (this.usage.showUsageOnError) {\n                        errors.push(msg);\n                    } else {\n                        throw new CommandLineArgumentError(msg, name);\n                    }\n                }\n            }));\n\n        if (errors.length > 0) {\n            this.showUsage({\n                afterBanner: () => 'Error(s):\\n' + errors.map((msg) => ' - ' + msg).join('\\n') + '\\n\\n',\n            });\n\n            process.exit(1);\n        }\n    }\n\n    async processSilentModeArguments_() {\n        await eachAsync_(this.usage.arguments, async (arg, index) => {\n            if (this.argv._.length <= index) {\n                if (arg.hasOwnProperty('silentModeDefault')) {\n                    for (let i = this.argv._.length; i < index; i++) {\n                        this.argv._.push(undefined);\n                    }\n\n                    this.argv._.push(await this.valueOrFunctionCall_(arg.silentModeDefault));\n                }\n            } else {\n                const { name, ...opts } = arg;\n                await this.doFilter_(name, opts, index);\n                if (opts.onArgumentExists) {\n                    await opts.onArgumentExists(this);\n                }\n            }\n        });\n\n        await eachAsync_(this.usage.options, async (opts, name) => {\n            if (this.argExist(name)) {\n                await this.doFilter_(name, opts);\n                if (opts.onArgumentExists) {\n                    await opts.onArgumentExists(this);\n                }\n            } else if (opts.hasOwnProperty('silentModeDefault')) {\n                this.updateOption(name, await this.valueOrFunctionCall_(opts.silentModeDefault));\n            }\n        });\n    }\n\n    getBanner() {\n        if (this.usage.banner) {\n            let banner = '';\n\n            if (typeof this.usage.banner === 'function') {\n                banner += this.usage.banner(this);\n            } else if (typeof this.usage.banner === 'string') {\n                banner += this.usage.banner;\n            } else {\n                throw new InvalidConfiguration(\n                    'Invalid banner value of commandLine feature.',\n                    this.app,\n                    `commandLine.banner`\n                );\n            }\n\n            banner += '\\n';\n\n            return banner;\n        }\n\n        return undefined;\n    }\n\n    getUsage(injects) {\n        injects = { ...this.injects, ...injects };\n\n        let usage = '';\n\n        let banner = !this.bannerShown && this.getBanner();\n        if (banner) {\n            usage += banner + '\\n';\n        }\n\n        if (injects && injects.afterBanner) {\n            usage += injects.afterBanner();\n        }\n\n        let fmtArgs = '';\n        if (!_.isEmpty(this.usage.arguments)) {\n            fmtArgs =\n                ' ' + this.usage.arguments.map((arg) => (arg.required ? `<${arg.name}>` : `[${arg.name}]`)).join(' ');\n        }\n\n        usage += `Usage: ${this.usage.program || path.basename(process.argv[1])}${fmtArgs} [options]\\n\\n`;\n\n        if (injects && injects.afterCommandLine) {\n            usage += injects.afterCommandLine();\n        }\n\n        if (!_.isEmpty(this.usage.options)) {\n            usage += `Options:\\n`;\n            _.forOwn(this.usage.options, (opts, name) => {\n                let line = '  ' + optionDecorator(name);\n                if (opts.alias) {\n                    line += _.reduce(opts.alias, (sum, a) => sum + ', ' + optionDecorator(a), '');\n                }\n\n                line += '\\n';\n                line += '    ' + opts.desc + '\\n';\n\n                if ('default' in opts) {\n                    line += '    default: ' + opts.default.toString() + '\\n';\n                }\n\n                if (opts.required) {\n                    if (typeof opts.required === 'function') {\n                        line += '    conditional\\n';\n                    } else {\n                        line += '    required\\n';\n                    }\n                }\n\n                if (opts.choicesProvider && Array.isArray(opts.choicesProvider)) {\n                    line += '    available values:\\n';\n                    opts.choicesProvider.forEach((choice) => {\n                        line += `        \"${choice.value}\": ${choice.name}\\n`;\n                    });\n                }\n\n                line += '\\n';\n\n                usage += line;\n            });\n        }\n\n        if (injects && injects.afterOptions) {\n            usage += injects.afterOptions();\n        }\n\n        return usage;\n    }\n\n    showBannar() {\n        let banner = this.getBanner();\n        if (banner) {\n            console.log(banner);\n            this.bannerShown = true;\n        }\n    }\n\n    showUsage(injects) {\n        console.log(this.getUsage(injects));\n    }\n}\n\nexport default {\n    /**\n     * This feature is loaded at initialization stage\n     * @member {string}\n     */\n    stage: Feature.INIT,\n\n    packages: ['minimist', 'inquirer'],\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} usageOptions - Options for the feature\n     * @property {string} [usageOptions.banner] - Banner message or banner generator function\n     * @property {string} [usageOptions.program] - Executable name\n     * @property {array} [usageOptions.arguments] - Command line arguments, identified by the position of appearance\n     * @property {object} [usageOptions.options] - Command line options\n     * @property {boolean|function} [usageOptions.silentMode] - Whether to run in silient mode, default false\n     * @property {boolean|function} [usageOptions.nonValidationMode] - Whether to run validation\n     * @property {boolean} [usageOptions.showUsageOnError]\n     *\n     * @example\n     *   options: { [argumentKey]: {\n     *      desc, // {string} - description\n     *      alias, // {array.<string>} - alias array\n     *      bool, // {boolean} - whether it is a boolean value\n     *      default, // {*} - default value\n     *      inquire, // {boolean | function(cli).<boolean>} - whether to enable interactive query\n     *      promptMessage, // {string} - prompt message for query, will use desc if not set\n     *      promptType, // {string} - prompt type, can be one of [ input, number, confirm, list, rawlist, expand, checkbox, password, editor ]\n     *      promptDefault, // {* | function(cli).<*>} - default value appeared on query or a async function to return the default value\n     *      choicesProvider, // {array | function(cli).<array> | function.<function(string).<array>>} - required for prompt type list, rawlist, expand, checkbox\n     *      filter, // {function(argv, cli).<argv>} - filter to process the argument value\n     *      afterInquire, // {function} - after inquire hook,\n     *      onArgumentExists, // {function} - when argument exists,\n     *      silentModeDefault // {*} - default value when run in silient mode,\n     *   } }\n     *\n     * @returns {Promise.<*>}\n     */\n    load_: async (app, options, name) => {\n        const { testArgs, ...usageOptions } = app.featureConfig(options, {\n            schema: {\n                testArgs: { type: 'array', optional: true },\n            },\n            keepUnsanitized: true,\n        }, name);\n\n        if (testArgs) {\n            gArgv = testArgs;\n        }\n\n        app.commandLine = new CommandLine(app, usageOptions);\n\n        let silentMode = usageOptions.silentMode;\n\n        if (silentMode && typeof silentMode === 'function') {\n            silentMode = silentMode(app.commandLine);\n        }\n\n        app.commandLine.silentMode = silentMode;\n\n        if (silentMode) {\n            await app.commandLine.processSilentModeArguments_();\n        } else {            \n            app.commandLine.showBannar();\n            await app.commandLine.inquire_();\n        }\n\n        let nonValidationMode = usageOptions.nonValidationMode;\n\n        if (nonValidationMode && typeof nonValidationMode === 'function') {\n            nonValidationMode = nonValidationMode(app.commandLine);\n        }\n\n        app.commandLine.nonValidationMode = nonValidationMode;\n\n        if (!nonValidationMode) {\n            await app.commandLine.validate_();\n        }\n    },\n};\n"],"names":["translateMinimistOptions","opts","m","_","forOwn","detail","name","bool","pushIntoBucket","set","default","alias","optionDecorator","length","gArgv","process","argv","slice","CommandLineArgumentError","ApplicationError","constructor","message","nonOption","CommandLine","injectUsage","injects","parse","options","minimist","app","tryRequire","minimistOpts","option","arg","args","index","findIndex","usage","arguments","undefined","updateOption","value","each","a","valueOrFunctionCall_","functor","doFilter_","opt","argIndex","filter","InvalidConfiguration","argExist","inquire_","inquirer","tryRequire_","doInquire_","item","prompt","then","answers","console","log","ans","assert","concat","prepareInquire_","argExists","inquire","type","q","promptMessage","desc","promptType","choicesProvider","choices","promptDefault","afterInquire","onArgumentExists","showArguments","isEmpty","eachAsync_","argOpt","validate_","checkRequire_","required","errors","argNum","i","msg","showUsageOnError","push","showUsage","afterBanner","map","join","exit","processSilentModeArguments_","hasOwnProperty","silentModeDefault","getBanner","banner","getUsage","bannerShown","fmtArgs","program","path","basename","afterCommandLine","line","reduce","sum","toString","Array","isArray","forEach","choice","afterOptions","showBannar","stage","Feature","INIT","packages","load_","testArgs","usageOptions","featureConfig","schema","optional","keepUnsanitized","commandLine","silentMode","nonValidationMode"],"mappings":"AAAA;;;CAGC;;;;+BA8aD;;;eAAA;;;iEA5aiB;uBAC6B;uBACS;gEACnC;;;;;;AAEpB,SAASA,yBAAyBC,IAAI;IAClC,IAAIC,IAAI,CAAC;IAETC,QAAC,CAACC,MAAM,CAACH,MAAM,CAACI,QAAQC;QACpB,IAAID,OAAOE,IAAI,EAAE;YACbC,IAAAA,qBAAc,EAACN,GAAG,WAAWI;QACjC,OAAO;YACHE,IAAAA,qBAAc,EAACN,GAAG,UAAUI;QAChC;QAEA,IAAI,aAAaD,QAAQ;YACrBF,QAAC,CAACM,GAAG,CAACP,GAAG,CAAC,QAAQ,EAAEI,KAAK,CAAC,EAAED,OAAOK,OAAO;QAC9C;QAEA,IAAIL,OAAOM,KAAK,EAAE;YACdR,QAAC,CAACM,GAAG,CAACP,GAAG,CAAC,MAAM,EAAEI,KAAK,CAAC,EAAED,OAAOM,KAAK;QAC1C;IACJ;IAEA,OAAOT;AACX;AAEA,SAASU,gBAAgBN,IAAI;IACzB,OAAOA,KAAKO,MAAM,IAAI,IAAI,MAAMP,OAAO,OAAOA;AAClD;AAEA,IAAIQ,QAAQC,QAAQC,IAAI,CAACC,KAAK,CAAC;AAE/B;;;;CAIC,GACD,MAAMC,iCAAiCC,uBAAgB;IACnD;;;;KAIC,GACDC,YAAYC,OAAO,EAAEf,IAAI,EAAEgB,SAAS,CAAE;QAClC,KAAK,CAACD,SAAS,qBAAqB;YAAEf;YAAMgB;QAAU;IAC1D;AACJ;AAEA;;CAEC,GACD,MAAMC;IAQFC,YAAYC,OAAO,EAAE;QACjB,IAAI,CAACA,OAAO,GAAGA;IACnB;IAEAC,MAAMC,OAAO,EAAE;QACX,MAAMC,WAAW,IAAI,CAACC,GAAG,CAACC,UAAU,CAAC;QACrC,MAAMC,eAAe/B,yBAAyB2B;QAC9C,IAAI,CAACX,IAAI,GAAGY,SAASd,OAAOiB;IAChC;IAEAC,OAAO1B,IAAI,EAAE;QACT,OAAO,IAAI,CAACU,IAAI,CAACV,KAAK;IAC1B;IAEA2B,IAAI3B,IAAI,EAAE;QACN,IAAI,IAAI,CAAC4B,IAAI,CAAC5B,KAAK,EAAE,OAAO,IAAI,CAAC4B,IAAI,CAAC5B,KAAK;QAE3C,IAAI6B,QAAQhC,QAAC,CAACiC,SAAS,CAAC,IAAI,CAACC,KAAK,CAACC,SAAS,EAAE,CAACL,MAAQA,IAAI3B,IAAI,KAAKA;QAEpE,IAAI6B,UAAU,CAAC,KAAK,IAAI,CAACnB,IAAI,CAACb,CAAC,CAACU,MAAM,IAAIsB,OAAO;YAC7C,OAAOI;QACX;QAEA,IAAI,CAACL,IAAI,IAAK,CAAA,IAAI,CAACA,IAAI,GAAG,CAAC,CAAA;QAC3B,OAAQ,IAAI,CAACA,IAAI,CAAC5B,KAAK,GAAG,IAAI,CAACU,IAAI,CAACb,CAAC,CAACgC,MAAM;IAChD;IAEAK,aAAalC,IAAI,EAAEmC,KAAK,EAAE;QACtB,IAAI,CAACzB,IAAI,CAACV,KAAK,GAAGmC;QAClB,IAAIxC,OAAO,IAAI,CAACoC,KAAK,CAACV,OAAO,CAACrB,KAAK;QACnC,IAAIL,KAAKU,KAAK,EAAE;YACZR,QAAC,CAACuC,IAAI,CAACzC,KAAKU,KAAK,EAAE,CAACgC;gBAChB,IAAI,CAAC3B,IAAI,CAAC2B,EAAE,GAAGF;YACnB;QACJ;IACJ;IAEA,MAAMG,qBAAqBC,OAAO,EAAE;QAChC,IAAI,OAAOA,YAAY,YAAY;YAC/B,OAAO,MAAMA,QAAQ,IAAI;QAC7B;QAEA,OAAOA;IACX;IAEA,MAAMC,UAAUxC,IAAI,EAAEyC,GAAG,EAAEC,QAAQ,EAAE;QACjC,IAAID,IAAIE,MAAM,EAAE;YACZ,IAAI,OAAOD,aAAa,aAAa;gBACjC,IAAI,CAAE,CAAA,OAAOD,IAAIE,MAAM,KAAK,UAAS,GAAI;oBACrC,MAAM,IAAIC,2BAAoB,CAC1B,CAAC,yDAAyD,EAAE5C,KAAK,uBAAuB,CAAC,EACzF,IAAI,CAACuB,GAAG,EACR,CAAC,oBAAoB,EAAEvB,KAAK,QAAQ,CAAC;gBAE7C;gBAEA,IAAI,CAACkC,YAAY,CAAClC,MAAM,MAAMyC,IAAIE,MAAM,CAAC,IAAI,CAACjC,IAAI,CAACV,KAAK,EAAE,IAAI;YAClE,OAAO;gBACH,IAAI,CAAE,CAAA,OAAOyC,IAAIE,MAAM,KAAK,UAAS,GAAI;oBACrC,MAAM,IAAIC,2BAAoB,CAC1B,CAAC,wDAAwD,EAAE5C,KAAK,cAAc,EAAE0C,SAAS,sBAAsB,CAAC,EAChH,IAAI,CAACnB,GAAG,EACR,CAAC,sBAAsB,EAAEmB,SAAS,QAAQ,CAAC;gBAEnD;gBAEA,IAAI,CAAChC,IAAI,CAACb,CAAC,CAAC6C,SAAS,GAAG,MAAMD,IAAIE,MAAM,CAAC,IAAI,CAACjC,IAAI,CAACb,CAAC,CAAC6C,SAAS,EAAE,IAAI;YACxE;QACJ;IACJ;IAEAG,SAAS7C,IAAI,EAAE0C,QAAQ,EAAE;QACrB,OAAO,OAAOA,aAAa,cAAc1C,QAAQ,IAAI,CAACU,IAAI,GAAG,IAAI,CAACA,IAAI,CAACb,CAAC,CAACU,MAAM,GAAGmC;IACtF;IAEA,MAAMI,WAAW;QACb,MAAMC,WAAW,MAAM,IAAI,CAACxB,GAAG,CAACyB,WAAW,CAAC;QAE5C,MAAMC,aAAa,CAACC,MAAMR,WACtBK,SAASI,MAAM,CAAC;gBAACD;aAAK,EAAEE,IAAI,CAAC,CAACC;gBAC1BC,QAAQC,GAAG;gBAEX1D,QAAC,CAACC,MAAM,CAACuD,SAAS,CAACG,KAAKxD;oBACpB,IAAI,OAAO0C,aAAa,aAAa;wBACjC,IAAI,CAACR,YAAY,CAAClC,MAAMwD;oBAC5B,OAAO;wBACHC,QAAQ,IAAI,CAAC/C,IAAI,CAACb,CAAC,CAACU,MAAM,KAAKmC;wBAE/B,IAAI,CAAChC,IAAI,CAACb,CAAC,GAAG,IAAI,CAACa,IAAI,CAACb,CAAC,CAAC6D,MAAM,CAAC;4BAACF;yBAAI;oBAC1C;gBACJ;YACJ;QAEJ,MAAMG,kBAAkB,OAAOhE,MAAMK,MAAM0C;YACvC,IAAIkB,YAAY,IAAI,CAACf,QAAQ,CAAC7C,MAAM0C;YAEpC,IAAI,aAAa/C,QAAQ,CAACiE,WAAW;gBACjC,2DAA2D;gBAC3D,IAAIC,UAAU,MAAM,IAAI,CAACvB,oBAAoB,CAAC3C,KAAKkE,OAAO;gBAE1D,IAAIA,SAAS;oBACT,IAAIC;oBACJ,IAAIC,IAAI;wBAAE/D,MAAMA;wBAAMe,SAASpB,KAAKqE,aAAa,IAAIrE,KAAKsE,IAAI;oBAAC;oBAE/D,IAAItE,KAAKuE,UAAU,EAAE;wBACjBJ,OAAOnE,KAAKuE,UAAU;wBACtB,IAAIJ,SAAS,UAAUA,SAAS,aAAaA,SAAS,cAAcA,SAAS,UAAU;4BACnF,IAAI,CAACnE,KAAKwE,eAAe,EAAE;gCACvB,MAAM,IAAIvB,2BAAoB,CAC1B,OAAOF,aAAa,cACd,CAAC,sEAAsE,EAAE1C,KAAK,EAAE,CAAC,GACjF,CAAC,qEAAqE,EAAEA,KAAK,aAAa,EAAE0C,SAAS,CAAC,CAAC,EAC7G,IAAI,CAACnB,GAAG,EACR,OAAOmB,aAAa,cACd,CAAC,oBAAoB,EAAE1C,KAAK,iBAAiB,CAAC,GAC9C,CAAC,sBAAsB,EAAE0C,SAAS,iBAAiB,CAAC;4BAElE;4BAEAqB,EAAEK,OAAO,GAAG,MAAM,IAAI,CAAC9B,oBAAoB,CAAC3C,KAAKwE,eAAe;wBACpE;oBACJ,OAAO,IAAIxE,KAAKM,IAAI,EAAE;wBAClB6D,OAAO;oBACX,OAAO;wBACHA,OAAO;oBACX;oBAEAC,EAAED,IAAI,GAAGA;oBAET,IAAI,mBAAmBnE,MAAM;wBACzBoE,EAAE3D,OAAO,GAAG,MAAM,IAAI,CAACkC,oBAAoB,CAAC3C,KAAK0E,aAAa;oBAClE;oBAEA,MAAMpB,WAAWc,GAAGrB;oBACpB,MAAM,IAAI,CAACF,SAAS,CAACxC,MAAML,MAAM+C;oBAEjC,IAAI/C,KAAK2E,YAAY,EAAE;wBACnB,MAAM3E,KAAK2E,YAAY,CAAC,IAAI;oBAChC;gBACJ;YACJ,OAAO,IAAIV,WAAW;gBAClB,MAAM,IAAI,CAACpB,SAAS,CAACxC,MAAML,MAAM+C;gBACjC,IAAI/C,KAAK4E,gBAAgB,EAAE;oBACvB,MAAM5E,KAAK4E,gBAAgB,CAAC,IAAI;gBACpC;YACJ;YAEA,IAAI,AAAC,MAAM,IAAI,CAACjC,oBAAoB,CAAC,IAAI,CAACP,KAAK,CAACyC,aAAa,KAAM,IAAI,CAAC3B,QAAQ,CAAC7C,MAAM0C,WAAW;gBAC9F,IAAI,OAAOA,aAAa,aAAa;oBACjCY,QAAQC,GAAG,CAAC,UAAUvD,MAAM,CAAC,CAAC,EAAEL,KAAKsE,IAAI,CAAC,CAAC,CAAC,EAAE,KAAK,IAAI,CAACvD,IAAI,CAACV,KAAK;gBACtE,OAAO;oBACHsD,QAAQC,GAAG,CAAC,CAAC,CAAC,EAAEvD,KAAK,CAAC,CAAC,EAAE,KAAK,IAAI,CAACU,IAAI,CAACb,CAAC,CAAC6C,SAAS;gBACvD;YACJ;QACJ;QAEA,IAAI,CAAC7C,QAAC,CAAC4E,OAAO,CAAC,IAAI,CAAC1C,KAAK,CAACC,SAAS,GAAG;YAClC,MAAM0C,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACC,SAAS,EAAE,OAAO2C,QAAQ9C;gBAClD,IAAI,EAAE7B,IAAI,EAAE,GAAGL,MAAM,GAAGgF;gBAExB,OAAOhB,gBAAgBhE,MAAMK,MAAM6B;YACvC;QACJ;QAEA,OACIhC,QAAC,CAAC4E,OAAO,CAAC,IAAI,CAAC1C,KAAK,CAACV,OAAO,KAAKqD,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACV,OAAO,EAAE,CAAC1B,MAAMK,OAAS2D,gBAAgBhE,MAAMK;IAE9G;IAEA;;KAEC,GACD,MAAM4E,YAAY;QACd,MAAMC,gBAAgB,CAAClF,OAAS,IAAI,CAAC2C,oBAAoB,CAAC3C,KAAKmF,QAAQ;QAEvE,IAAIC,SAAS,EAAE;QAEf,IAAI,CAAClF,QAAC,CAAC4E,OAAO,CAAC,IAAI,CAAC1C,KAAK,CAACC,SAAS,GAAG;YAClC,IAAIgD,SAAS,IAAI,CAACtE,IAAI,CAACb,CAAC,CAACU,MAAM;YAE/B,IAAIyE,SAAS,IAAI,CAACjD,KAAK,CAACC,SAAS,CAACzB,MAAM,EAAE;gBACtC,IAAIqB,OAAO,EAAE;gBAEb,IAAIqD,IAAI;gBAER,MAAMP,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACC,SAAS,EAAE,OAAOL;oBAC1C,IAAImD,WAAW,MAAMD,cAAclD;oBAEnC,IAAImD,UAAU;wBACV,IAAIG,KAAKD,QAAQ;4BACb,IAAIE,MAAM,CAAC,2BAA2B,EAAEvD,IAAI3B,IAAI,CAAC,EAAE,CAAC;4BAEpD,IAAI,IAAI,CAAC+B,KAAK,CAACoD,gBAAgB,EAAE;gCAC7BJ,OAAOK,IAAI,CAACF;4BAChB,OAAO;gCACH,MAAM,IAAItE,yBAAyBsE,KAAKvD,IAAI3B,IAAI,EAAE;4BACtD;wBACJ,OAAO;4BACH4B,KAAKwD,IAAI,CAAC,IAAI,CAAC1E,IAAI,CAACb,CAAC,CAACoF,IAAI;wBAC9B;oBACJ;gBACJ;gBAEA,IAAI,CAACvE,IAAI,CAACb,CAAC,GAAG+B;YAClB;QACJ;QAEA,IAAI,CAACG,KAAK,CAACV,OAAO,IACb,MAAMqD,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACV,OAAO,EAAE,OAAO1B,MAAMK;YAC/C,IAAI8E,WAAW,MAAMD,cAAclF;YAEnC,IAAImF,YAAY,CAAE9E,CAAAA,QAAQ,IAAI,CAACU,IAAI,AAAD,GAAI;gBAClC,IAAIwE,MAAM,CAAC,qCAAqC,EAAElF,KAAK,EAAE,CAAC;gBAE1D,IAAI,IAAI,CAAC+B,KAAK,CAACoD,gBAAgB,EAAE;oBAC7BJ,OAAOK,IAAI,CAACF;gBAChB,OAAO;oBACH,MAAM,IAAItE,yBAAyBsE,KAAKlF;gBAC5C;YACJ;QACJ;QAEJ,IAAI+E,OAAOxE,MAAM,GAAG,GAAG;YACnB,IAAI,CAAC8E,SAAS,CAAC;gBACXC,aAAa,IAAM,gBAAgBP,OAAOQ,GAAG,CAAC,CAACL,MAAQ,QAAQA,KAAKM,IAAI,CAAC,QAAQ;YACrF;YAEA/E,QAAQgF,IAAI,CAAC;QACjB;IACJ;IAEA,MAAMC,8BAA8B;QAChC,MAAMhB,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACC,SAAS,EAAE,OAAOL,KAAKE;YAC/C,IAAI,IAAI,CAACnB,IAAI,CAACb,CAAC,CAACU,MAAM,IAAIsB,OAAO;gBAC7B,IAAIF,IAAIgE,cAAc,CAAC,sBAAsB;oBACzC,IAAK,IAAIV,IAAI,IAAI,CAACvE,IAAI,CAACb,CAAC,CAACU,MAAM,EAAE0E,IAAIpD,OAAOoD,IAAK;wBAC7C,IAAI,CAACvE,IAAI,CAACb,CAAC,CAACuF,IAAI,CAACnD;oBACrB;oBAEA,IAAI,CAACvB,IAAI,CAACb,CAAC,CAACuF,IAAI,CAAC,MAAM,IAAI,CAAC9C,oBAAoB,CAACX,IAAIiE,iBAAiB;gBAC1E;YACJ,OAAO;gBACH,MAAM,EAAE5F,IAAI,EAAE,GAAGL,MAAM,GAAGgC;gBAC1B,MAAM,IAAI,CAACa,SAAS,CAACxC,MAAML,MAAMkC;gBACjC,IAAIlC,KAAK4E,gBAAgB,EAAE;oBACvB,MAAM5E,KAAK4E,gBAAgB,CAAC,IAAI;gBACpC;YACJ;QACJ;QAEA,MAAMG,IAAAA,iBAAU,EAAC,IAAI,CAAC3C,KAAK,CAACV,OAAO,EAAE,OAAO1B,MAAMK;YAC9C,IAAI,IAAI,CAAC6C,QAAQ,CAAC7C,OAAO;gBACrB,MAAM,IAAI,CAACwC,SAAS,CAACxC,MAAML;gBAC3B,IAAIA,KAAK4E,gBAAgB,EAAE;oBACvB,MAAM5E,KAAK4E,gBAAgB,CAAC,IAAI;gBACpC;YACJ,OAAO,IAAI5E,KAAKgG,cAAc,CAAC,sBAAsB;gBACjD,IAAI,CAACzD,YAAY,CAAClC,MAAM,MAAM,IAAI,CAACsC,oBAAoB,CAAC3C,KAAKiG,iBAAiB;YAClF;QACJ;IACJ;IAEAC,YAAY;QACR,IAAI,IAAI,CAAC9D,KAAK,CAAC+D,MAAM,EAAE;YACnB,IAAIA,SAAS;YAEb,IAAI,OAAO,IAAI,CAAC/D,KAAK,CAAC+D,MAAM,KAAK,YAAY;gBACzCA,UAAU,IAAI,CAAC/D,KAAK,CAAC+D,MAAM,CAAC,IAAI;YACpC,OAAO,IAAI,OAAO,IAAI,CAAC/D,KAAK,CAAC+D,MAAM,KAAK,UAAU;gBAC9CA,UAAU,IAAI,CAAC/D,KAAK,CAAC+D,MAAM;YAC/B,OAAO;gBACH,MAAM,IAAIlD,2BAAoB,CAC1B,gDACA,IAAI,CAACrB,GAAG,EACR,CAAC,kBAAkB,CAAC;YAE5B;YAEAuE,UAAU;YAEV,OAAOA;QACX;QAEA,OAAO7D;IACX;IAEA8D,SAAS5E,OAAO,EAAE;QACdA,UAAU;YAAE,GAAG,IAAI,CAACA,OAAO;YAAE,GAAGA,OAAO;QAAC;QAExC,IAAIY,QAAQ;QAEZ,IAAI+D,SAAS,CAAC,IAAI,CAACE,WAAW,IAAI,IAAI,CAACH,SAAS;QAChD,IAAIC,QAAQ;YACR/D,SAAS+D,SAAS;QACtB;QAEA,IAAI3E,WAAWA,QAAQmE,WAAW,EAAE;YAChCvD,SAASZ,QAAQmE,WAAW;QAChC;QAEA,IAAIW,UAAU;QACd,IAAI,CAACpG,QAAC,CAAC4E,OAAO,CAAC,IAAI,CAAC1C,KAAK,CAACC,SAAS,GAAG;YAClCiE,UACI,MAAM,IAAI,CAAClE,KAAK,CAACC,SAAS,CAACuD,GAAG,CAAC,CAAC5D,MAASA,IAAImD,QAAQ,GAAG,CAAC,CAAC,EAAEnD,IAAI3B,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE2B,IAAI3B,IAAI,CAAC,CAAC,CAAC,EAAGwF,IAAI,CAAC;QACzG;QAEAzD,SAAS,CAAC,OAAO,EAAE,IAAI,CAACA,KAAK,CAACmE,OAAO,IAAIC,iBAAI,CAACC,QAAQ,CAAC3F,QAAQC,IAAI,CAAC,EAAE,EAAE,EAAEuF,QAAQ,cAAc,CAAC;QAEjG,IAAI9E,WAAWA,QAAQkF,gBAAgB,EAAE;YACrCtE,SAASZ,QAAQkF,gBAAgB;QACrC;QAEA,IAAI,CAACxG,QAAC,CAAC4E,OAAO,CAAC,IAAI,CAAC1C,KAAK,CAACV,OAAO,GAAG;YAChCU,SAAS,CAAC,UAAU,CAAC;YACrBlC,QAAC,CAACC,MAAM,CAAC,IAAI,CAACiC,KAAK,CAACV,OAAO,EAAE,CAAC1B,MAAMK;gBAChC,IAAIsG,OAAO,OAAOhG,gBAAgBN;gBAClC,IAAIL,KAAKU,KAAK,EAAE;oBACZiG,QAAQzG,QAAC,CAAC0G,MAAM,CAAC5G,KAAKU,KAAK,EAAE,CAACmG,KAAKnE,IAAMmE,MAAM,OAAOlG,gBAAgB+B,IAAI;gBAC9E;gBAEAiE,QAAQ;gBACRA,QAAQ,SAAS3G,KAAKsE,IAAI,GAAG;gBAE7B,IAAI,aAAatE,MAAM;oBACnB2G,QAAQ,kBAAkB3G,KAAKS,OAAO,CAACqG,QAAQ,KAAK;gBACxD;gBAEA,IAAI9G,KAAKmF,QAAQ,EAAE;oBACf,IAAI,OAAOnF,KAAKmF,QAAQ,KAAK,YAAY;wBACrCwB,QAAQ;oBACZ,OAAO;wBACHA,QAAQ;oBACZ;gBACJ;gBAEA,IAAI3G,KAAKwE,eAAe,IAAIuC,MAAMC,OAAO,CAAChH,KAAKwE,eAAe,GAAG;oBAC7DmC,QAAQ;oBACR3G,KAAKwE,eAAe,CAACyC,OAAO,CAAC,CAACC;wBAC1BP,QAAQ,CAAC,SAAS,EAAEO,OAAO1E,KAAK,CAAC,GAAG,EAAE0E,OAAO7G,IAAI,CAAC,EAAE,CAAC;oBACzD;gBACJ;gBAEAsG,QAAQ;gBAERvE,SAASuE;YACb;QACJ;QAEA,IAAInF,WAAWA,QAAQ2F,YAAY,EAAE;YACjC/E,SAASZ,QAAQ2F,YAAY;QACjC;QAEA,OAAO/E;IACX;IAEAgF,aAAa;QACT,IAAIjB,SAAS,IAAI,CAACD,SAAS;QAC3B,IAAIC,QAAQ;YACRxC,QAAQC,GAAG,CAACuC;YACZ,IAAI,CAACE,WAAW,GAAG;QACvB;IACJ;IAEAX,UAAUlE,OAAO,EAAE;QACfmC,QAAQC,GAAG,CAAC,IAAI,CAACwC,QAAQ,CAAC5E;IAC9B;IApXAL,YAAYS,GAAG,EAAEQ,KAAK,CAAE;QACpB,IAAI,CAACR,GAAG,GAAGA;QACX,IAAI,CAACQ,KAAK,GAAGA;QAEb,IAAI,CAACX,KAAK,CAACW,MAAMV,OAAO;IAC5B;AAgXJ;MAEA,WAAe;IACX;;;KAGC,GACD2F,OAAOC,gBAAO,CAACC,IAAI;IAEnBC,UAAU;QAAC;QAAY;KAAW;IAElC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KA8BC,GACDC,OAAO,OAAO7F,KAAKF,SAASrB;QACxB,MAAM,EAAEqH,QAAQ,EAAE,GAAGC,cAAc,GAAG/F,IAAIgG,aAAa,CAAClG,SAAS;YAC7DmG,QAAQ;gBACJH,UAAU;oBAAEvD,MAAM;oBAAS2D,UAAU;gBAAK;YAC9C;YACAC,iBAAiB;QACrB,GAAG1H;QAEH,IAAIqH,UAAU;YACV7G,QAAQ6G;QACZ;QAEA9F,IAAIoG,WAAW,GAAG,IAAI1G,YAAYM,KAAK+F;QAEvC,IAAIM,aAAaN,aAAaM,UAAU;QAExC,IAAIA,cAAc,OAAOA,eAAe,YAAY;YAChDA,aAAaA,WAAWrG,IAAIoG,WAAW;QAC3C;QAEApG,IAAIoG,WAAW,CAACC,UAAU,GAAGA;QAE7B,IAAIA,YAAY;YACZ,MAAMrG,IAAIoG,WAAW,CAACjC,2BAA2B;QACrD,OAAO;YACHnE,IAAIoG,WAAW,CAACZ,UAAU;YAC1B,MAAMxF,IAAIoG,WAAW,CAAC7E,QAAQ;QAClC;QAEA,IAAI+E,oBAAoBP,aAAaO,iBAAiB;QAEtD,IAAIA,qBAAqB,OAAOA,sBAAsB,YAAY;YAC9DA,oBAAoBA,kBAAkBtG,IAAIoG,WAAW;QACzD;QAEApG,IAAIoG,WAAW,CAACE,iBAAiB,GAAGA;QAEpC,IAAI,CAACA,mBAAmB;YACpB,MAAMtG,IAAIoG,WAAW,CAAC/C,SAAS;QACnC;IACJ;AACJ"}