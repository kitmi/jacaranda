{"version":3,"sources":["../../src/features/logger.js"],"sourcesContent":["/**\n * Enable multi-categories logging by pino logger\n * @module Feature_Logger\n */\n\nimport { _ } from '@kitmi/utils';\nimport Feature from '../Feature';\n\n/*\n logger: {\n     transport: {\n        target: '/absolute/path/to/my-transport.mjs'\n     }\n }\n\n logger: {\n    transport: {\n    targets: [\n      { target: '/absolute/path/to/my-transport.mjs', level: 'error' },\n      { target: 'some-file-transport', options: { destination: '/dev/null' }\n    ]\n }    \n*/\nexport default {\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    stage: Feature.SERVICE,\n\n    groupable: true,\n\n    packages: ['pino', 'pino-pretty'],\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} categories - Configuration for multi-categories\n     * @returns {Promise.<*>}\n     * @example\n     *\n     *  let logger = app.getService('logger');\n     *  logger.log('error', 'error');\n     *\n     *  // with serviceGroup\n     *  let logger1 = app.getService('logger-category1');\n     */\n    load_: function (app, config, name) {\n        const pino = app.tryRequire('pino');\n\n        config = app.featureConfig(\n            config ?? {},\n            {\n                schema: {\n                    transport: { type: 'object', optional: true },\n                },\n            },\n            name\n        );\n\n        const options = {\n            nestedKey: 'payload',\n            transport: {\n                target: 'pino-pretty',\n                options: {\n                    colorize: true,\n                },\n            },\n            ...config,\n        };\n\n        const names = name.split('.', 2);\n        let isAppLogger = true;\n\n        if (names.length > 1) {\n            options.name = names[1];\n            isAppLogger = false;\n        }\n\n        const logger = pino({\n            level: app.options.logLevel === 'verbose' ? 'debug' : app.options.logLevel,\n            ...options,\n        });\n\n        logger.verbose = logger.debug.bind(logger);\n        logger.log = (level, message, info) => logger[level](info, message);\n\n        if (isAppLogger) {\n            if (app._logCache.length > 0) {\n                app._logCache.forEach(([level, message, obj]) => logger[level](obj, message));\n                app._logCache.length = 0;\n            }\n\n            const makeLogger = (logger) => ({\n                log: (level, message, info) => logger[level](info, message),\n                child: (arg1, arg2) => {\n                    const _logger = logger.child(\n                        arg1,\n                        arg2?.level ? { ...arg2, level: arg2.level === 'verbose' ? 'debug' : arg2.level } : arg2\n                    );\n                    _logger.verbose = _logger.debug.bind(_logger);\n                    return makeLogger(_logger);\n                },\n            });\n\n            app.logger = makeLogger(logger);\n            app.log = app._loggerLog;\n        } \n\n        app.registerService(name, logger);\n    },\n};\n"],"names":["stage","Feature","SERVICE","groupable","packages","load_","app","config","name","pino","tryRequire","featureConfig","schema","transport","type","optional","options","nestedKey","target","colorize","names","split","isAppLogger","length","logger","level","logLevel","verbose","debug","bind","log","message","info","_logCache","forEach","obj","makeLogger","child","arg1","arg2","_logger","_loggerLog","registerService"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA;;;CAGC;;;;+BAKD;;;;;;;;;;;;;;AAcA,GACA;;;eAAA;;;uBAlBkB;gEACE;;;;;;MAiBpB,WAAe;IACX;;;KAGC,GACDA,OAAOC,gBAAO,CAACC,OAAO;IAEtBC,WAAW;IAEXC,UAAU;QAAC;QAAQ;KAAc;IAEjC;;;;;;;;;;;;KAYC,GACDC,OAAO,SAAUC,GAAG,EAAEC,MAAM,EAAEC,IAAI;QAC9B,MAAMC,OAAOH,IAAII,UAAU,CAAC;QAE5BH,SAASD,IAAIK,aAAa,CACtBJ,UAAU,CAAC,GACX;YACIK,QAAQ;gBACJC,WAAW;oBAAEC,MAAM;oBAAUC,UAAU;gBAAK;YAChD;QACJ,GACAP;QAGJ,MAAMQ,UAAU;YACZC,WAAW;YACXJ,WAAW;gBACPK,QAAQ;gBACRF,SAAS;oBACLG,UAAU;gBACd;YACJ;YACA,GAAGZ,MAAM;QACb;QAEA,MAAMa,QAAQZ,KAAKa,KAAK,CAAC,KAAK;QAC9B,IAAIC,cAAc;QAElB,IAAIF,MAAMG,MAAM,GAAG,GAAG;YAClBP,QAAQR,IAAI,GAAGY,KAAK,CAAC,EAAE;YACvBE,cAAc;QAClB;QAEA,MAAME,SAASf,KAAK;YAChBgB,OAAOnB,IAAIU,OAAO,CAACU,QAAQ,KAAK,YAAY,UAAUpB,IAAIU,OAAO,CAACU,QAAQ;YAC1E,GAAGV,OAAO;QACd;QAEAQ,OAAOG,OAAO,GAAGH,OAAOI,KAAK,CAACC,IAAI,CAACL;QACnCA,OAAOM,GAAG,GAAG,CAACL,OAAOM,SAASC,OAASR,MAAM,CAACC,MAAM,CAACO,MAAMD;QAE3D,IAAIT,aAAa;YACb,IAAIhB,IAAI2B,SAAS,CAACV,MAAM,GAAG,GAAG;gBAC1BjB,IAAI2B,SAAS,CAACC,OAAO,CAAC,CAAC,CAACT,OAAOM,SAASI,IAAI,GAAKX,MAAM,CAACC,MAAM,CAACU,KAAKJ;gBACpEzB,IAAI2B,SAAS,CAACV,MAAM,GAAG;YAC3B;YAEA,MAAMa,aAAa,CAACZ,SAAY,CAAA;oBAC5BM,KAAK,CAACL,OAAOM,SAASC,OAASR,MAAM,CAACC,MAAM,CAACO,MAAMD;oBACnDM,OAAO,CAACC,MAAMC;wBACV,MAAMC,UAAUhB,OAAOa,KAAK,CACxBC,MACAC,MAAMd,QAAQ;4BAAE,GAAGc,IAAI;4BAAEd,OAAOc,KAAKd,KAAK,KAAK,YAAY,UAAUc,KAAKd,KAAK;wBAAC,IAAIc;wBAExFC,QAAQb,OAAO,GAAGa,QAAQZ,KAAK,CAACC,IAAI,CAACW;wBACrC,OAAOJ,WAAWI;oBACtB;gBACJ,CAAA;YAEAlC,IAAIkB,MAAM,GAAGY,WAAWZ;YACxBlB,IAAIwB,GAAG,GAAGxB,IAAImC,UAAU;QAC5B;QAEAnC,IAAIoC,eAAe,CAAClC,MAAMgB;IAC9B;AACJ"}