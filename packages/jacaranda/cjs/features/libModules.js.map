{"version":3,"sources":["../../src/features/libModules.js"],"sourcesContent":["/**\n * Load lib modules\n * @module Feature_LibModules\n *\n * @example\n *\n *  'libModules': {\n *      '<name>': {\n *          npmModule: false, // whether is a npm module\n *          options: { // module options\n *          },\n *          settings: { // can override module defined settings\n *          }\n *      }\n *  }\n */\n\nimport path from 'node:path';\nimport { _, batchAsync_ } from '@kitmi/utils';\nimport { fs, isDir_ } from '@kitmi/sys';\nimport { InvalidConfiguration } from '@kitmi/types';\nimport Feature from '../Feature';\nimport LibModule from '../LibModule';\n\nexport default {\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    stage: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {App} app - The app module object.\n     * @param {object} entries - Lib module entries.\n     * @returns {Promise.<*>}\n     */\n    load_: async (app, entries) => {\n        return batchAsync_(entries, async (config, name) => {\n            let options = {\n                env: app.env,\n                logLevel: app.options.logLevel,\n                ...config.options,\n            };\n\n            let appPath;\n\n            if (config.npmModule) {\n                appPath = app.toAbsolutePath('node_modules', name);\n            } else {\n                appPath = path.join(app.libModulesPath, name);\n            }\n\n            let exists = (await fs.pathExists(appPath)) && (await isDir_(appPath));\n            if (!exists) {\n                throw new InvalidConfiguration(`Lib [${name}] not exists.`, app, `libModules.${name}`);\n            }\n\n            let lib = new LibModule(app, name, appPath, options);\n\n            lib.on('configLoaded', () => {\n                if (!_.isEmpty(config.settings)) {\n                    lib.config.settings = { ...lib.config.settings, ...config.settings };\n                    app.log('verbose', `Lib settings of [${lib.name}] is overrided.`);\n                }\n            });\n\n            let relativePath = path.relative(app.workingPath, appPath);\n            app.log('verbose', `Loading lib [${lib.name}] from \"${relativePath}\" ...`);\n\n            await lib.start_();\n\n            app.registerLib(lib);\n\n            app.log('verbose', `Lib [${lib.name}] is loaded.`);\n        });\n    },\n};\n"],"names":["stage","Feature","PLUGIN","load_","app","entries","batchAsync_","config","name","options","env","logLevel","appPath","npmModule","toAbsolutePath","path","join","libModulesPath","exists","fs","pathExists","isDir_","InvalidConfiguration","lib","LibModule","on","_","isEmpty","settings","log","relativePath","relative","workingPath","start_","registerLib"],"mappings":"AAAA;;;;;;;;;;;;;;;CAeC;;;;+BASD;;;eAAA;;;iEAPiB;uBACc;qBACJ;uBACU;gEACjB;kEACE;;;;;;MAEtB,WAAe;IACX;;;KAGC,GACDA,OAAOC,gBAAO,CAACC,MAAM;IAErB;;;;;KAKC,GACDC,OAAO,OAAOC,KAAKC;QACf,OAAOC,IAAAA,kBAAW,EAACD,SAAS,OAAOE,QAAQC;YACvC,IAAIC,UAAU;gBACVC,KAAKN,IAAIM,GAAG;gBACZC,UAAUP,IAAIK,OAAO,CAACE,QAAQ;gBAC9B,GAAGJ,OAAOE,OAAO;YACrB;YAEA,IAAIG;YAEJ,IAAIL,OAAOM,SAAS,EAAE;gBAClBD,UAAUR,IAAIU,cAAc,CAAC,gBAAgBN;YACjD,OAAO;gBACHI,UAAUG,iBAAI,CAACC,IAAI,CAACZ,IAAIa,cAAc,EAAET;YAC5C;YAEA,IAAIU,SAAS,AAAC,MAAMC,OAAE,CAACC,UAAU,CAACR,YAAc,MAAMS,IAAAA,WAAM,EAACT;YAC7D,IAAI,CAACM,QAAQ;gBACT,MAAM,IAAII,2BAAoB,CAAC,CAAC,KAAK,EAAEd,KAAK,aAAa,CAAC,EAAEJ,KAAK,CAAC,WAAW,EAAEI,KAAK,CAAC;YACzF;YAEA,IAAIe,MAAM,IAAIC,kBAAS,CAACpB,KAAKI,MAAMI,SAASH;YAE5Cc,IAAIE,EAAE,CAAC,gBAAgB;gBACnB,IAAI,CAACC,QAAC,CAACC,OAAO,CAACpB,OAAOqB,QAAQ,GAAG;oBAC7BL,IAAIhB,MAAM,CAACqB,QAAQ,GAAG;wBAAE,GAAGL,IAAIhB,MAAM,CAACqB,QAAQ;wBAAE,GAAGrB,OAAOqB,QAAQ;oBAAC;oBACnExB,IAAIyB,GAAG,CAAC,WAAW,CAAC,iBAAiB,EAAEN,IAAIf,IAAI,CAAC,eAAe,CAAC;gBACpE;YACJ;YAEA,IAAIsB,eAAef,iBAAI,CAACgB,QAAQ,CAAC3B,IAAI4B,WAAW,EAAEpB;YAClDR,IAAIyB,GAAG,CAAC,WAAW,CAAC,aAAa,EAAEN,IAAIf,IAAI,CAAC,QAAQ,EAAEsB,aAAa,KAAK,CAAC;YAEzE,MAAMP,IAAIU,MAAM;YAEhB7B,IAAI8B,WAAW,CAACX;YAEhBnB,IAAIyB,GAAG,CAAC,WAAW,CAAC,KAAK,EAAEN,IAAIf,IAAI,CAAC,YAAY,CAAC;QACrD;IACJ;AACJ"}