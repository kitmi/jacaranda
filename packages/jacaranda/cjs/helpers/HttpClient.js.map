{"version":3,"sources":["../../src/helpers/HttpClient.js"],"sourcesContent":["import { _, url as urlUtil } from '@kitmi/utils';\n\n/**\n * Enable a http client as service\n * @module Feature_HttpClient\n */\n\nconst DefaultMethods = {\n    get: 'get',\n    post: 'post',\n    put: 'put',\n    del: 'del',\n    delete: 'del',\n    upload: 'post',\n    download: 'get',\n};\n\nfunction resToPath(parts) {\n    return parts ? (Array.isArray(parts) ? parts.map((res) => encodeURIComponent(res)).join('/') : parts) : '';\n}\n\n/**\n * HTTP client.\n * @class\n */\nclass HttpClient {\n    /**\n     *\n     * @param {*} endpoint\n     */\n    constructor(adapter, endpointOrOptions) {\n        this.adapter = adapter;\n        this.options = typeof endpointOrOptions === 'string' ? { endpoint: endpointOrOptions } : endpointOrOptions;\n    }\n\n    /**\n     *\n     * @param {string} method\n     * @param {string} path\n     * @param {object} query\n     * @param {object} body\n     * @param {object} options - Request options\n     * @property {string} [options.httpMethod] - Specified the http method to override the method argument\n     * @property {string} [options.endpoint] - Specified the base endpoint for this request only\n     * @property {function} [options.onSend] - Specified the onSend hook for this request only\n     * @property {integer} [options.timeout] - Specified the timeout setting for this request only\n     * @property {object} [options.headers] - Specified the headers for this request only\n     * @property {boolean} [options.withCredentials] - Specified the withCredentials header for CORS\n     * @property {object} [options.formData] - Specified the form fields\n     * @property {object} [options.fileField='file'] - Specified the file field name\n     * @property {object} [options.fileName] - Specified the file name to override the file to upload\n     * @property {function} [options.onProgress] - Specified the on progress callback\n     * @returns {*}\n     */\n    async do(method, path, query, body, options) {\n        method = method.toLowerCase();\n        const _options = { ...this.options, ...options, _method: method };\n\n        let httpMethod = _options.httpMethod ?? DefaultMethods[method];\n        if (!httpMethod) {\n            throw new Error('Invalid method: ' + method);\n        }\n\n        let url = path.startsWith('http:') || path.startsWith('https:') ? path : urlUtil.join(_options.endpoint, path);\n\n        let req = this.adapter.createRequest(httpMethod, url, _options);\n\n        if (this.onSending) {\n            this.onSending(req);\n        }\n\n        if (_options.onSending) {\n            _options.onSending(req);\n        }\n\n        if (_options.timeout) {\n            req.timeout(_options.timeout);\n        }\n\n        if (_options.headers) {\n            _.each(_options.headers, (v, k) => {\n                req.set(k, v);\n            });\n        }\n\n        if (_options.withCredentials) {\n            req.withCredentials();\n        }\n\n        if (query) {\n            req.query(query);\n        }\n\n        if (method === 'download') {\n            if (httpMethod !== 'get') {\n                req.send(body);\n            }\n        } else if (method === 'upload') {\n            if (_options.formData) {\n                _.each(_options.formData, (v, k) => {\n                    req.field(k, v);\n                });\n            }\n            \n            let fileOpts = null;\n            if (_options.fileName) {\n                fileOpts = { filename: _options.fileName };\n            }\n\n            if (_options.contentType) {\n                fileOpts = { ...fileOpts, contentType: _options.contentType };\n            }\n\n            req.attach(_options.fileField ?? 'file', body, fileOpts);\n        } else if (httpMethod !== 'get') {\n            if (_options.usePipe) {\n                req = new Promise((resolve, reject) => {                    \n                    req.on('response', resolve);\n                    req.on('error', reject);\n                    body.pipe(req);\n                });\n            } else {\n                req.send(body ?? _options.body);\n            }\n        }\n\n        if (_options.onProgress) {\n            req.on('progress', _options.onProgress);\n        }\n\n        try {\n            const res = await req;\n            const result = res.type.startsWith('text/') ? res.text : res.body;\n\n            if (this.onResponse) {\n                this.onResponse(result, req, res);\n            }\n\n            if (_options.onResponse) {\n                _options.onResponse(result, req, res);\n            }\n\n            return result;\n        } catch (error) {\n            const onOtherError = _options.onOtherError ?? this.onOtherError;\n            const onResponseError = _options.onResponseError ?? this.onResponseError;\n\n            if (error.response) {                \n                if (onResponseError) {\n                    let body = error.response.body;\n                    if (!body && error.response.type === 'application/json') {\n                        try {\n                            body = JSON.parse(error.response.text);\n                        } catch (e) {}\n                    }                    \n\n                    return onResponseError(body, error);\n                }\n\n                throw error;\n            }\n\n            if (onOtherError) {\n                return onOtherError(error);\n            }\n\n            throw error;\n        }\n    }\n\n    async get(resource, query, options) {\n        return this.do('get', resToPath(resource), query, null, options);\n    }\n\n    async post(resource, data, query, options) {\n        return this.do('post', resToPath(resource), query, data, options);\n    }\n\n    async put(resource, data, query, options) {\n        return this.do('put', resToPath(resource), query, data, options);\n    }\n\n    async del(resource, query, options) {\n        return this.do('del', resToPath(resource), query, null, options);\n    }\n\n    async delete(...args) {\n        return this.del(...args);\n    }\n\n    async upload(resource, file, query, options) {\n        return this.do('upload', resToPath(resource), query, file, options);\n    }\n\n    async download(resource, query, options) {        \n        return this.do('download', resToPath(resource), query, null, options);\n    }\n}\n\nexport default HttpClient;\n"],"names":["DefaultMethods","get","post","put","del","delete","upload","download","resToPath","parts","Array","isArray","map","res","encodeURIComponent","join","HttpClient","do","method","path","query","body","options","toLowerCase","_options","_method","httpMethod","Error","url","startsWith","urlUtil","endpoint","req","adapter","createRequest","onSending","timeout","headers","_","each","v","k","set","withCredentials","send","formData","field","fileOpts","fileName","filename","contentType","attach","fileField","usePipe","Promise","resolve","reject","on","pipe","onProgress","result","type","text","onResponse","error","onOtherError","onResponseError","response","JSON","parse","e","resource","data","args","file","constructor","endpointOrOptions"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}