{"version":3,"sources":["../../src/helpers/Controller.js"],"sourcesContent":["import { ApplicationError } from '@kitmi/types';\nimport { _ } from '@kitmi/utils';\n\nclass BasicController {\n    constructor(app) {\n        /**\n         * App module\n         * @member {WebModule}\n         */\n        this.app = app;\n        this.apiWrapper = this.app.getService(this.app.settings?.apiWrapperService || 'apiWrapper');\n\n        if (!this.apiWrapper) {\n            throw new ApplicationError('\"apiWrapper\" service is required when using the built-in Controller.');\n        }\n\n        if (this.app.settings?.models) {\n            // init models service\n            this.modelsService = _.mapValues(this.app.settings.models, ({ lib, driver }, schema) => {\n                if (this.defaultSchema == null) {\n                    /**\n                     * Default schema\n                     * @member {string}\n                     */\n                    this.defaultSchema = schema;\n                }\n\n                const modelsModule = lib ? this.app.host.getLib(lib) : this.app;\n                const service = modelsModule.getService(driver);\n                if (service == null) {\n                    throw new ApplicationError(`Model driver \"${driver}\" not found in ${lib ? 'lib' : 'app module'} \"${lib ?? this.app.name}\"`);\n                }\n\n                return service;\n            });\n        }\n    }\n\n    /**\n     * Return a service by name\n     * @param {string} serviceName \n     * @returns {object}\n     */\n    $(serviceName) {\n        const service = this.app.getService(serviceName);\n        if (!service) {\n            throw new ApplicationError(`Service \"${serviceName}\" is enabled.`);\n        }\n\n        return service;\n    }\n\n    /**\n     * Return a db model by name [ and schema ]\n     * @param {*} name \n     * @param {*} [schema] \n     * @returns {DbModel}\n     */\n    $m(name, schema) {\n        const service = this.modelsService[schema ?? this.defaultSchema];\n        return service.$model(name);\n    }\n\n    /**\n     * Try to send back data from time-to-live cache\n     * @param {*} ctx\n     * @param {*} key\n     * @returns {boolean}\n     */\n    trySendCache(ctx, key) {\n        if (ctx.query['no-cache']) {\n            return false;\n        }\n\n        const ttlCache = this.app.getService('ttlMemCache');\n        if (!ttlCache) {\n            throw new ApplicationError(\n                '\"ttlMemCache\" service is required. Please check npm module \"@kitmi/feat-utils/ttlMemCache\".'\n            );\n        }\n\n        const _cache = ttlCache.get(key);\n        if (_cache) {\n            this.send(ctx, ..._cache);\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Delete a memory cache entry by key\n     * @param {*} key \n     */\n    deleteCache(key) {\n        const ttlCache = this.app.getService('ttlMemCache');\n        ttlCache.del(key);\n    }\n\n    /**\n     * Send response with cache and wrapped by apiWrapper feature\n     * @param {*} ctx \n     * @param {*} result \n     * @param {*} payload \n     * @param {*} ttlCacheInfo \n     */\n    send(ctx, result, payload, ttlCacheInfo) {\n        ctx.body = this.apiWrapper.wrapResult(ctx, result, payload);\n        if (ttlCacheInfo) {\n            const ttlCache = this.app.getService('ttlMemCache');\n            const value = [result];\n            if (payload) {\n                value.push(payload);\n            }\n\n            if (!ttlCacheInfo.key)  {\n                throw new ApplicationError('\"key\" of TTL cache is required.');\n            }\n\n            ttlCache.set(ttlCacheInfo.key, value, ttlCacheInfo.ttl);\n        }\n    }\n}\n\nexport default BasicController;\n"],"names":["BasicController","$","serviceName","service","app","getService","ApplicationError","$m","name","schema","modelsService","defaultSchema","$model","trySendCache","ctx","key","query","ttlCache","_cache","get","send","deleteCache","del","result","payload","ttlCacheInfo","body","apiWrapper","wrapResult","value","push","set","ttl","constructor","settings","apiWrapperService","models","_","mapValues","lib","driver","modelsModule","host","getLib"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}