{"version":3,"sources":["../../src/serverFeatures/appRouting.js"],"sourcesContent":["/**\n * Enable routing web requests to a child app.\n * @module Feature_AppRouting\n *\n * @example\n *\n *  'appRouting': {\n *      '<mounting point>': {\n *          name: 'app name',\n *          npmModule: false, // whether is a npm module\n *          options: { // module options\n *          },\n *          settings: { // can override module defined settings\n *          },\n *          middlewares: { // can override middlewares\n *          }\n *      }\n *  }\n */\n\nimport path from 'node:path';\nimport { _, batchAsync_ } from '@kitmi/utils';\nimport { fs, isDir_ } from '@kitmi/sys';\nimport { InvalidConfiguration } from '@kitmi/types';\nimport Feature from '../Feature';\n\nimport WebModule from '../WebModule';\n\nexport default {\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    stage: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {WebServer} server - The web server module object.\n     * @param {object} routes - Routes and configuration.\n     * @returns {Promise.<*>}\n     */\n    load_: async (server, routes) =>\n        batchAsync_(routes, async (config, baseRoute) => {\n            if (!config.name) {\n                throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);\n            }\n\n            let options = {\n                configType: server.options.configType,\n                logLevel: server.options.logLevel,\n                traceMiddlewares: server.options.traceMiddlewares,   \n                logMiddlewareRegistry: server.options.logMiddlewareRegistry,     \n                sourcePath: server.options.sourcePath,           \n                ...config.options,\n            };            \n\n            let appPath;\n            let moduleMeta = server.registry?.apps?.[config.name];\n\n            if (moduleMeta != null) {\n                appPath = moduleMeta.appPath;\n            } else if (config.npmModule) {\n                moduleMeta = await server.tryRequire_(config.name, true); \n                appPath = moduleMeta.appPath;\n            } else {\n                appPath = path.join(server.appModulesPath, config.name);\n            }\n\n            let exists = (await fs.pathExists(appPath)) && (await isDir_(appPath));\n            if (!exists) {\n                throw new InvalidConfiguration(\n                    `App [${config.name}] not found at ${appPath}`,\n                    server,\n                    `appRouting[${baseRoute}].name`\n                );\n            }\n\n            let app = new WebModule(server, config.name, baseRoute, appPath, { registry: moduleMeta?.registry, ...options });\n            app.now = server.now;            \n\n            app.once('configLoaded', () => {\n                if (!_.isEmpty(config.overrides)) {\n                    Object.assign(app.config, config.overrides);\n                    server.log('verbose', 'App config is overrided.');\n                }\n\n                if (!_.isEmpty(config.settings)) {\n                    app.config.settings = Object.assign({}, app.config.settings, config.settings);\n                    server.log('verbose', `App settings of [${app.name}] is overrided.`);\n                }\n\n                if (!_.isEmpty(config.middlewares)) {\n                    let middlewaresToAppend = app.config.middlewares;\n                    app.config.middlewares = { ...config.middlewares };\n                    _.defaults(app.config.middlewares, middlewaresToAppend);\n                }\n            });\n\n            let relativePath = path.relative(server.workingPath, appPath);\n            server.log('verbose', `Loading app [${app.name}] from \"${relativePath}\" ...`);\n\n            await app.start_();\n\n            server.log('verbose', `App [${app.name}] is loaded.`);\n\n            //delayed the app routes mounting after all plugins of the server are loaded\n            server.on('before:' + Feature.FINAL, () => {\n                server.mountApp(app);\n            });\n        }),\n};\n"],"names":["stage","Feature","PLUGIN","load_","server","routes","batchAsync_","config","baseRoute","name","InvalidConfiguration","app","options","configType","logLevel","traceMiddlewares","logMiddlewareRegistry","sourcePath","appPath","moduleMeta","registry","apps","npmModule","tryRequire_","path","join","appModulesPath","exists","fs","pathExists","isDir_","WebModule","now","once","_","isEmpty","overrides","Object","assign","log","settings","middlewares","middlewaresToAppend","defaults","relativePath","relative","workingPath","start_","on","FINAL","mountApp"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}