{"version":3,"sources":["../src/ServiceInstaller.js"],"sourcesContent":["import { packageManagers } from '@kitmi/adapters';\nimport { eachAsync_ } from '@kitmi/utils';\nimport ServiceContainer from './ServiceContainer';\n\n/**\n * Service dependencies installer.\n * @class\n */\nclass ServiceInstaller extends ServiceContainer {     \n    async _loadFeatureGroup_(featureGroup, groupStage) {\n        const npm = packageManagers[this.options.packageManager];\n\n        featureGroup = this._sortFeatures(featureGroup);\n\n        await this.emit_('before:' + groupStage);\n        this.log('info', `Installing dependencies for \"${groupStage}\" feature group ...`);\n\n        let counter = 0;\n\n        await eachAsync_(featureGroup, async ([feature, options]) => {\n            const { name, depends } = feature;\n            await this.emit_('before:load:' + name);\n            this.log('info', `Installing dependencies for feature \"${name}\" ...`);\n\n            depends && this._dependsOn(depends, name);\n\n            const requiredPackages = feature.packages ? (typeof feature.packages === 'function' ? feature.packages(options) : feature.packages) : [];\n            if (this.options.dryRun) {\n                this.log('info', `Detected dependencies: [${requiredPackages.join(', ')}]`)\n            } else {\n                await eachAsync_(requiredPackages, pkg => npm.addPackage_(pkg));\n            }\n\n            this.features[name].enabled = true;\n            if (requiredPackages.length > 0) {\n                this.log('info', `Dependencies of feature \"${name}\" are installed. [${requiredPackages.length}]`);\n            } else {\n                this.log('info', `No dependencies found for feature \"${name}\". [SKIP]`);\n            }\n\n            await this.emit_('after:load:' + name);\n\n            counter += requiredPackages.length;\n        });\n\n        if (counter > 0) {\n            this.log('info', `Finished installation of dependencies for \"${groupStage}\" feature group. [${counter}]`);\n        } else {\n            this.log('info', `No dependencies found for \"${groupStage}\" feature group. [SKIP]`);\n        }\n\n        await this.emit_('after:' + groupStage);\n    }\n}\n\nexport default ServiceInstaller;\n"],"names":["ServiceInstaller","ServiceContainer","_loadFeatureGroup_","featureGroup","groupStage","npm","packageManagers","options","packageManager","_sortFeatures","emit_","log","counter","eachAsync_","feature","name","depends","_dependsOn","requiredPackages","packages","dryRun","join","pkg","addPackage_","features","enabled","length"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAuDA;;;eAAA;;;0BAvDgC;uBACL;yEACE;;;;;;AAE7B;;;CAGC,GACD,MAAMA,yBAAyBC,yBAAgB;IAC3C,MAAMC,mBAAmBC,YAAY,EAAEC,UAAU,EAAE;QAC/C,MAAMC,MAAMC,yBAAe,CAAC,IAAI,CAACC,OAAO,CAACC,cAAc,CAAC;QAExDL,eAAe,IAAI,CAACM,aAAa,CAACN;QAElC,MAAM,IAAI,CAACO,KAAK,CAAC,YAAYN;QAC7B,IAAI,CAACO,GAAG,CAAC,QAAQ,CAAC,6BAA6B,EAAEP,WAAW,mBAAmB,CAAC;QAEhF,IAAIQ,UAAU;QAEd,MAAMC,IAAAA,iBAAU,EAACV,cAAc,OAAO,CAACW,SAASP,QAAQ;YACpD,MAAM,EAAEQ,IAAI,EAAEC,OAAO,EAAE,GAAGF;YAC1B,MAAM,IAAI,CAACJ,KAAK,CAAC,iBAAiBK;YAClC,IAAI,CAACJ,GAAG,CAAC,QAAQ,CAAC,qCAAqC,EAAEI,KAAK,KAAK,CAAC;YAEpEC,WAAW,IAAI,CAACC,UAAU,CAACD,SAASD;YAEpC,MAAMG,mBAAmBJ,QAAQK,QAAQ,GAAI,OAAOL,QAAQK,QAAQ,KAAK,aAAaL,QAAQK,QAAQ,CAACZ,WAAWO,QAAQK,QAAQ,GAAI,EAAE;YACxI,IAAI,IAAI,CAACZ,OAAO,CAACa,MAAM,EAAE;gBACrB,IAAI,CAACT,GAAG,CAAC,QAAQ,CAAC,wBAAwB,EAAEO,iBAAiBG,IAAI,CAAC,MAAM,CAAC,CAAC;YAC9E,OAAO;gBACH,MAAMR,IAAAA,iBAAU,EAACK,kBAAkBI,CAAAA,MAAOjB,IAAIkB,WAAW,CAACD;YAC9D;YAEA,IAAI,CAACE,QAAQ,CAACT,KAAK,CAACU,OAAO,GAAG;YAC9B,IAAIP,iBAAiBQ,MAAM,GAAG,GAAG;gBAC7B,IAAI,CAACf,GAAG,CAAC,QAAQ,CAAC,yBAAyB,EAAEI,KAAK,kBAAkB,EAAEG,iBAAiBQ,MAAM,CAAC,CAAC,CAAC;YACpG,OAAO;gBACH,IAAI,CAACf,GAAG,CAAC,QAAQ,CAAC,mCAAmC,EAAEI,KAAK,SAAS,CAAC;YAC1E;YAEA,MAAM,IAAI,CAACL,KAAK,CAAC,gBAAgBK;YAEjCH,WAAWM,iBAAiBQ,MAAM;QACtC;QAEA,IAAId,UAAU,GAAG;YACb,IAAI,CAACD,GAAG,CAAC,QAAQ,CAAC,2CAA2C,EAAEP,WAAW,kBAAkB,EAAEQ,QAAQ,CAAC,CAAC;QAC5G,OAAO;YACH,IAAI,CAACD,GAAG,CAAC,QAAQ,CAAC,2BAA2B,EAAEP,WAAW,uBAAuB,CAAC;QACtF;QAEA,MAAM,IAAI,CAACM,KAAK,CAAC,WAAWN;IAChC;AACJ;MAEA,WAAeJ"}