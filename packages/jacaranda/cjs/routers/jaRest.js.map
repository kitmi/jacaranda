{"version":3,"sources":["../../src/routers/jaRest.js"],"sourcesContent":["import path from 'node:path';\nimport { globSync } from 'glob';\nimport { naming, text, hasMethod, esmCheck, batchAsync_ } from '@kitmi/utils';\n\n/**\n * Jacaranda Restful API Spec (jaREST) router.\n * @module Router_JaREST\n */\n\nconst appendId = (baseEndpoint, idName) => (idName ? `${baseEndpoint}/:${idName}` : baseEndpoint);\n\n/**\n * Create a jaREST router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {object} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      jaREST: {\n *          $controllerPath:\n *          $middlewares:\n *          $errorOptions\n *          'controller To remap': '/special/:abc/url'\n *          ...\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            find\n *  /:resource                     post           create\n *  /:resource/:id                 get            findOne\n *  /:resource/:id                 patch          updateOne\n *  /:resource/:id                 put            replaceOne\n *  /:resource/:id                 delete         deleteOne \n *  /:resource                     put            replaceMany\n *  /:resource                     patch          updateMany\n *  /:resource                     delete         deleteMany\n */\nconst jaRestRouter = async (app, baseRoute, options) => {\n    let router = app.router.createRouter(baseRoute);\n\n    let resourcePath = path.resolve(app.sourcePath, options.$controllerPath || 'resources');\n    const kebabify = options.$urlDasherize;\n\n    app.useMiddleware(router, await app.getMiddlewareFactory('jsonError')(options.$errorOptions, app), 'jsonError');\n\n    if (options.$middlewares) {\n        await app.useMiddlewares_(router, options.$middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, '**/*.js');\n    let files = globSync(resourcesPath);\n\n    await batchAsync_(files, async filepath => {\n        let controller = esmCheck(require(filepath));\n\n        if (typeof controller === 'function') {\n            controller = new controller(app);\n        }\n\n        const relativePath = path.relative(resourcePath, filepath);\n        const dirPath = path.dirname(relativePath);\n        const entityName = path.basename(relativePath, '.js');\n        const entithNameWithPath = path.join(dirPath, entityName);\n\n        let baseEndpoint;\n        if (entithNameWithPath in options) {\n            baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options[entithNameWithPath], '/'), '/');\n        } else {\n            const urlPath = entithNameWithPath\n                .split('/')\n                .map((p) => kebabify ? naming.kebabCase(p) : p)\n                .join('/');\n            baseEndpoint = text.ensureStartsWith(urlPath, '/');\n        }\n\n        let idName = naming.camelCase(entityName) + 'Id';\n        let endpointWithId = appendId(baseEndpoint, idName);\n\n        async function addRoute_(methodName, httpMethod) {\n            if (hasMethod(controller, methodName)) {\n                const _action = controller[methodName].bind(controller);\n                const _middlewares = controller[methodName].__metaMiddlewares;\n                await app.addRoute_(router, httpMethod, baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n            }\n        }\n\n        async function addRouteWithId_(methodName, httpMethod) {\n            if (hasMethod(controller, methodName)) {\n                const _action = (ctx) => controller[methodName](ctx, ctx.params[idName]);\n                const _middlewares = controller[methodName].__metaMiddlewares;\n                await app.addRoute_(router, httpMethod, endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n            }\n        }\n\n        await addRoute_('query', 'get');\n        await addRoute_('post', 'post');\n        await addRoute_('replaceMany', 'put');\n        await addRoute_('updateMany', 'patch');\n        await addRoute_('deleteMany', 'delete');\n\n        await addRouteWithId_('findOne', 'get');\n        await addRouteWithId_('replaceOne', 'put');\n        await addRouteWithId_('updateOne', 'patch');\n        await addRouteWithId_('deleteOne', 'delete');        \n    });\n\n    app.addRouter(router);\n};\n\nexport default jaRestRouter;\n"],"names":["appendId","baseEndpoint","idName","jaRestRouter","app","baseRoute","options","router","createRouter","resourcePath","path","resolve","sourcePath","$controllerPath","kebabify","$urlDasherize","useMiddleware","getMiddlewareFactory","$errorOptions","$middlewares","useMiddlewares_","resourcesPath","join","files","globSync","batchAsync_","filepath","controller","esmCheck","require","relativePath","relative","dirPath","dirname","entityName","basename","entithNameWithPath","text","ensureStartsWith","dropIfEndsWith","urlPath","split","map","p","naming","kebabCase","camelCase","endpointWithId","addRoute_","methodName","httpMethod","hasMethod","_action","bind","_middlewares","__metaMiddlewares","addRouteWithId_","ctx","params","addRouter"],"mappings":"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"}