{"version":3,"sources":["../../src/routers/rest.js"],"sourcesContent":["import path from 'node:path';\nimport { naming, text, hasMethod, esmCheck, batchAsync_ } from '@kitmi/utils';\nimport { globSync } from 'glob';\n\n/**\n * Simple RESTful router.\n * @module Router_REST\n */\n\n/**\n * Create a RESTful router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {object} options\n * @property {string} [options.$controllerPath]\n * @property {object} [options.$errorOptions]\n * @property {object|array} [options.$middlewares]\n * @example\n *  '<base path>': {\n *      REST: {\n *          $controllerPath:\n *          $errorOptions:\n *          $middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            list\n *  /:resource                     post           create\n *  /:resource/:id                 get            detail\n *  /:resource/:id                 put            update\n *  /:resource/:id                 delete         remove\n */\nconst restRouter = async (app, baseRoute, options) => {\n    let router = app.router.createRouter(baseRoute);\n\n    let resourcePath = path.resolve(app.sourcePath, options.$controllerPath ?? 'resources');\n    const kebabify = options.$urlDasherize;\n\n    app.useMiddleware(router, await app.getMiddlewareFactory('jsonError')(options.$errorOptions, app), 'jsonError');\n\n    if (options.$middlewares) {\n        await app.useMiddlewares_(router, options.$middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, '**', '*.js');\n    let files = globSync(resourcesPath, { nodir: true });\n\n    await batchAsync_(files, async (file) => {\n        let relPath = path.relative(resourcePath, file);\n        let batchUrl = text.ensureStartsWith(\n            relPath\n                .substring(0, relPath.length - 3)\n                .split(path.sep)\n                .map((p) => kebabify ? naming.kebabCase(p) : p)\n                .join('/'),\n            '/'\n        );\n        let singleUrl = batchUrl + '/:id';\n\n        let controller = esmCheck(require(file));\n\n        if (typeof controller === 'function') {\n            controller = new controller(app);\n        }\n\n        if (hasMethod(controller, 'list')) {\n            await app.addRoute_(router, 'get', batchUrl, (ctx) => controller.list(ctx));\n        }\n\n        if (hasMethod(controller, 'create')) {\n            await app.addRoute_(router, 'post', batchUrl, (ctx) => controller.create(ctx));\n        }\n\n        if (hasMethod(controller, 'detail')) {\n            await app.addRoute_(router, 'get', singleUrl, (ctx) => controller.detail(ctx));\n        }\n\n        if (hasMethod(controller, 'update')) {\n            await app.addRoute_(router, 'put', singleUrl, (ctx) => controller.update(ctx));\n        }\n\n        if (hasMethod(controller, 'remove')) {\n            await app.addRoute_(router, 'delete', singleUrl, (ctx) => controller.remove(ctx));\n        }\n    });\n\n    app.addRouter(router);\n};\n\nexport default restRouter;\n"],"names":["restRouter","app","baseRoute","options","router","createRouter","resourcePath","path","resolve","sourcePath","$controllerPath","kebabify","$urlDasherize","useMiddleware","getMiddlewareFactory","$errorOptions","$middlewares","useMiddlewares_","resourcesPath","join","files","globSync","nodir","batchAsync_","file","relPath","relative","batchUrl","text","ensureStartsWith","substring","length","split","sep","map","p","naming","kebabCase","singleUrl","controller","esmCheck","require","hasMethod","addRoute_","ctx","list","create","detail","update","remove","addRouter"],"mappings":";;;;+BA0FA;;;eAAA;;;iEA1FiB;uBAC8C;sBACtC;;;;;;AAEzB;;;CAGC,GAED;;;;;;;;;;;;;;;;;;;;;;;CAuBC,GACD,MAAMA,aAAa,OAAOC,KAAKC,WAAWC;IACtC,IAAIC,SAASH,IAAIG,MAAM,CAACC,YAAY,CAACH;IAErC,IAAII,eAAeC,iBAAI,CAACC,OAAO,CAACP,IAAIQ,UAAU,EAAEN,QAAQO,eAAe,IAAI;IAC3E,MAAMC,WAAWR,QAAQS,aAAa;IAEtCX,IAAIY,aAAa,CAACT,QAAQ,MAAMH,IAAIa,oBAAoB,CAAC,aAAaX,QAAQY,aAAa,EAAEd,MAAM;IAEnG,IAAIE,QAAQa,YAAY,EAAE;QACtB,MAAMf,IAAIgB,eAAe,CAACb,QAAQD,QAAQa,YAAY;IAC1D;IAEA,IAAIE,gBAAgBX,iBAAI,CAACY,IAAI,CAACb,cAAc,MAAM;IAClD,IAAIc,QAAQC,IAAAA,cAAQ,EAACH,eAAe;QAAEI,OAAO;IAAK;IAElD,MAAMC,IAAAA,kBAAW,EAACH,OAAO,OAAOI;QAC5B,IAAIC,UAAUlB,iBAAI,CAACmB,QAAQ,CAACpB,cAAckB;QAC1C,IAAIG,WAAWC,WAAI,CAACC,gBAAgB,CAChCJ,QACKK,SAAS,CAAC,GAAGL,QAAQM,MAAM,GAAG,GAC9BC,KAAK,CAACzB,iBAAI,CAAC0B,GAAG,EACdC,GAAG,CAAC,CAACC,IAAMxB,WAAWyB,aAAM,CAACC,SAAS,CAACF,KAAKA,GAC5ChB,IAAI,CAAC,MACV;QAEJ,IAAImB,YAAYX,WAAW;QAE3B,IAAIY,aAAaC,IAAAA,eAAQ,EAACC,QAAQjB;QAElC,IAAI,OAAOe,eAAe,YAAY;YAClCA,aAAa,IAAIA,WAAWtC;QAChC;QAEA,IAAIyC,IAAAA,gBAAS,EAACH,YAAY,SAAS;YAC/B,MAAMtC,IAAI0C,SAAS,CAACvC,QAAQ,OAAOuB,UAAU,CAACiB,MAAQL,WAAWM,IAAI,CAACD;QAC1E;QAEA,IAAIF,IAAAA,gBAAS,EAACH,YAAY,WAAW;YACjC,MAAMtC,IAAI0C,SAAS,CAACvC,QAAQ,QAAQuB,UAAU,CAACiB,MAAQL,WAAWO,MAAM,CAACF;QAC7E;QAEA,IAAIF,IAAAA,gBAAS,EAACH,YAAY,WAAW;YACjC,MAAMtC,IAAI0C,SAAS,CAACvC,QAAQ,OAAOkC,WAAW,CAACM,MAAQL,WAAWQ,MAAM,CAACH;QAC7E;QAEA,IAAIF,IAAAA,gBAAS,EAACH,YAAY,WAAW;YACjC,MAAMtC,IAAI0C,SAAS,CAACvC,QAAQ,OAAOkC,WAAW,CAACM,MAAQL,WAAWS,MAAM,CAACJ;QAC7E;QAEA,IAAIF,IAAAA,gBAAS,EAACH,YAAY,WAAW;YACjC,MAAMtC,IAAI0C,SAAS,CAACvC,QAAQ,UAAUkC,WAAW,CAACM,MAAQL,WAAWU,MAAM,CAACL;QAChF;IACJ;IAEA3C,IAAIiD,SAAS,CAAC9C;AAClB;MAEA,WAAeJ"}