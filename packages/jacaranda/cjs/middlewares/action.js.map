{"version":3,"sources":["../../src/middlewares/action.js"],"sourcesContent":["/**\n * Response action as middleware\n * @module Middleware_Action\n */\n\nimport { InvalidConfiguration } from '@kitmi/types';\n\nconst controllerCache = {};\n\n/**\n * Action middleware creator\n * @param {string} controllerAction\n * @param {Routable} app\n */\nconst action = (controllerAction, app) => {\n    if (typeof controllerAction !== 'string') {\n        throw new InvalidConfiguration('Invalid action syntax.', app);\n    }\n\n    let pos = controllerAction.lastIndexOf('.');\n    if (pos < 0) {\n        throw new InvalidConfiguration(`Unrecognized controller & action syntax: ${controllerAction}.`, app);\n    }\n\n    let controller = controllerAction.substring(0, pos);\n    let action = controllerAction.substring(pos + 1);\n\n    let ctrl = app.registry.controllers?.actions?.[controller];\n\n    if (ctrl == null) {\n        throw new InvalidConfiguration(`Action controller \"${controller}\" not found.`, app);\n    }\n\n    if (typeof ctrl === 'function') {        \n        if (!controllerCache[controller]){\n            controllerCache[controller] = new ctrl(app);\n        }\n\n        ctrl = controllerCache[controller];\n    }\n\n    // todo: path support\n\n    let actioner = ctrl[action];\n\n    if (Array.isArray(actioner)) {\n        let actionFunction = actioner.concat().pop();\n        if (typeof actionFunction !== 'function') {\n            throw new InvalidConfiguration(\n                `${controllerAction} does not contain a valid action in returned middleware chain.`,\n                app\n            );\n        }\n\n        return actioner.concat(actionFunction);\n    }\n\n    if (typeof actioner !== 'function') {\n        throw new InvalidConfiguration(`${controllerAction} is not a valid action.`, app);\n    }\n\n    return actioner;\n};\n\nexport default action;\n"],"names":["controllerCache","action","controllerAction","app","InvalidConfiguration","pos","lastIndexOf","controller","substring","ctrl","registry","controllers","actions","actioner","Array","isArray","actionFunction","concat","pop"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA;;;CAGC;;;;+BA6DD;;;eAAA;;;uBA3DqC;AAErC,MAAMA,kBAAkB,CAAC;AAEzB;;;;CAIC,GACD,MAAMC,SAAS,CAACC,kBAAkBC;IAC9B,IAAI,OAAOD,qBAAqB,UAAU;QACtC,MAAM,IAAIE,2BAAoB,CAAC,0BAA0BD;IAC7D;IAEA,IAAIE,MAAMH,iBAAiBI,WAAW,CAAC;IACvC,IAAID,MAAM,GAAG;QACT,MAAM,IAAID,2BAAoB,CAAC,CAAC,yCAAyC,EAAEF,iBAAiB,CAAC,CAAC,EAAEC;IACpG;IAEA,IAAII,aAAaL,iBAAiBM,SAAS,CAAC,GAAGH;IAC/C,IAAIJ,SAASC,iBAAiBM,SAAS,CAACH,MAAM;IAE9C,IAAII,OAAON,IAAIO,QAAQ,CAACC,WAAW,EAAEC,SAAS,CAACL,WAAW;IAE1D,IAAIE,QAAQ,MAAM;QACd,MAAM,IAAIL,2BAAoB,CAAC,CAAC,mBAAmB,EAAEG,WAAW,YAAY,CAAC,EAAEJ;IACnF;IAEA,IAAI,OAAOM,SAAS,YAAY;QAC5B,IAAI,CAACT,eAAe,CAACO,WAAW,EAAC;YAC7BP,eAAe,CAACO,WAAW,GAAG,IAAIE,KAAKN;QAC3C;QAEAM,OAAOT,eAAe,CAACO,WAAW;IACtC;IAEA,qBAAqB;IAErB,IAAIM,WAAWJ,IAAI,CAACR,OAAO;IAE3B,IAAIa,MAAMC,OAAO,CAACF,WAAW;QACzB,IAAIG,iBAAiBH,SAASI,MAAM,GAAGC,GAAG;QAC1C,IAAI,OAAOF,mBAAmB,YAAY;YACtC,MAAM,IAAIZ,2BAAoB,CAC1B,CAAC,EAAEF,iBAAiB,8DAA8D,CAAC,EACnFC;QAER;QAEA,OAAOU,SAASI,MAAM,CAACD;IAC3B;IAEA,IAAI,OAAOH,aAAa,YAAY;QAChC,MAAM,IAAIT,2BAAoB,CAAC,CAAC,EAAEF,iBAAiB,uBAAuB,CAAC,EAAEC;IACjF;IAEA,OAAOU;AACX;MAEA,WAAeZ"}