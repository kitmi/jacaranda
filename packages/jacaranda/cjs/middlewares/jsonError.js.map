{"version":3,"sources":["../../src/middlewares/jsonError.js"],"sourcesContent":["/**\n * Error response middleware with json\n * @module Middleware_JsonError\n */\n\nimport http from 'node:http';\n\nconst jsonError = (opt, app) => {\n    const apiWrapper = app.getService(app.settings?.apiWrapperService || 'apiWrapper');\n    const handler = apiWrapper && apiWrapper.wrapError;\n\n    return async (ctx, next) => {\n        try {\n            await next();\n\n            if (ctx.errorHandled) {\n                return;\n            }\n\n            if (ctx.status >= 400) {\n                if (ctx.type === 'text/plain') {\n                    ctx.throw(ctx.status, ctx.body);\n                } else {\n                    ctx.throw(ctx.status);\n                }\n            }\n        } catch (err) {\n            ctx.status = typeof err.status === 'number' && err.status >= 100 ? err.status : 500;\n            ctx.type = 'application/json';\n\n            // accepted types\n            if (handler) {\n                try {\n                    ctx.body = await handler(ctx, err);\n                    ctx.app.emit('error', err, ctx);\n                    ctx.errorHandled = true;\n                    return;\n                } catch (error) {\n                    error.innerError = err;\n                    err = error;\n                }\n            }\n\n            ctx.body = { error: err.expose && err.message ? err.message : http.STATUS_CODES[ctx.status] };\n            ctx.app.emit('error', err, ctx);\n        }\n    };\n};\n\nexport default jsonError;\n"],"names":["jsonError","opt","app","apiWrapper","getService","settings","apiWrapperService","handler","wrapError","ctx","next","errorHandled","status","type","throw","body","err","emit","error","innerError","expose","message","http","STATUS_CODES"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA;;;CAGC;;;;+BA8CD;;;eAAA;;;iEA5CiB;;;;;;AAEjB,MAAMA,YAAY,CAACC,KAAKC;IACpB,MAAMC,aAAaD,IAAIE,UAAU,CAACF,IAAIG,QAAQ,EAAEC,qBAAqB;IACrE,MAAMC,UAAUJ,cAAcA,WAAWK,SAAS;IAElD,OAAO,OAAOC,KAAKC;QACf,IAAI;YACA,MAAMA;YAEN,IAAID,IAAIE,YAAY,EAAE;gBAClB;YACJ;YAEA,IAAIF,IAAIG,MAAM,IAAI,KAAK;gBACnB,IAAIH,IAAII,IAAI,KAAK,cAAc;oBAC3BJ,IAAIK,KAAK,CAACL,IAAIG,MAAM,EAAEH,IAAIM,IAAI;gBAClC,OAAO;oBACHN,IAAIK,KAAK,CAACL,IAAIG,MAAM;gBACxB;YACJ;QACJ,EAAE,OAAOI,KAAK;YACVP,IAAIG,MAAM,GAAG,OAAOI,IAAIJ,MAAM,KAAK,YAAYI,IAAIJ,MAAM,IAAI,MAAMI,IAAIJ,MAAM,GAAG;YAChFH,IAAII,IAAI,GAAG;YAEX,iBAAiB;YACjB,IAAIN,SAAS;gBACT,IAAI;oBACAE,IAAIM,IAAI,GAAG,MAAMR,QAAQE,KAAKO;oBAC9BP,IAAIP,GAAG,CAACe,IAAI,CAAC,SAASD,KAAKP;oBAC3BA,IAAIE,YAAY,GAAG;oBACnB;gBACJ,EAAE,OAAOO,OAAO;oBACZA,MAAMC,UAAU,GAAGH;oBACnBA,MAAME;gBACV;YACJ;YAEAT,IAAIM,IAAI,GAAG;gBAAEG,OAAOF,IAAII,MAAM,IAAIJ,IAAIK,OAAO,GAAGL,IAAIK,OAAO,GAAGC,iBAAI,CAACC,YAAY,CAACd,IAAIG,MAAM,CAAC;YAAC;YAC5FH,IAAIP,GAAG,CAACe,IAAI,CAAC,SAASD,KAAKP;QAC/B;IACJ;AACJ;MAEA,WAAeT"}