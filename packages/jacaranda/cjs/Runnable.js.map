{"version":3,"sources":["../src/Runnable.js"],"sourcesContent":["import { _, sleep_, batchAsync_ } from '@kitmi/utils';\nimport { InvalidConfiguration } from '@kitmi/types';\nimport { defaultRunnableOpts } from './defaultOpts';\nimport path from 'node:path';\nimport minimist from 'minimist';\n\n/**\n * Runnable app mixin.\n * @param {object} T - Base class.\n * @returns {Runnable} A runable app class.\n * @constructs Runnable(T)\n */\nconst Runnable = (T) =>\n    class extends T {\n        _getOnUncaughtException = (exitOnError) => (err) => {\n            if (exitOnError) {\n                //wait 1 second for flushing the last log\n                this.log('error', err);\n            } else {\n                this.logError(err);\n            }\n        };\n\n        _onWarning = (warning) => {\n            this.log('warn', warning.message);\n        };\n\n        _onExit = (code) => {\n            if (this.started) {\n                if (this._logCache.length) {\n                    this.flushLogCache();\n                }                \n            }\n\n            this.stop_().catch(this.logError);                \n        };\n\n        /**\n         * @param {string} name - The name of the application.\n         * @param {object} [options] - Application options\n         * @property {string} [options.logLevel='info'] - Logging level\n         * @property {object} [options.ignoreUncaught=false] - Whether to skip the handling of uncaught exception\n         * @property {object} [options.exitOnUncaught=true] - Whether to exit process on uncaught exception thrown\n         * @property {object} [options.logFeatures=false] - Log enabled features\n         * @property {object} [options.logConfig=false] - Log finalized config\n         * @constructs Runnable\n         */\n        constructor(name, options) {\n            if (process.argv.length > 2) {\n                const { _, ...cliOptions } = minimist(process.argv.slice(2));\n                options = { ...cliOptions, ...options };\n            }            \n\n            super(name, {\n                ...defaultRunnableOpts,\n                ...options,\n            });            \n\n            this.runnable = true;\n\n            this.libModulesPath = this.toAbsolutePath(this.options.libModulesPath);            \n        }\n\n        /**\n         * Start the app\n         * @returns {Promise}\n         * @memberof Runnable\n         */\n        async start_() {\n            if (this.started) {\n                throw new Error('App already started.');\n            }\n\n            this._initialize();\n\n            process.on('exit', this._onExit);\n\n            await super.start_();\n\n            if (\n                this.options.logFeatures &&\n                (this.options.logLevel === 'verbose' || this.options.logLevel === 'debug')\n            ) {\n                const childModules = {};\n                this.visitChildModules((childModule, name) => {\n                    childModules[name] = {\n                        features: Object.keys(childModule.features),\n                        services: Object.keys(childModule.services),\n                    };\n                });\n\n                this.log('verbose', 'Enabled features & services:', {\n                    features: Object.keys(this.features),\n                    services: Object.keys(this.services),\n                    modules: childModules,\n                });\n            }\n\n            return this;\n        }\n\n        /**\n         * Stop the app\n         * @returns {Promise}\n         * @memberof Runnable\n         */\n        async stop_() {\n            let stopByThis = false;\n\n            if (this.started) {\n                stopByThis = true;\n\n                if (this.libModules) {\n                    await batchAsync_(this.libModules, (lib) => lib.stop_());\n                    delete this.libModules;\n                }\n            }\n\n            process.removeListener('exit', this._onExit);\n\n            await super.stop_();\n\n            await sleep_(0);\n\n            if (stopByThis) {\n                this._uninitialize();\n            }\n        }\n\n        visitChildModules(vistor) {\n            if (this.libModules) {\n                _.each(this.libModules, vistor);\n            }\n        }\n\n        /**\n         * Get the lib module\n         * @param {string} libName\n         * @memberof Runnable\n         */\n        getLib(libName) {\n            if (!this.libModules) {\n                throw new Error('\"libModules\" feature is required to access lib among modules.');\n            }\n\n            let libModule = this.libModules[libName];\n\n            if (!libModule) {\n                throw new Error(`Lib module [${libName}] not found.`);\n            }\n\n            return libModule;\n        }\n\n        /**\n         * Register a loaded lib module\n         * @param {LibModule} lib\n         * @memberof Runnable\n         */\n        registerLib(lib) {\n            if (!this.libModules) {\n                this.libModules = {};\n            }\n\n            if (lib.name in this.libModules) {\n                throw new InvalidConfiguration(`Lib module [${lib.name}] already exists.`, this, {\n                    name: lib.name,\n                });\n            }\n\n            this.libModules[lib.name] = lib;\n        }\n\n        /**\n         * Get a registered service\n         * @param {string} name\n         *\n         * @example\n         *  // Get service from a lib module\n         *  const service = app.getService('<lib name>/<service name>');\n         *  // e.g const service = app.getService('data/mysql.mydb');\n         * @memberof Runnable\n         */\n        getService(name) {\n            let pos = name.indexOf('/');\n            if (pos === -1) {\n                return super.getService(name);\n            }\n\n            let lib = name.substring(0, pos);\n            name = name.substring(pos + 1);\n\n            let app = this.getLib(lib);\n            return app?.getService(name, true);\n        }\n\n        _initialize() {\n            this._pwd = process.cwd();\n            if (this.workingPath !== this._pwd) {\n                process.chdir(this.workingPath);\n            }\n\n            this._injectErrorHandlers();\n        }\n\n        _uninitialize() {\n            const detach = true;\n            this._injectErrorHandlers(detach);\n\n            process.chdir(this._pwd);\n            delete this._pwd;\n        }\n\n        _injectErrorHandlers(detach) {\n            if (detach) {\n                process.removeListener('warning', this._onWarning);\n                if (this._onUncaughtException) {\n                    process.removeListener('uncaughtException', this._onUncaughtException);\n                    delete this._onUncaughtException;\n                }\n\n                return;\n            }\n\n            if (!this.options.ignoreUncaught) {\n                this._onUncaughtException = this._getOnUncaughtException(this.options.exitOnUncaught);\n                process.on('uncaughtException', this._onUncaughtException);\n            }\n\n            process.on('warning', this._onWarning);\n        }\n\n        _getFeatureFallbackPath() {\n            let pathArray = super._getFeatureFallbackPath();\n            pathArray.splice(1, 0, path.resolve(__dirname, 'appFeatures'));\n    \n            return pathArray;\n        }\n    };\n\nexport default Runnable;\n"],"names":["Runnable","T","start_","started","Error","_initialize","process","on","_onExit","options","logFeatures","logLevel","childModules","visitChildModules","childModule","name","features","Object","keys","services","log","modules","stop_","stopByThis","libModules","batchAsync_","lib","removeListener","sleep_","_uninitialize","vistor","_","each","getLib","libName","libModule","registerLib","InvalidConfiguration","getService","pos","indexOf","substring","app","_pwd","cwd","workingPath","chdir","_injectErrorHandlers","detach","_onWarning","_onUncaughtException","ignoreUncaught","_getOnUncaughtException","exitOnUncaught","_getFeatureFallbackPath","pathArray","splice","path","resolve","__dirname","constructor","argv","length","cliOptions","minimist","slice","defaultRunnableOpts","exitOnError","err","logError","warning","message","code","_logCache","flushLogCache","catch","runnable","libModulesPath","toAbsolutePath"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}