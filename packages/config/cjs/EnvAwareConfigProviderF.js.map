{"version":3,"sources":["../src/EnvAwareConfigProviderF.js"],"sourcesContent":["import path from 'node:path';\nimport { _ } from '@kit/utils';\n\nfunction defaultOverrider(defConfig, envConfig) {\n    return { ...defConfig, ...envConfig };\n}\n\n/**\n * Environment-aware config provider factory\n * @param {string} EXT - File extension name, e.g. \".json\"\n * @param {class} PROVIDER - Config provider class\n * @param {string} [DEFAULT_FLAG=\"default\"] - Default flag\n */\nconst EnvAwareConfigProviderF = (EXT, PROVIDER, DEFAULT_FLAG = 'default') =>\n    class {\n        /**\n         * Environment-aware config provider\n         * @constructs EnvAwareConfigProvider\n         * @param {string} configDir - The base directory of config files\n         * @param {string} baseName - The basename of the config file\n         * @param {string} [envFlag=\"development\"] - Environment flag\n         */\n        constructor(configDir, baseName, envFlag = 'development', overrider) {\n            /**\n             * The raw default config\n             * @type {object}\n             * @private\n             */\n            this._defConfigProvider = new PROVIDER(path.join(configDir, baseName + '.' + DEFAULT_FLAG + EXT));\n\n            /**\n             * The environment specific config\n             * @type {object}\n             * @public\n             */\n            this._envConfigProvider = new PROVIDER(path.join(configDir, baseName + '.' + envFlag + EXT));\n\n            this._envFlag = envFlag;\n\n            this._overrider = overrider || defaultOverrider;\n\n            /**\n             * The loaded config\n             * @type {object}\n             * @public\n             */\n            this.config = undefined;\n        }\n\n        /**\n         * Start loading the config files\n         * @memberof EnvAwareConfigProvider\n         * @returns {Promise.<object>}\n         */\n        async load_(logger, noThrow) {\n            const defConfig = await this._defConfigProvider.load_(logger, noThrow);\n            const envConfig = await this._envConfigProvider.load_(logger, true);\n\n            this.config = this._overrider(defConfig, envConfig);\n            if (logger && !_.isEmpty(envConfig)) {\n                logger.log(\n                    'info',\n                    `Configuration is overrided by environment-specific [env=${this._envFlag}] settings.`\n                );\n            }\n\n            return this.config;\n        }\n\n        /**\n         * Start saving the config to files\n         * @memberof EnvAwareConfigProvider\n         * @returns {Promise.<*>}\n         */\n        async save_() {\n            await this._envConfigProvider.save_();\n        }\n\n        /**\n         * Update config item by dotted path.\n         * @memberof EnvAwareConfigProvider\n         * @param {string} key - The path of config item, e.g. \"item.subItem.key\" refers to { item: { subItem: { key: \"*\" } } }\n         * @param {*} value - New value of config item\n         * @returns {JsonConfigProvider}\n         */\n        setItem(key, value) {\n            _.set(this.config, key, value);\n            this._envConfigProvider.setItem(key, value);\n            return this;\n        }\n\n        /**\n         * Get config item by dotted path.\n         * @memberof EnvAwareConfigProvider\n         * @param {string} key\n         * @param {*} defaultValue\n         * @returns {*}\n         */\n        getItem(key, defaultValue) {\n            return _.get(this.config, key, defaultValue);\n        }\n    };\n\nexport default EnvAwareConfigProviderF;\n"],"names":["defaultOverrider","defConfig","envConfig","EnvAwareConfigProviderF","EXT","PROVIDER","DEFAULT_FLAG","load_","logger","noThrow","_defConfigProvider","_envConfigProvider","config","_overrider","_","isEmpty","log","_envFlag","save_","setItem","key","value","set","getItem","defaultValue","get","constructor","configDir","baseName","envFlag","overrider","path","join","undefined"],"mappings":";;;;+BAuGA;;;eAAA;;;iEAvGiB;uBACC;;;;;;AAElB,SAASA,iBAAiBC,SAAS,EAAEC,SAAS;IAC1C,OAAO;QAAE,GAAGD,SAAS;QAAE,GAAGC,SAAS;IAAC;AACxC;AAEA;;;;;CAKC,GACD,MAAMC,0BAA0B,CAACC,KAAKC,UAAUC,eAAe,SAAS;IACpE;QAmCI;;;;SAIC,GACD,MAAMC,MAAMC,MAAM,EAAEC,OAAO,EAAE;YACzB,MAAMR,YAAY,MAAM,IAAI,CAACS,kBAAkB,CAACH,KAAK,CAACC,QAAQC;YAC9D,MAAMP,YAAY,MAAM,IAAI,CAACS,kBAAkB,CAACJ,KAAK,CAACC,QAAQ;YAE9D,IAAI,CAACI,MAAM,GAAG,IAAI,CAACC,UAAU,CAACZ,WAAWC;YACzC,IAAIM,UAAU,CAACM,QAAC,CAACC,OAAO,CAACb,YAAY;gBACjCM,OAAOQ,GAAG,CACN,QACA,CAAC,wDAAwD,EAAE,IAAI,CAACC,QAAQ,CAAC,WAAW,CAAC;YAE7F;YAEA,OAAO,IAAI,CAACL,MAAM;QACtB;QAEA;;;;SAIC,GACD,MAAMM,QAAQ;YACV,MAAM,IAAI,CAACP,kBAAkB,CAACO,KAAK;QACvC;QAEA;;;;;;SAMC,GACDC,QAAQC,GAAG,EAAEC,KAAK,EAAE;YAChBP,QAAC,CAACQ,GAAG,CAAC,IAAI,CAACV,MAAM,EAAEQ,KAAKC;YACxB,IAAI,CAACV,kBAAkB,CAACQ,OAAO,CAACC,KAAKC;YACrC,OAAO,IAAI;QACf;QAEA;;;;;;SAMC,GACDE,QAAQH,GAAG,EAAEI,YAAY,EAAE;YACvB,OAAOV,QAAC,CAACW,GAAG,CAAC,IAAI,CAACb,MAAM,EAAEQ,KAAKI;QACnC;QArFA;;;;;;SAMC,GACDE,YAAYC,SAAS,EAAEC,QAAQ,EAAEC,UAAU,aAAa,EAAEC,SAAS,CAAE;YACjE;;;;aAIC,GACD,IAAI,CAACpB,kBAAkB,GAAG,IAAIL,SAAS0B,iBAAI,CAACC,IAAI,CAACL,WAAWC,WAAW,MAAMtB,eAAeF;YAE5F;;;;aAIC,GACD,IAAI,CAACO,kBAAkB,GAAG,IAAIN,SAAS0B,iBAAI,CAACC,IAAI,CAACL,WAAWC,WAAW,MAAMC,UAAUzB;YAEvF,IAAI,CAACa,QAAQ,GAAGY;YAEhB,IAAI,CAAChB,UAAU,GAAGiB,aAAa9B;YAE/B;;;;aAIC,GACD,IAAI,CAACY,MAAM,GAAGqB;QAClB;IAsDJ;;;MAEJ,WAAe9B"}