{"version":3,"sources":["../src/FiniteStateMachine.js"],"sourcesContent":["import { eachAsync_ } from '@kitmi/utils';\nimport { InvalidArgument, Forbidden } from '@kitmi/types';\n\nclass FiniteStateMachine {\n    /**\n     * OK result\n     * @memberof FiniteStateMachine\n     * @static\n     * @type {Array}\n     */\n    static OK = [true];\n\n    /**\n     * Fail with a reason\n     * @memberof FiniteStateMachine\n     * @static\n     * @param {*} reason\n     * @returns {Array}\n     */\n    static fail = (reason) => [false, reason];\n\n    /**\n     * Trigger all actions in the array\n     * @memberof FiniteStateMachine\n     * @static\n     * @param {Array} array\n     * @returns {function}\n     */\n    static triggerAll =\n        (array) =>\n        async (...args) =>\n            eachAsync_(array, (action_) => action_(...args));\n\n    /**\n     * If any of the conditions in the array is met, return OK, otherwise fail with a reason.\n     * @memberof FiniteStateMachine\n     * @static\n     * @param {Array} array \n     * @returns {function}\n     */\n    static ifAny =\n        (array) =>\n        async (...args) => {\n            const l = array.length;\n            const reasons = [];\n\n            for (let i = 0; i < l; i++) {\n                const checker_ = array[i];\n\n                const [allowed, disallowedReason] = await checker_(...args);\n                if (allowed) {\n                    return FiniteStateMachine.OK;\n                }\n\n                reasons.push(disallowedReason);\n            }\n\n            return FiniteStateMachine.fail('None of the required conditions met.\\n' + reasons.join('\\n'));\n        };\n\n    /**\n     * If all of the conditions in the array are met, return OK, otherwise fail with a reason.\n     * @memberof FiniteStateMachine\n     * @static\n     * @param {Array} array \n     * @returns {function}\n     */\n    static ifAll =\n        (array) =>\n        async (...args) => {\n            const l = array.length;\n\n            for (let i = 0; i < l; i++) {\n                const checker_ = array[i];\n\n                const [allowed, disallowedReason] = await checker_(...args);\n                if (!allowed) {\n                    return FiniteStateMachine.fail(disallowedReason);\n                }\n            }\n\n            return FiniteStateMachine.OK;\n        };\n\n    /**\n     * Finite State Machine\n     * @constructs FiniteStateMachine\n     * @param {*} app - Application instance, can be null if not needed\n     * @param {object} transitionTable - { state: { action: { desc, when, target, before, after } } }\n     * \n     *  Action rule:\n     * <ul>\n     *      <li>desc: description of this transition</li>\n     *      <li>when: pre transition condition check</li>\n     *      <li>target: target state</li>\n     *      <li>before: transforming before applying to the state, can be async</li>\n     *      <li>after: trigger another action after transition, can be async</li>\n     * </ul>\n     * @param {function} stateFetcher - (app, context, fetcherOpts) => state\n     * @param {function} stateUpdater - (app, context, payload, targetState, updaterOpts) => [actuallyUpdated, updateResult]          \n     */\n    constructor(app, transitionTable, stateFetcher, stateUpdater) {\n        this.app = app;\n\n        this.transitions = transitionTable;\n        this.stateFetcher_ = stateFetcher;\n        this.stateUpdater_ = stateUpdater;\n    }\n\n    /**\n     * Get a list of allowed actions based on the current state.\n     * @param {*} context\n     * @param {boolean} withDisallowedReason\n     */\n    async getAllowedActions_(context, withDisallowedReason) {\n        const currentState = await this.stateFetcher_(this.app, context);\n\n        // from state\n        const transitions = this.transitions[currentState];\n        if (!transitions) {\n            throw new InvalidArgument(`State \"${currentState}\" rules not found in the transition table.`);\n        }\n\n        const allowed = [];\n        const disallowed = [];\n\n        await eachAsync_(transitions, async (rule, action) => {\n            const [actionAllowed, disallowedReason] =\n                (rule.when && (await rule.when(this.app, context))) || FiniteStateMachine.OK;\n\n            if (actionAllowed) {\n                allowed.push({\n                    action,\n                    desc: rule.desc,\n                    targetState: rule.target,\n                });\n            } else if (withDisallowedReason) {\n                disallowed.push({\n                    action,\n                    desc: rule.desc,\n                    targetState: rule.target,\n                    reason: disallowedReason,\n                });\n            }\n        });\n\n        const ret = {\n            allowed,\n        };\n\n        if (withDisallowedReason) {\n            ret.disallowed = disallowed;\n        }\n\n        return ret;\n    }\n\n    /**\n     * Perform the specified action.\n     * @param {String} action\n     * @param {*} context\n     * @param {*} payload\n     * @param {*} fetcherOpts\n     * @param {*} updaterOpts\n     */\n    async doAction_(action, context, payload, fetcherOpts, updaterOpts) {\n        const currentState = await this.stateFetcher_(this.app, context, fetcherOpts);\n\n        const transitions = this.transitions[currentState];\n        if (!transitions) {\n            throw new InvalidArgument(`State \"${currentState}\" rules not found in the transition table.`);\n        }\n\n        const rule = transitions && transitions[action];\n        if (!rule) {\n            throw new Forbidden(`Action \"${action}\" is not allowed in \"${currentState}\" state.`);\n        }\n\n        if (rule.when) {\n            const [allowed, disallowedReason] = await rule.when(this.app, context);\n            if (!allowed) {\n                throw new Forbidden(\n                    disallowedReason || `The current state does not meet the requirements of \"${action}\" action.`\n                );\n            }\n        }\n\n        const entityUpdate = (rule.before && (await rule.before(this.app, context, payload))) || { ...payload };\n        const [actuallyUpdated, updateResult] = await this.stateUpdater_(\n            this.app,\n            context,\n            entityUpdate,\n            rule.target,\n            updaterOpts\n        );\n\n        if (actuallyUpdated && rule.after) {\n            await rule.after(this.app, context);\n        }\n\n        return updateResult;\n    }\n}\n\nexport default FiniteStateMachine;\n"],"names":["FiniteStateMachine","getAllowedActions_","context","withDisallowedReason","currentState","stateFetcher_","app","transitions","InvalidArgument","allowed","disallowed","eachAsync_","rule","action","actionAllowed","disallowedReason","when","OK","push","desc","targetState","target","reason","ret","doAction_","payload","fetcherOpts","updaterOpts","Forbidden","entityUpdate","before","actuallyUpdated","updateResult","stateUpdater_","after","constructor","transitionTable","stateFetcher","stateUpdater","fail","triggerAll","array","args","action_","ifAny","l","length","reasons","i","checker_","join","ifAll"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BA4MA;;;eAAA;;;uBA5M2B;uBACgB;;;;;;;;;;;;;;AAE3C,MAAMA;IA0GF;;;;KAIC,GACD,MAAMC,mBAAmBC,OAAO,EAAEC,oBAAoB,EAAE;QACpD,MAAMC,eAAe,MAAM,IAAI,CAACC,aAAa,CAAC,IAAI,CAACC,GAAG,EAAEJ;QAExD,aAAa;QACb,MAAMK,cAAc,IAAI,CAACA,WAAW,CAACH,aAAa;QAClD,IAAI,CAACG,aAAa;YACd,MAAM,IAAIC,sBAAe,CAAC,CAAC,OAAO,EAAEJ,aAAa,0CAA0C,CAAC;QAChG;QAEA,MAAMK,UAAU,EAAE;QAClB,MAAMC,aAAa,EAAE;QAErB,MAAMC,IAAAA,iBAAU,EAACJ,aAAa,OAAOK,MAAMC;YACvC,MAAM,CAACC,eAAeC,iBAAiB,GACnC,AAACH,KAAKI,IAAI,IAAK,MAAMJ,KAAKI,IAAI,CAAC,IAAI,CAACV,GAAG,EAAEJ,YAAcF,mBAAmBiB,EAAE;YAEhF,IAAIH,eAAe;gBACfL,QAAQS,IAAI,CAAC;oBACTL;oBACAM,MAAMP,KAAKO,IAAI;oBACfC,aAAaR,KAAKS,MAAM;gBAC5B;YACJ,OAAO,IAAIlB,sBAAsB;gBAC7BO,WAAWQ,IAAI,CAAC;oBACZL;oBACAM,MAAMP,KAAKO,IAAI;oBACfC,aAAaR,KAAKS,MAAM;oBACxBC,QAAQP;gBACZ;YACJ;QACJ;QAEA,MAAMQ,MAAM;YACRd;QACJ;QAEA,IAAIN,sBAAsB;YACtBoB,IAAIb,UAAU,GAAGA;QACrB;QAEA,OAAOa;IACX;IAEA;;;;;;;KAOC,GACD,MAAMC,UAAUX,MAAM,EAAEX,OAAO,EAAEuB,OAAO,EAAEC,WAAW,EAAEC,WAAW,EAAE;QAChE,MAAMvB,eAAe,MAAM,IAAI,CAACC,aAAa,CAAC,IAAI,CAACC,GAAG,EAAEJ,SAASwB;QAEjE,MAAMnB,cAAc,IAAI,CAACA,WAAW,CAACH,aAAa;QAClD,IAAI,CAACG,aAAa;YACd,MAAM,IAAIC,sBAAe,CAAC,CAAC,OAAO,EAAEJ,aAAa,0CAA0C,CAAC;QAChG;QAEA,MAAMQ,OAAOL,eAAeA,WAAW,CAACM,OAAO;QAC/C,IAAI,CAACD,MAAM;YACP,MAAM,IAAIgB,gBAAS,CAAC,CAAC,QAAQ,EAAEf,OAAO,qBAAqB,EAAET,aAAa,QAAQ,CAAC;QACvF;QAEA,IAAIQ,KAAKI,IAAI,EAAE;YACX,MAAM,CAACP,SAASM,iBAAiB,GAAG,MAAMH,KAAKI,IAAI,CAAC,IAAI,CAACV,GAAG,EAAEJ;YAC9D,IAAI,CAACO,SAAS;gBACV,MAAM,IAAImB,gBAAS,CACfb,oBAAoB,CAAC,qDAAqD,EAAEF,OAAO,SAAS,CAAC;YAErG;QACJ;QAEA,MAAMgB,eAAe,AAACjB,KAAKkB,MAAM,IAAK,MAAMlB,KAAKkB,MAAM,CAAC,IAAI,CAACxB,GAAG,EAAEJ,SAASuB,YAAc;YAAE,GAAGA,OAAO;QAAC;QACtG,MAAM,CAACM,iBAAiBC,aAAa,GAAG,MAAM,IAAI,CAACC,aAAa,CAC5D,IAAI,CAAC3B,GAAG,EACRJ,SACA2B,cACAjB,KAAKS,MAAM,EACXM;QAGJ,IAAII,mBAAmBnB,KAAKsB,KAAK,EAAE;YAC/B,MAAMtB,KAAKsB,KAAK,CAAC,IAAI,CAAC5B,GAAG,EAAEJ;QAC/B;QAEA,OAAO8B;IACX;IArHA;;;;;;;;;;;;;;;;KAgBC,GACDG,YAAY7B,GAAG,EAAE8B,eAAe,EAAEC,YAAY,EAAEC,YAAY,CAAE;QAC1D,IAAI,CAAChC,GAAG,GAAGA;QAEX,IAAI,CAACC,WAAW,GAAG6B;QACnB,IAAI,CAAC/B,aAAa,GAAGgC;QACrB,IAAI,CAACJ,aAAa,GAAGK;IACzB;AA+FJ;AAtMI;;;;;KAKC,GACD,iBAPEtC,oBAOKiB,MAAK;IAAC;CAAK;AAElB;;;;;;KAMC,GACD,iBAhBEjB,oBAgBKuC,QAAO,CAACjB,SAAW;QAAC;QAAOA;KAAO;AAEzC;;;;;;KAMC,GACD,iBAzBEtB,oBAyBKwC,cACH,CAACC,QACD,OAAO,GAAGC,OACN/B,IAAAA,iBAAU,EAAC8B,OAAO,CAACE,UAAYA,WAAWD;AAElD;;;;;;KAMC,GACD,iBArCE1C,oBAqCK4C,SACH,CAACH,QACD,OAAO,GAAGC;QACN,MAAMG,IAAIJ,MAAMK,MAAM;QACtB,MAAMC,UAAU,EAAE;QAElB,IAAK,IAAIC,IAAI,GAAGA,IAAIH,GAAGG,IAAK;YACxB,MAAMC,WAAWR,KAAK,CAACO,EAAE;YAEzB,MAAM,CAACvC,SAASM,iBAAiB,GAAG,MAAMkC,YAAYP;YACtD,IAAIjC,SAAS;gBACT,OAAOT,mBAAmBiB,EAAE;YAChC;YAEA8B,QAAQ7B,IAAI,CAACH;QACjB;QAEA,OAAOf,mBAAmBuC,IAAI,CAAC,2CAA2CQ,QAAQG,IAAI,CAAC;IAC3F;AAEJ;;;;;;KAMC,GACD,iBAhEElD,oBAgEKmD,SACH,CAACV,QACD,OAAO,GAAGC;QACN,MAAMG,IAAIJ,MAAMK,MAAM;QAEtB,IAAK,IAAIE,IAAI,GAAGA,IAAIH,GAAGG,IAAK;YACxB,MAAMC,WAAWR,KAAK,CAACO,EAAE;YAEzB,MAAM,CAACvC,SAASM,iBAAiB,GAAG,MAAMkC,YAAYP;YACtD,IAAI,CAACjC,SAAS;gBACV,OAAOT,mBAAmBuC,IAAI,CAACxB;YACnC;QACJ;QAEA,OAAOf,mBAAmBiB,EAAE;IAChC;MA0HR,WAAejB"}