<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>drivers/relational/EntityModel.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Connector.html">Connector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connector.html#getConnectionStringWithoutCredential">getConnectionStringWithoutCredential</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connector.html#makeNewConnectionString">makeNewConnectionString</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EntityModel.html">EntityModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_containsUniqueKey">_containsUniqueKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_delete_">_delete_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_ensureContainsUniqueKey">_ensureContainsUniqueKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_ensureReturningAutoId">_ensureReturningAutoId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_normalizeQuery">_normalizeQuery</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_normalizeReturning">_normalizeReturning</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_prepareEntityData_">_prepareEntityData_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_safeExecute_">_safeExecute_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_translateValue">_translateValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#_wrapCtx">_wrapCtx</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#afterCreate_">afterCreate_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#afterDeleteMany_">afterDeleteMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#afterDelete_">afterDelete_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#afterUpdateMany_">afterUpdateMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#afterUpdate_">afterUpdate_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#beforeCreate_">beforeCreate_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#beforeDeleteMany_">beforeDeleteMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#beforeDelete_">beforeDelete_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#beforeUpdateMany_">beforeUpdateMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#beforeUpdate_">beforeUpdate_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#createFrom_">createFrom_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#create_">create_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#datasetSchema">datasetSchema</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#deleteMany_">deleteMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#deleteOne_">deleteOne_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#ensureRetrieveCreated">ensureRetrieveCreated</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#ensureRetrieveDeleted">ensureRetrieveDeleted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#ensureRetrieveUpdated">ensureRetrieveUpdated</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#findManyByPage_">findManyByPage_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#findMany_">findMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#findOne_">findOne_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#getChainedRelatedEntity">getChainedRelatedEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#getRelatedEntity">getRelatedEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#getUniqueKeyFieldsFrom">getUniqueKeyFieldsFrom</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#getUniqueKeyValuePairsFrom">getUniqueKeyValuePairsFrom</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#getValueFromContext">getValueFromContext</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#omitReadOnly">omitReadOnly</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#updateMany_">updateMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#updateOne_">updateOne_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EntityModel.html#valueOfKey">valueOfKey</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PostgresConnector.html">PostgresConnector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#_executeQuery_">_executeQuery_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#beginTransaction_">beginTransaction_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#commit_">commit_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#connect_">connect_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#createFrom_">createFrom_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#createMany_">createMany_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#create_">create_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#delete_">delete_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#disconnect_">disconnect_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#end_">end_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#execute_">execute_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#find_">find_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#getConnectionStringWithoutCredential">getConnectionStringWithoutCredential</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#makeNewConnectionString">makeNewConnectionString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#ping_">ping_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#rollback_">rollback_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#update_">update_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresConnector.html#upsert_">upsert_</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PostgresEntityModel.html">PostgresEntityModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresEntityModel.html#_mapRecordsToObjects">_mapRecordsToObjects</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresEntityModel.html#_serializeByTypeInfo">_serializeByTypeInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PostgresEntityModel.html#_translateSymbolToken">_translateSymbolToken</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RelationalConnector.html">RelationalConnector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildCTEHeader">_buildCTEHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildColumn">_buildColumn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildColumns">_buildColumns</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildGroupBy">_buildGroupBy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildGroupByColumn">_buildGroupByColumn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildGroupByList">_buildGroupByList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildLimitOffset">_buildLimitOffset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildOrderBy">_buildOrderBy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_buildPartitionBy">_buildPartitionBy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_escapeIdWithAlias">_escapeIdWithAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_generateAlias">_generateAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_joinAssociations">_joinAssociations</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_joinCondition">_joinCondition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_packArray">_packArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_packCondition">_packCondition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#_packValue">_packValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#aggregate_">aggregate_</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalConnector.html#buildQuery">buildQuery</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RelationalEntityModel.html">RelationalEntityModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalEntityModel.html#_extractAssociations">_extractAssociations</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalEntityModel.html#_loadAssocIntoTable">_loadAssocIntoTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RelationalEntityModel.html#_prepareAssociations">_prepareAssociations</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EntityFeatureRuntime_AtLeastOneNotNull.html">EntityFeatureRuntime_AtLeastOneNotNull</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EntityFeatureRuntime_AutoCreate.html">EntityFeatureRuntime_AutoCreate</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EntityFeatureRuntime_ChangeLog.html">EntityFeatureRuntime_ChangeLog</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EntityFeatureRuntime_LogicalDeletion.html">EntityFeatureRuntime_LogicalDeletion</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EntityFeatureRuntime_StateTracking.html">EntityFeatureRuntime_StateTracking</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_DataModel.html">Feature_DataModel</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_DataSource.html">Feature_DataSource</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Feature_DataSource.html#.load_">load_</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Feature_Db.html">Feature_Db</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getValueFromAny">getValueFromAny</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#hasValueInAny">hasValueInAny</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#mergeWhere">mergeWhere</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">drivers/relational/EntityModel.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { _, eachAsync_, batchAsync_, isPlainObject, isEmpty, set as _set, get as _get } from '@kitmi/utils';
import EntityModel, { FLAG_DRY_RUN_IGNORE } from '../../EntityModel';
import { ApplicationError, ReferencedNotExist, ValidationError, InvalidArgument, DatabaseError } from '@kitmi/types';
import { TopoSort } from '@kitmi/algo';

import { getValueFromAny, isSelectAll } from '../../helpers';

export function putInTopoSort(topoSort, assoc, anchor) {
    if (assoc.on) {
        _.each(assoc.on, (value, key) => {
            const pos = key.indexOf('.');
            if (pos > 0) {
                const base = key.substring(0, pos);
                if (base !== anchor) {
                    topoSort.add(base, anchor);
                }
            }

            if (typeof value === 'object' &amp;&amp; value.$xr === 'Column') {
                const pos2 = value.name.indexOf('.');
                if (pos2 > 0) {
                    const base = value.name.substring(0, pos2);
                    if (base !== anchor) {
                        topoSort.add(base, anchor);
                    }
                }
            }
        });
    }
}

/**
 * Relational entity model class.
 */
class RelationalEntityModel extends EntityModel {
    /**
     * [specific] Check if this entity has auto increment feature.
     */
    get hasAutoIncrement() {
        const autoId = this.meta.features.autoId;
        return autoId &amp;&amp; this.meta.fields[autoId.field].autoIncrementId;
    }

    _ensureNoAssociations(data) {
        for (const k in data) {
            if (k[0] === ':' || k[0] === '@') {
                throw new ValidationError(`Association data "${k}" is not allowed in entity "${this.meta.name}".`);
            }
        }
    }

    _uniqueRelations(relations) {
        const [normalAssocs, customAssocs] = _.partition(relations, (assoc) => typeof assoc === 'string');

        return customAssocs.concat(_.uniq(normalAssocs).sort());
    }

    /**
     * Preprocess relationships for non-ORM operations.
     * @param {*} findOptions
     */
    _prepareAssociations(findOptions) {
        const associations = this._uniqueRelations(findOptions.$relation);
        const assocTable = {};
        const cache = {};

        const topoSort = new TopoSort();

        associations.forEach((assoc) => {
            if (typeof assoc === 'object') {
                let { anchor, alias, ...override } = assoc;
                if (anchor) {
                    this._loadAssocIntoTable(findOptions, assocTable, cache, anchor, override);
                    return;
                }

                if (!alias) {
                    alias = assoc.entity;
                }

                if (this.meta.associations &amp;&amp; alias in this.meta.associations) {
                    throw new InvalidArgument(`Alias "${alias}" conflicts with a predefined association.`, {
                        entity: this.meta.name,
                        alias,
                    });
                }

                if (!assoc.entity) {
                    throw new InvalidArgument('Missing "entity" for custom association.', {
                        entity: this.meta.name,
                        alias,
                    });
                }

                putInTopoSort(topoSort, assoc, alias);

                cache[alias] = assocTable[alias] = {
                    ...assoc,
                };
            } else {
                this._loadAssocIntoTable(findOptions, assocTable, cache, assoc);
            }
        });

        const dependencies = topoSort.sort();
        dependencies.forEach((dep) => {
            const item = assocTable[dep];
            if (item == null) {
                throw new InvalidArgument(`Association "${dep}" not found.`, {
                    entity: this.meta.name,
                    assoc: dep,
                });
            }

            delete assocTable[dep];
            assocTable[dep] = item;
        });

        return assocTable;
    }

    /**
     * Load association into table
     * @param {*} assocTable - Hierarchy with subAssocs
     * @param {*} cache - Dotted path as key
     * @param {*} assoc - Dotted path
     */
    _loadAssocIntoTable(findOptions, assocTable, cache, assoc, override) {
        if (cache[assoc]) return cache[assoc];

        const lastPos = assoc.lastIndexOf('.');
        let result;

        if (lastPos === -1) {
            // direct association
            const assocInfo = { ...this.meta.associations[assoc], ...override };
            if (isEmpty(assocInfo)) {
                throw new InvalidArgument(`Entity "${this.meta.name}" does not have the association "${assoc}".`);
            }

            if (assocInfo.list &amp;&amp; !findOptions.$skipOrm &amp;&amp; !isSelectAll(findOptions.$select)) {
                findOptions.$select.add(assoc + '.' + assocInfo.key);
            }

            result = assocTable[assoc] = assocInfo;
            cache[assoc] = result;
        } else {
            const base = assoc.substring(0, lastPos);
            const last = assoc.substring(lastPos + 1);

            let baseNode = cache[base];
            if (!baseNode) {
                baseNode = this._loadAssocIntoTable(findOptions, assocTable, cache, base);
            }

            const entity = this.db.entity(baseNode.entity);
            const assocInfo = { ...entity.meta.associations[last], ...override };
            if (isEmpty(assocInfo)) {
                throw new InvalidArgument(`Entity "${entity.meta.name}" does not have the association "${assoc}".`);
            }

            result = assocInfo;

            if (assocInfo.list &amp;&amp; !findOptions.$skipOrm &amp;&amp; !isSelectAll(findOptions.$select)) {
                findOptions.$select.add(assoc + '.' + assocInfo.key);
            }

            if (!baseNode.subAssocs) {
                baseNode.subAssocs = {};
            }

            baseNode.subAssocs[last] = result;
            cache[assoc] = result;
        }

        return result;
    }

    /**
     * Pre-process assoicated db operation
     * @param {*} data
     * @param {*} isNew - New record flag, true for creating, false for updating
     * @returns {Array} [raw, assocs, refs];
     */
    _extractAssociations(data, isNew) {
        const raw = {};
        const assocs = {};
        const refs = {};
        const meta = this.meta.associations;

        _.each(data, (v, k) => {
            if (k[0] === ':') {
                // cascade update
                const anchor = k.substring(1);
                const assocMeta = meta?.[anchor];
                if (!assocMeta) {
                    throw new ValidationError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
                }

                if (isNew &amp;&amp; assocMeta.type &amp;&amp; anchor in data) {
                    throw new ValidationError(
                        `Association data ":${anchor}" of entity "${this.meta.name}" conflicts with input value of field "${anchor}".`
                    );
                }

                assocs[anchor] = v;
                return;
            }

            if (k[0] === '@') {
                // update by reference
                const anchor = k.substring(1);
                const assocMeta = meta?.[anchor];
                if (!assocMeta) {
                    throw new ValidationError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
                }

                if (!assocMeta.type) {
                    throw new ValidationError(
                        `Association "${anchor}" cannot be used for updating by reference. Only "refersTo" or "belongsTo" is suppported.`,
                        {
                            entity: this.meta.name,
                            anchor,
                        }
                    );
                }

                if (isNew &amp;&amp; anchor in data) {
                    throw new ValidationError(
                        `Association reference "@${anchor}" of entity "${this.meta.name}" conflicts with input value of field "${anchor}".`
                    );
                }

                const assocAnchor = ':' + anchor;
                if (assocAnchor in data) {
                    throw new ValidationError(
                        `Association reference "@${anchor}" of entity "${this.meta.name}" conflicts with association data "${assocAnchor}".`
                    );
                }

                if (v == null) {
                    raw[anchor] = null;
                } else {
                    refs[anchor] = v;
                }

                return;
            }

            raw[k] = v;
        });

        return [raw, assocs, refs];
    }

    async _populateReferences_(context, references) {
        const meta = this.meta.associations;

        await eachAsync_(references, async (refQuery, anchor) => {
            const assocMeta = meta[anchor];
            const ReferencedEntity = this.db.entity(assocMeta.entity);

            const created = await ReferencedEntity.findOne_({ ...refQuery, $select: [assocMeta.field] });

            if (created == null) {
                throw new ReferencedNotExist(
                    `Referenced entity "${ReferencedEntity.meta.name}" with ${JSON.stringify(refQuery)} not exist.`
                );
            }

            context.raw[anchor] = created[assocMeta.field];
        });
    }

    async _createAssocs_(context, assocs, beforeEntityCreate) {
        const meta = this.meta.associations;
        const opOptions = context.options;
        let keyValue;

        if (!beforeEntityCreate) {
            keyValue = context.result.data[this.meta.keyField];

            if (keyValue == null) {
                if (context.result.affectedRows === 0) {
                    // only happens when insert ignored

                    const query = this.getUniqueKeyValuePairsFrom(context.result.data);
                    const data = await this.findOne_({ $select: [this.meta.keyField], $where: query });
                    if (data == null) {
                        throw new ApplicationError(
                            'The parent entity cannot be found using the unique key(s) from data.',
                            {
                                entity: this.meta.name,
                                query,
                            }
                        );
                    }

                    Object.assign(context.result.data, data);
                    keyValue = data[this.meta.keyField];
                }

                if (keyValue == null) {
                    throw new ApplicationError('Missing required primary key field value.', {
                        entity: this.meta.name,
                        data: context.result.data,
                    });
                }
            }
        }

        const pendingAssocs = {};
        const finished = {};

        // todo: double check to ensure including all required options
        const passOnOptions = _.pick(opOptions, ['$skipModifiers', '$migration', '$ctx', '$dryRun']);

        await eachAsync_(assocs, async (data, anchor) => {
            const assocMeta = meta?.[anchor];
            if (assocMeta == null) {
                throw new InvalidArgument(`Association "${anchor}" of entity "${this.meta.name}" not found.`, {
                    entity: this.meta.name,
                    anchor,
                });
            }

            if (beforeEntityCreate &amp;&amp; !assocMeta.type) {
                // reverse reference should be created after the entity is created
                pendingAssocs[anchor] = data;
                return;
            }

            const assocModel = this.db.entity(assocMeta.entity);

            if (assocMeta.list) {
                // hasMany
                if (!Array.isArray(data)) {
                    throw new InvalidArgument(`Association "${anchor}" is a list, array is expected.`, {
                        entity: this.meta.name,
                        anchor,
                        remote: assocMeta.entity,
                    });
                }

                return batchAsync_(data, (item) =>
                    assocModel.create_({ ...item, [assocMeta.field]: keyValue }, { ...passOnOptions, $upsert: true })
                );
            }

            if (!isPlainObject(data)) {
                throw new InvalidArgument(`Association "${anchor}" expects an object as input.`, {
                    entity: this.meta.name,
                    anchor,
                    remote: assocMeta.entity,
                });
            }

            if (!beforeEntityCreate) {
                // hasOne
                data = { ...data, [assocMeta.field]: keyValue };
            }

            let created = await assocModel.create_(data, { ...passOnOptions, $upsert: true });

            if (!beforeEntityCreate) {
                return;
            }

            if (created.affectedRows === 0 || (assocModel.hasAutoIncrement &amp;&amp; created.insertId === 0)) {
                // insert ignored or upserted

                const assocQuery = assocModel.getUniqueKeyValuePairsFrom(data);

                const _data = await assocModel.findOne_({ $select: [assocModel.meta.keyField], $where: assocQuery });
                if (_data == null) {
                    throw new ApplicationError('The child entity cannot be found using the unique key(s) from data.', {
                        entity: assocModel.meta.name,
                        query: assocQuery,
                    });
                }
            }

            finished[anchor] = opOptions.$dryRun ? FLAG_DRY_RUN_IGNORE : created.data[assocMeta.field];
        });

        if (beforeEntityCreate) {
            Object.assign(context.raw, finished);
        }

        return pendingAssocs;
    }

    async _updateAssocs_(context, assocs, beforeEntityUpdate) {
        const meta = this.meta.associations;
        const opOptions = context.options;
        let currentKeyValue;

        if (!beforeEntityUpdate) {
            currentKeyValue = getValueFromAny([opOptions.$where, context.result.data], this.meta.keyField);
            if (currentKeyValue == null) {
                // should have in updating
                throw new ApplicationError('Missing required primary key field value.', {
                    entity: this.meta.name,
                    query: opOptions.$where,
                    data: context.result.data,
                });
            }
        }

        const pendingAssocs = {};

        // todo: double check to ensure including all required options
        const passOnOptions = _.pick(context.options, ['$skipModifiers', '$migration', '$ctx', '$upsert']);

        await eachAsync_(assocs, async (data, anchor) => {
            const assocMeta = meta?.[anchor];
            if (assocMeta == null) {
                throw new InvalidArgument(`Association "${anchor}" of entity "${this.meta.name}" not found.`, {
                    entity: this.meta.name,
                    anchor,
                });
            }

            if (beforeEntityUpdate &amp;&amp; !assocMeta.type) {
                // reverse reference should be updated after the entity is updated
                pendingAssocs[anchor] = data;
                return;
            }

            const assocModel = this.db.entity(assocMeta.entity);

            if (assocMeta.list) {
                // has many
                if (!Array.isArray(data)) {
                    if (typeof data === 'object') {
                        const { $delete, $update, $create, ...others } = data;
                        if (!isEmpty(others)) {
                            throw new InvalidArgument(
                                `Association "${anchor}" is a list and array or object with { $delete, $update, $create } is expected.`,
                                {
                                    entity: this.meta.name,
                                    anchor,
                                    remote: assocMeta.entity,
                                }
                            );
                        }

                        if ($delete) {
                            if (!Array.isArray($delete)) {
                                throw new InvalidArgument(
                                    `"$delete" operation of "hasMany" association "${anchor}" requires an array.`,
                                    {
                                        entity: this.meta.name,
                                        anchor,
                                        remote: assocMeta.entity,
                                    }
                                );
                            }

                            const keysToDelete = $delete.map((item, index) => {
                                const keyValue = item[assocModel.meta.keyField];
                                if (keyValue == null) {
                                    throw new InvalidArgument(
                                        `The key field "${assocModel.meta.keyField}" is required for deletion.`,
                                        {
                                            mainEntity: this.meta.name,
                                            childEntity: assocModel.meta.name,
                                            index,
                                            item,
                                        }
                                    );
                                }
                                return keyValue;
                            });

                            await assocModel.deleteMany_(
                                { [assocModel.meta.keyField]: { $in: keysToDelete } },
                                { ...passOnOptions }
                            );
                        }

                        if ($update) {
                            if (!Array.isArray($update)) {
                                throw new InvalidArgument(
                                    `"$update" operation of "hasMany" association "${anchor}" requires an array.`,
                                    {
                                        entity: this.meta.name,
                                        anchor,
                                        remote: assocMeta.entity,
                                    }
                                );
                            }

                            await batchAsync_($update, async (item, index) => {
                                const keyValue = item[assocModel.meta.keyField];
                                if (keyValue == null) {
                                    throw new InvalidArgument(
                                        `The key field "${assocModel.meta.keyField}" is required for updating.`,
                                        {
                                            mainEntity: this.meta.name,
                                            childEntity: assocModel.meta.name,
                                            index,
                                            item,
                                        }
                                    );
                                }

                                await assocModel.updateOne_(
                                    { ...item, [assocModel.meta.keyField]: undefined },
                                    { ...passOnOptions, $where: { [assocModel.meta.keyField]: keyValue } }
                                );
                            });
                        }

                        if ($create) {
                            if (!Array.isArray($create)) {
                                throw new InvalidArgument(
                                    `"$create" operation of "hasMany" association "${anchor}" requires an array.`,
                                    {
                                        entity: this.meta.name,
                                        anchor,
                                        remote: assocMeta.entity,
                                    }
                                );
                            }

                            await batchAsync_($create, (item) =>
                                assocModel.create_(
                                    { ...item, [assocMeta.field]: currentKeyValue },
                                    { ...passOnOptions, $getCreated: null }
                                )
                            );
                        }

                        return;
                    }

                    throw new InvalidArgument(`Association "${anchor}" is a list and array is expected.`, {
                        entity: this.meta.name,
                        anchor,
                        remote: assocMeta.entity,
                    });
                }

                return batchAsync_(data, (item) =>
                    assocModel.create_(
                        { ...item, [assocMeta.field]: currentKeyValue },
                        { ...passOnOptions, $upsert: true, $getCreated: null }
                    )
                );
            }

            if (!isPlainObject(data)) {
                throw new InvalidArgument(`Association "${anchor}" expects an object as input.`, {
                    entity: this.meta.name,
                    anchor,
                    remote: assocMeta.entity,
                });
            }

            if (beforeEntityUpdate) {
                if (isEmpty(data)) return;

                // refersTo or belongsTo
                let destEntityId = getValueFromAny([context.existing, context.options.$where, context.raw], anchor);

                if (destEntityId == null) {
                    if (isEmpty(context.existing)) {
                        context.existing = await this.findOne_({ $where: context.options.$where });
                        if (!context.existing) {
                            throw new ValidationError(`The entity "${this.meta.name}" to be update is not found.`, {
                                query: context.options.$where,
                            });
                        }
                        destEntityId = context.existing[anchor];
                    }

                    if (destEntityId == null) {
                        // to create the associated, existing is null
                        let created = await assocModel.create_(data, {
                            ...passOnOptions,
                            $upsert: true,
                            $getCreated: [assocMeta.field],
                        });

                        if (created.affectedRows === 0) {
                            throw new DatabaseError('Failed to create or update the referenced entity.', {
                                entity: assocModel.meta.name,
                                data,
                            });
                        }

                        context.raw[anchor] = created.data[assocMeta.field];
                        return;
                    }
                }

                return assocModel.updateOne_(data, { ...passOnOptions, [assocMeta.field]: destEntityId });
            }

            // hasOne
            return assocModel.create_(
                { ...data, [assocMeta.field]: currentKeyValue },
                { ...passOnOptions, $upsert: true, $getCreated: null }
            );
        });

        return pendingAssocs;
    }
}

export default RelationalEntityModel;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Mon Nov 04 2024 16:08:52 GMT+0800 (China Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
