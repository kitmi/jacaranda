{"version":3,"sources":["../src/createAuth.js"],"sourcesContent":["import { _, get } from '@kitmi/utils';\n\n// Cache for storing user tokens\nconst tokenCache = {};\n\nconst jwtAuth = async (client, accessToken) => {\n    if (accessToken == null) {\n        throw new Error(`\"accessToken\" is required.`);\n    }\n\n    // Add the token to the Authorization header of each request\n    client.onSending = (req) => {\n        req.set('Authorization', `Bearer ${accessToken}`);\n    };\n};\n\nconst passwordAuth = async (client, loginOptions) => {\n    if (!loginOptions.endpoint || !loginOptions.username || !loginOptions.password) {\n        throw new Error(`\"endpoint\", \"username\", \"password\" is required.`);\n    }\n\n    let body = await client.post(\n        loginOptions.endpoint,\n        {\n            username: loginOptions.username,\n            password: loginOptions.password,\n        },\n        loginOptions.query,\n        loginOptions.headers ? { headers: loginOptions.headers } : null\n    );\n    if (loginOptions.tokenKey) {\n        accessToken = get(body, loginOptions.tokenKey);\n    } else {\n        accessToken = body.token;\n    }\n};\n\nconst loginMethods = {\n    password: passwordAuth,\n};\nconst accessMethods = {\n    jwt: jwtAuth,\n};\n\n/**\n * Returns a middleware function that adds user authentication to a client.\n * @param {string} authKey - The user tag or user authentication object.\n * @param {Object} authConfig - The user authentication settings.\n * @returns {Function} A middleware function that adds user authentication to a client.\n * @throws {Error} If the user authentication settings are missing required fields.\n */\nfunction createAuth(authKey, authConfig) {\n    const { loginType = 'password', accessType = 'jwt' } = authConfig;\n\n    const accessMethod = accessMethods[accessType];\n    if (!accessMethod) {\n        throw new Error(`Unsuppported accessType \"${accessType}\". Should be one of ${_.keys(accessMethods)}.`);\n    }\n\n    return async (client) => {\n        let accessToken = tokenCache[authKey];\n\n        // If the token is not cached, authenticate the user and cache the token\n        if (!accessToken) {\n            const loginMethod = loginMethods[loginType];\n            if (!loginMethod) {\n                throw new Error(`Unsuppported loginType \"${loginType}\". Should be one of ${_.keys(loginMethods)}.`);\n            }\n\n            tokenCache[authKey] = accessToken = await loginMethod(client, authConfig.loginOptions);\n        }\n\n        await accessMethod(client, accessToken);\n    };\n}\n\nexport default createAuth;\n"],"names":["tokenCache","jwtAuth","client","accessToken","Error","onSending","req","set","passwordAuth","loginOptions","endpoint","username","password","body","post","query","headers","tokenKey","get","token","loginMethods","accessMethods","jwt","createAuth","authKey","authConfig","loginType","accessType","accessMethod","_","keys","loginMethod"],"mappings":";;;;+BA4EA;;;eAAA;;;uBA5EuB;AAEvB,gCAAgC;AAChC,MAAMA,aAAa,CAAC;AAEpB,MAAMC,UAAU,OAAOC,QAAQC;IAC3B,IAAIA,gBAAe,MAAM;QACrB,MAAM,IAAIC,MAAM,CAAC,0BAA0B,CAAC;IAChD;IAEA,4DAA4D;IAC5DF,OAAOG,SAAS,GAAG,CAACC;QAChBA,IAAIC,GAAG,CAAC,iBAAiB,CAAC,OAAO,EAAEJ,aAAY,CAAC;IACpD;AACJ;AAEA,MAAMK,eAAe,OAAON,QAAQO;IAChC,IAAI,CAACA,aAAaC,QAAQ,IAAI,CAACD,aAAaE,QAAQ,IAAI,CAACF,aAAaG,QAAQ,EAAE;QAC5E,MAAM,IAAIR,MAAM,CAAC,+CAA+C,CAAC;IACrE;IAEA,IAAIS,OAAO,MAAMX,OAAOY,IAAI,CACxBL,aAAaC,QAAQ,EACrB;QACIC,UAAUF,aAAaE,QAAQ;QAC/BC,UAAUH,aAAaG,QAAQ;IACnC,GACAH,aAAaM,KAAK,EAClBN,aAAaO,OAAO,GAAG;QAAEA,SAASP,aAAaO,OAAO;IAAC,IAAI;IAE/D,IAAIP,aAAaQ,QAAQ,EAAE;QACvBd,cAAce,IAAAA,UAAG,EAACL,MAAMJ,aAAaQ,QAAQ;IACjD,OAAO;QACHd,cAAcU,KAAKM,KAAK;IAC5B;AACJ;AAEA,MAAMC,eAAe;IACjBR,UAAUJ;AACd;AACA,MAAMa,gBAAgB;IAClBC,KAAKrB;AACT;AAEA;;;;;;CAMC,GACD,SAASsB,WAAWC,OAAO,EAAEC,UAAU;IACnC,MAAM,EAAEC,YAAY,UAAU,EAAEC,aAAa,KAAK,EAAE,GAAGF;IAEvD,MAAMG,eAAeP,aAAa,CAACM,WAAW;IAC9C,IAAI,CAACC,cAAc;QACf,MAAM,IAAIxB,MAAM,CAAC,yBAAyB,EAAEuB,WAAW,oBAAoB,EAAEE,QAAC,CAACC,IAAI,CAACT,eAAe,CAAC,CAAC;IACzG;IAEA,OAAO,OAAOnB;QACV,IAAIC,eAAcH,UAAU,CAACwB,QAAQ;QAErC,wEAAwE;QACxE,IAAI,CAACrB,cAAa;YACd,MAAM4B,cAAcX,YAAY,CAACM,UAAU;YAC3C,IAAI,CAACK,aAAa;gBACd,MAAM,IAAI3B,MAAM,CAAC,wBAAwB,EAAEsB,UAAU,oBAAoB,EAAEG,QAAC,CAACC,IAAI,CAACV,cAAc,CAAC,CAAC;YACtG;YAEApB,UAAU,CAACwB,QAAQ,GAAGrB,eAAc,MAAM4B,YAAY7B,QAAQuB,WAAWhB,YAAY;QACzF;QAEA,MAAMmB,aAAa1B,QAAQC;IAC/B;AACJ;MAEA,WAAeoB"}