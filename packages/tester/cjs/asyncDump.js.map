{"version":3,"sources":["../src/asyncDump.js"],"sourcesContent":["import { createHook } from 'node:async_hooks';\nimport { stackTraceFilter } from 'mocha/lib/utils';\nimport path from 'node:path';\nimport fs from 'node:fs/promises';\nconst allResources = new Map();\n\n// this will pull Mocha internals out of the stacks\nconst filterStack = stackTraceFilter();\n\nconst hook = createHook({\n    init(asyncId, type, triggerAsyncId) {\n        allResources.set(asyncId, { type, triggerAsyncId, stack: new Error().stack });\n    },\n    destroy(asyncId) {\n        allResources.delete(asyncId);\n    },\n    promiseResolve(asyncId) {\n        allResources.delete(asyncId);\n    },\n}).enable();\n\nconst asyncDump = async (dumpFile) => {\n    hook.disable();\n\n    const logs = [];\n\n    allResources.forEach((value) => {\n        const filteredStack = filterStack(value.stack);\n        if (filteredStack.includes('at promiseInitHookWithDestroyTracking'))\n        {\n            // ignore promiseInitHookWithDestroyTracking\n            return;\n        }\n\n        logs.push(`Type: ${value.type}`);\n        logs.push(filteredStack);\n        logs.push('\\n');\n    });\n\n    dumpFile = path.resolve(process.cwd(), dumpFile || './async-dump.log');\n    await fs.writeFile(dumpFile, logs.join('\\n'), 'utf8');\n    console.log(`Async dump written to ${dumpFile}`);\n};\n\nexport default asyncDump;\n"],"names":["allResources","Map","filterStack","stackTraceFilter","hook","createHook","init","asyncId","type","triggerAsyncId","set","stack","Error","destroy","delete","promiseResolve","enable","asyncDump","dumpFile","disable","logs","forEach","value","filteredStack","includes","push","path","resolve","process","cwd","fs","writeFile","join","console","log"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BA4CA;;;eAAA;;;iCA5C2B;uBACM;iEAChB;iEACF;;;;;;AACf,MAAMA,eAAe,IAAIC;AAEzB,mDAAmD;AACnD,MAAMC,cAAcC,IAAAA,uBAAgB;AAEpC,MAAMC,OAAOC,IAAAA,2BAAU,EAAC;IACpBC,MAAKC,OAAO,EAAEC,IAAI,EAAEC,cAAc;QAC9BT,aAAaU,GAAG,CAACH,SAAS;YAAEC;YAAMC;YAAgBE,OAAO,IAAIC,QAAQD,KAAK;QAAC;IAC/E;IACAE,SAAQN,OAAO;QACXP,aAAac,MAAM,CAACP;IACxB;IACAQ,gBAAeR,OAAO;QAClBP,aAAac,MAAM,CAACP;IACxB;AACJ,GAAGS,MAAM;AAET,MAAMC,YAAY,OAAOC;IACrBd,KAAKe,OAAO;IAEZ,MAAMC,OAAO,EAAE;IAEfpB,aAAaqB,OAAO,CAAC,CAACC;QAClB,MAAMC,gBAAgBrB,YAAYoB,MAAMX,KAAK;QAC7C,IAAIY,cAAcC,QAAQ,CAAC,0CAC3B;YACI,4CAA4C;YAC5C;QACJ;QAEAJ,KAAKK,IAAI,CAAC,CAAC,MAAM,EAAEH,MAAMd,IAAI,CAAC,CAAC;QAC/BY,KAAKK,IAAI,CAACF;QACVH,KAAKK,IAAI,CAAC;IACd;IAEAP,WAAWQ,iBAAI,CAACC,OAAO,CAACC,QAAQC,GAAG,IAAIX,YAAY;IACnD,MAAMY,iBAAE,CAACC,SAAS,CAACb,UAAUE,KAAKY,IAAI,CAAC,OAAO;IAC9CC,QAAQC,GAAG,CAAC,CAAC,sBAAsB,EAAEhB,SAAS,CAAC;AACnD;MAEA,WAAeD"}