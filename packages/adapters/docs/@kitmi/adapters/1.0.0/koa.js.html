<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="WebServer.html#event:httpReady">httpReady</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">koa.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import http from 'node:http';
import { _, toBoolean, text } from '@kitmi/utils';

class KoaEngine {
    constructor(app) {
        this.app = app;
    }

    async init_(config) {
        const Koa = await this.app.tryRequire_('koa');
        const mounter = await this.app.tryRequire_('koa-mount');
        const Router = await this.app.tryRequire_('@koa/router');

        //create a koa instance and inject the appModule instance in the first middleware
        const createEngine = (engineWrapper) => {
            const koa = new Koa();

            //inject the appModule instance in the first middleware
            koa.use((ctx, next) => {
                ctx.appModule = engineWrapper.app;                
                return next();
            });

            return koa;
        }        

        //create a sub engine instance and inject the appModule instance in the first middleware
        this.createSubEngine = (subApp) => {
            const subEngineWrapper = new KoaEngine(subApp);
            subEngineWrapper.koa = createEngine(subEngineWrapper);
        };

        //create a router instance
        this.createRouter = (baseRoute) => {
            return (!baseRoute || baseRoute === '/') ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });
        };

        //mount a sub engine instance
        this.mount = (route, childApp) => {
            this.koa.use(mounter(route, childApp.engine.koa));
        }

        this.koa = createEngine(this);
        this._initialize(config);        
    }    

    _initialize(options) {
        const koa = this.koa;
        const server = this.app;
        koa.proxy = options.trustProxy &amp;&amp; toBoolean(options.trustProxy);

        if (options.subdomainOffset != null) {
            koa.subdomainOffset = options.subdomainOffset;
        }

        if (options.keys) {
            koa.keys = _.castArray(options.keys);
        }

        koa.on('error', (err, ctx) => {
            const info = { err, app: ctx.appModule.name };

            if (err.status &amp;&amp; err.status &lt; 500) {
                if (ctx.log) {
                    ctx.log.warn(info);
                } else {
                    ctx.appModule.log('warn', 'REQUEST ERROR', info);
                }

                return;
            }

            if (ctx.log) {
                ctx.log.error(info);
            } else {
                ctx.appModule.log('error', 'SERVER ERROR', info);
            }
        });

        server.httpServer = http.createServer(koa.callback());

        let port = options.httpPort || 2331;

        server.on('ready', () => {
            server.httpServer.listen(port, function (err) {
                if (err) throw err;

                let address = server.httpServer.address();

                let host;
                if (address.family === 'IPv6' &amp;&amp; address.address === '::') {
                    host = '127.0.0.1';
                } else {
                    host = address.address;
                }

                server.host = `${host}:${address.port}`;
                server.port = address.port;

                server.log('info', `A koa http service is listening on port [${address.port}] ...`);
                /**
                 * Http server ready event
                 * @event WebServer#httpReady
                 */
                server.emit_('httpReady', server);
            });
        });
    }

    use(middleware) {
        this.koa.use(middleware);
    }

    attach(router) {
        this.koa.use(router.routes());
        this.koa.use(router.allowedMethods());
    }
}

export default KoaEngine;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sat Dec 09 2023 11:42:02 GMT+0800 (Central Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
