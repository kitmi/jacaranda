{"version":3,"sources":["../../src/serverEngines/koa.js"],"sourcesContent":["import http from 'node:http';\nimport { _, toBoolean, text } from '@kitmi/utils';\n\nclass KoaEngine {\n    static packages = ['koa', 'koa-mount', '@koa/router', 'koa-body', 'koa-compress', 'koa-etag', 'koa-static'];\n\n    constructor(appModule) {\n        this.app = appModule;\n    }\n\n    async init_(config) {\n        this.app.addMiddlewaresRegistry({\n            body: 'koa-body',\n            compress: 'koa-compress',\n            etag: 'koa-etag',\n        });\n\n        const options = this.app.featureConfig(\n            config,\n            {\n                schema: {\n                    trustProxy: { type: 'boolean', optional: true },\n                    subdomainOffset: { type: 'integer', optional: true, post: [['~min', 2]] },\n                    port: { type: 'integer', optional: true, default: 2331 },\n                    keys: [\n                        {\n                            type: 'text',\n                        },\n                        {\n                            type: 'array',\n                            optional: true,\n                            element: { type: 'text' },\n                            post: [['~minLength', 1]],\n                        },\n                    ],\n                },\n            },\n            'engine'\n        );\n\n        const Koa = await this.app.tryRequire_('koa');\n        const mounter = await this.app.tryRequire_('koa-mount');\n        const Router = await this.app.tryRequire_('@koa/router');\n\n        const _initEngine = (engine, isServerDefault) => {\n            const koa = new Koa();\n\n            //inject the appModule instance in the first middleware\n            if (!isServerDefault) {\n                koa.use((ctx, next) => {\n                    ctx.module = engine.app;\n                    return next();\n                });\n            }\n\n            //create a router instance\n            engine.createRouter = (baseRoute) => {\n                return !baseRoute || baseRoute === '/'\n                    ? new Router()\n                    : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });\n            };\n\n            //mount a sub engine instance\n            engine.mount = (route, moduleRouter) => {\n                koa.use(mounter(route, moduleRouter.koa));\n            };\n\n            engine.koa = koa;\n        };\n\n        //create a module router\n        this.createModuleRouter = (appModule, isServerDefault) => {\n            const moduleEngine = new KoaEngine(appModule);\n            _initEngine(moduleEngine, isServerDefault);\n            return moduleEngine;\n        };\n\n        _initEngine(this);\n        this._initializeServerEngine(options);\n    }\n\n    _initializeServerEngine(options) {\n        const koa = this.koa;\n        const server = this.app;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            const info = { err, app: ctx.module.name };\n\n            if (err.status && err.status < 500) {\n                if (ctx.log) {\n                    ctx.log.warn(info);\n                } else {\n                    ctx.module.log('warn', 'REQUEST ERROR', info);\n                }\n\n                return;\n            }\n\n            if (ctx.log) {\n                ctx.log.error(info);\n            } else {\n                ctx.module.log('error', 'SERVER ERROR', info);\n            }\n        });\n\n        server.httpServer = http.createServer(koa.callback());\n\n        let port = options.port;\n\n        server.once('ready', async () => {\n            return new Promise((resolve, reject) => {\n                server.httpServer.listen(port, function (err) {\n                    if (err) {\n                        return reject(err);\n                    }\n\n                    let address = server.httpServer.address();\n\n                    let host;\n                    if (address.family === 'IPv6' && address.address === '::') {\n                        host = '127.0.0.1';\n                    } else {\n                        host = address.address;\n                    }\n\n                    server.host = `${host}:${address.port}`;\n                    server.port = address.port;\n\n                    server.log('info', `A koa http service is listening on port [${address.port}] ...`);\n                    resolve();\n                });\n            });\n        });\n    }\n\n    use(middleware) {\n        this.koa.use(middleware);\n    }\n\n    attach(router) {\n        this.koa.use(router.routes());\n        this.koa.use(router.allowedMethods());\n    }\n}\n\nexport default KoaEngine;\n"],"names":["KoaEngine","init_","config","app","addMiddlewaresRegistry","body","compress","etag","options","featureConfig","schema","trustProxy","type","optional","subdomainOffset","post","port","default","keys","element","Koa","tryRequire_","mounter","Router","_initEngine","engine","isServerDefault","koa","use","ctx","next","module","createRouter","baseRoute","prefix","text","dropIfEndsWith","mount","route","moduleRouter","createModuleRouter","appModule","moduleEngine","_initializeServerEngine","server","proxy","toBoolean","_","castArray","on","err","info","name","status","log","warn","error","httpServer","http","createServer","callback","once","Promise","resolve","reject","listen","address","host","family","middleware","attach","router","routes","allowedMethods","constructor","packages"],"mappings":"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"}