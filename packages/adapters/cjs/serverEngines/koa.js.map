{"version":3,"sources":["../../src/serverEngines/koa.js"],"sourcesContent":["import http from 'node:http';\nimport { _, toBoolean, text } from '@kitmi/utils';\n\nclass KoaEngine {\n    constructor(app) {\n        this.app = app;\n    }\n\n    async init_(config) {\n        const Koa = await this.app.tryRequire_('koa');\n        const mounter = await this.app.tryRequire_('koa-mount');\n        const Router = await this.app.tryRequire_('@koa/router');\n\n        //create a koa instance and inject the appModule instance in the first middleware\n        const createEngine = (engineWrapper) => {\n            const koa = new Koa();\n\n            //inject the appModule instance in the first middleware\n            koa.use((ctx, next) => {\n                ctx.appModule = engineWrapper.app;\n                return next();\n            });\n\n            return koa;\n        };\n\n        //create a sub engine instance and inject the appModule instance in the first middleware\n        this.createSubEngine = (subApp) => {\n            const subEngineWrapper = new KoaEngine(subApp);\n            subEngineWrapper.koa = createEngine(subEngineWrapper);\n        };\n\n        //create a router instance\n        this.createRouter = (baseRoute) => {\n            return !baseRoute || baseRoute === '/'\n                ? new Router()\n                : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });\n        };\n\n        //mount a sub engine instance\n        this.mount = (route, childApp) => {\n            this.koa.use(mounter(route, childApp.engine.koa));\n        };\n\n        this.koa = createEngine(this);\n        this._initialize(config);\n    }\n\n    _initialize(options) {\n        const koa = this.koa;\n        const server = this.app;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            const info = { err, app: ctx.appModule.name };\n\n            if (err.status && err.status < 500) {\n                if (ctx.log) {\n                    ctx.log.warn(info);\n                } else {\n                    ctx.appModule.log('warn', 'REQUEST ERROR', info);\n                }\n\n                return;\n            }\n\n            if (ctx.log) {\n                ctx.log.error(info);\n            } else {\n                ctx.appModule.log('error', 'SERVER ERROR', info);\n            }\n        });\n\n        server.httpServer = http.createServer(koa.callback());\n\n        let port = options.port;\n\n        server.on('ready', async () => {\n            return new Promise((resolve, reject) => {\n                server.httpServer.listen(port, function (err) {\n                    if (err) {\n                        return reject(err);\n                    }\n\n                    let address = server.httpServer.address();\n\n                    let host;\n                    if (address.family === 'IPv6' && address.address === '::') {\n                        host = '127.0.0.1';\n                    } else {\n                        host = address.address;\n                    }\n\n                    server.host = `${host}:${address.port}`;\n                    server.port = address.port;\n\n                    server.log('info', `A koa http service is listening on port [${address.port}] ...`);\n                    resolve();\n                });\n            });\n        });\n    }\n\n    use(middleware) {\n        this.koa.use(middleware);\n    }\n\n    attach(router) {\n        this.koa.use(router.routes());\n        this.koa.use(router.allowedMethods());\n    }\n}\n\nexport default KoaEngine;\n"],"names":["KoaEngine","init_","config","Koa","app","tryRequire_","mounter","Router","createEngine","engineWrapper","koa","use","ctx","next","appModule","createSubEngine","subApp","subEngineWrapper","createRouter","baseRoute","prefix","text","dropIfEndsWith","mount","route","childApp","engine","_initialize","options","server","proxy","trustProxy","toBoolean","subdomainOffset","keys","_","castArray","on","err","info","name","status","log","warn","error","httpServer","http","createServer","callback","port","Promise","resolve","reject","listen","address","host","family","middleware","attach","router","routes","allowedMethods","constructor"],"mappings":"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"}