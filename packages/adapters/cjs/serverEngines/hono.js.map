{"version":3,"sources":["../../src/serverEngines/hono.js"],"sourcesContent":["import { _ } from '@kitmi/utils';\n\nclass HonoEngine {\n    constructor(app) {\n        this.app = app;\n    }\n\n    async init_(config) {\n        const { Hono } = await this.app.tryRequire_('hono');        \n\n        //create a hono instance and inject the appModule instance in the first middleware\n        const createEngine = (engineWrapper) => {\n            const hono = new Hono();\n\n            //inject the appModule instance in the first middleware\n            hono.use((ctx, next) => {\n                ctx.app = engineWrapper.app;\n                return next();\n            });\n\n            return hono;\n        };\n\n        //create an engine instance for a module\n        this.createModuleEngine = (subApp) => {\n            const subEngineWrapper = new KoaEngine(subApp);\n            subEngineWrapper.koa = createEngine(subEngineWrapper);\n        };\n\n        //create a router instance\n        this.createRouter = (baseRoute) => {\n            return !baseRoute || baseRoute === '/'\n                ? new Router()\n                : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });\n        };\n\n        //mount a sub engine instance\n        this.mount = (route, childApp) => {\n            this.hono.use(mounter(route, childApp.engine.koa));\n        };\n\n        this.hono = createEngine(this);\n        this._initialize(config);\n    }\n\n    _initialize(options) {\n        const koa = this.hono;\n        const server = this.app;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            const info = { err, app: ctx.app.name };\n\n            if (err.status && err.status < 500) {\n                if (ctx.log) {\n                    ctx.log.warn(info);\n                } else {\n                    ctx.app.log('warn', 'REQUEST ERROR', info);\n                }\n\n                return;\n            }\n\n            if (ctx.log) {\n                ctx.log.error(info);\n            } else {\n                ctx.app.log('error', 'SERVER ERROR', info);\n            }\n        });\n\n        server.httpServer = http.createServer(koa.callback());\n\n        let port = options.port;\n\n        server.once('ready', async () => {\n            return new Promise((resolve, reject) => {\n                server.httpServer.listen(port, function (err) {\n                    if (err) {\n                        return reject(err);\n                    }\n\n                    let address = server.httpServer.address();\n\n                    let host;\n                    if (address.family === 'IPv6' && address.address === '::') {\n                        host = '127.0.0.1';\n                    } else {\n                        host = address.address;\n                    }\n\n                    server.host = `${host}:${address.port}`;\n                    server.port = address.port;\n\n                    server.log('info', `A koa http service is listening on port [${address.port}] ...`);\n                    resolve();\n                });\n            });\n        });\n    }\n\n    use(middleware) {\n        this.hono.use(middleware);\n    }\n\n    attach(router) {\n        this.hono.use(router.routes());\n        this.hono.use(router.allowedMethods());\n    }\n}\n\nexport default HonoEngine;\n"],"names":["HonoEngine","init_","config","Hono","app","tryRequire_","createEngine","engineWrapper","hono","use","ctx","next","createModuleEngine","subApp","subEngineWrapper","KoaEngine","koa","createRouter","baseRoute","Router","prefix","text","dropIfEndsWith","mount","route","childApp","mounter","engine","_initialize","options","server","proxy","trustProxy","toBoolean","subdomainOffset","keys","_","castArray","on","err","info","name","status","log","warn","error","httpServer","http","createServer","callback","port","once","Promise","resolve","reject","listen","address","host","family","middleware","attach","router","routes","allowedMethods","constructor"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}