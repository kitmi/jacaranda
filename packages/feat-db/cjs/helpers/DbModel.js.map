{"version":3,"sources":["../../src/helpers/DbModel.js"],"sourcesContent":["class DbModel {\n    constructor(ownerModule, db, name) {\n        this.db = db;\n        this.ownerModule = ownerModule;\n        this.name = name;\n        this.model = db[this.name];\n    }\n\n    async retryCreate_(createOptions, onDuplicate_, maxRetry) {\n        maxRetry || (maxRetry = 99);\n        let retry = 0;\n        let error;\n\n        while (retry++ < maxRetry) {\n            try {\n                return await this.model.create(createOptions);\n            } catch (err) {\n                //P2002: Unique constraint failed\n                if (err.code !== this.E_CODE_DUPLICATE) {\n                    throw err;\n                }\n\n                createOptions = await onDuplicate_(createOptions);\n                error = err;\n            }\n        }\n\n        throw error;\n    }\n\n    async getCachedUnique_(key, query, ttl) {\n        const cacheService = this.db._$env.cacheService;\n        const cacheKey = `db:${this.name}:${key}`;\n        return cacheService.get_(cacheKey, () => modelInstance.model.findUnique(query), ttl);\n    }\n\n    async getCachedMany_(key, findMany, ttl) {\n        const cacheService = this.db._$env.cacheService;\n        const cacheKey = `db:${this.name}:${key}`;\n        return cacheService.get_(cacheKey, () => modelInstance.model.findMany(findMany), ttl);\n    };\n}\n\nexport class PrismaModel extends DbModel {\n    E_CODE_DUPLICATE = 'P2002';\n}\n\nexport default DbModel;"],"names":["PrismaModel","DbModel","retryCreate_","createOptions","onDuplicate_","maxRetry","retry","error","model","create","err","code","E_CODE_DUPLICATE","getCachedUnique_","key","query","ttl","cacheService","db","_$env","cacheKey","name","get_","modelInstance","findUnique","getCachedMany_","findMany","constructor","ownerModule"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;;;;IA2CaA,WAAW;eAAXA;;IAIb,OAAuB;eAAvB;;;;;;;;;;;;;;;;AA/CA,MAAMC;IAQF,MAAMC,aAAaC,aAAa,EAAEC,YAAY,EAAEC,QAAQ,EAAE;QACtDA,YAAaA,CAAAA,WAAW,EAAC;QACzB,IAAIC,QAAQ;QACZ,IAAIC;QAEJ,MAAOD,UAAUD,SAAU;YACvB,IAAI;gBACA,OAAO,MAAM,IAAI,CAACG,KAAK,CAACC,MAAM,CAACN;YACnC,EAAE,OAAOO,KAAK;gBACV,iCAAiC;gBACjC,IAAIA,IAAIC,IAAI,KAAK,IAAI,CAACC,gBAAgB,EAAE;oBACpC,MAAMF;gBACV;gBAEAP,gBAAgB,MAAMC,aAAaD;gBACnCI,QAAQG;YACZ;QACJ;QAEA,MAAMH;IACV;IAEA,MAAMM,iBAAiBC,GAAG,EAAEC,KAAK,EAAEC,GAAG,EAAE;QACpC,MAAMC,eAAe,IAAI,CAACC,EAAE,CAACC,KAAK,CAACF,YAAY;QAC/C,MAAMG,WAAW,CAAC,GAAG,EAAE,IAAI,CAACC,IAAI,CAAC,CAAC,EAAEP,IAAI,CAAC;QACzC,OAAOG,aAAaK,IAAI,CAACF,UAAU,IAAMG,cAAcf,KAAK,CAACgB,UAAU,CAACT,QAAQC;IACpF;IAEA,MAAMS,eAAeX,GAAG,EAAEY,QAAQ,EAAEV,GAAG,EAAE;QACrC,MAAMC,eAAe,IAAI,CAACC,EAAE,CAACC,KAAK,CAACF,YAAY;QAC/C,MAAMG,WAAW,CAAC,GAAG,EAAE,IAAI,CAACC,IAAI,CAAC,CAAC,EAAEP,IAAI,CAAC;QACzC,OAAOG,aAAaK,IAAI,CAACF,UAAU,IAAMG,cAAcf,KAAK,CAACkB,QAAQ,CAACA,WAAWV;IACrF;IAvCAW,YAAYC,WAAW,EAAEV,EAAE,EAAEG,IAAI,CAAE;QAC/B,IAAI,CAACH,EAAE,GAAGA;QACV,IAAI,CAACU,WAAW,GAAGA;QACnB,IAAI,CAACP,IAAI,GAAGA;QACZ,IAAI,CAACb,KAAK,GAAGU,EAAE,CAAC,IAAI,CAACG,IAAI,CAAC;IAC9B;AAmCJ;AAEO,MAAMrB,oBAAoBC;;;QAC7BW,uBAAAA,oBAAmB;;AACvB;MAEA,WAAeX"}