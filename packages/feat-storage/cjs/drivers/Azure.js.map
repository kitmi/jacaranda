{"version":3,"sources":["../../src/drivers/Azure.js"],"sourcesContent":["import { fxargs } from '@kitmi/utils';\nimport { DEFAULT_UPLOAD_EXPIRY, DEFAULT_DOWNLOAD_EXPIRY } from '../common';\n\nclass AzureService {\n    static packages = ['@azure/storage-blob'];\n\n    constructor(app, options) {\n        const { accountName, accountKey, bucket: containerName } = options;\n        const StorageBlob = app.tryRequire('@azure/storage-blob');\n\n        this.app = app;\n\n        const { BlobServiceClient, StorageSharedKeyCredential, BlobSASPermissions } = StorageBlob;\n\n        // Use StorageSharedKeyCredential with storage account and account key\n        // StorageSharedKeyCredential is only available in Node.js runtime, not in browsers\n        const sharedKeyCredential = new StorageSharedKeyCredential(accountName, accountKey);\n\n        const endpoint = `https://${accountName}.blob.core.windows.net`;\n\n        const blobServiceClient = new BlobServiceClient(endpoint, sharedKeyCredential);\n\n        this.client = blobServiceClient.getContainerClient(containerName);\n\n        this.createBlobSASPermissions = () => new BlobSASPermissions();\n    }\n\n    async getUploadUrl_(...args) {\n        const [objectKey, contentType, expiresInSeconds = DEFAULT_UPLOAD_EXPIRY, payload] = fxargs(args, [\n            'string',\n            'string',\n            'integer?',\n            'object?',\n        ]);\n\n        const blockBlobClient = this.client.getBlockBlobClient(objectKey);\n        const permissions = this.createBlobSASPermissions();\n        permissions.create = true;\n        permissions.write = true;\n\n        const expiresOn = this.app.now().plus({ seconds: expiresInSeconds }).toJSDate();\n\n        const options = {\n            expiresOn,\n            permissions,\n            contentType,\n            ...payload,\n        };\n\n        return blockBlobClient.generateSasUrl(options);\n    }\n\n    async getDownloadUrl_(...args) {\n        const [objectKey, expiresInSeconds = DEFAULT_DOWNLOAD_EXPIRY, payload] = fxargs(args, [\n            'string',\n            'integer?',\n            'object?',\n        ]);\n\n        const blockBlobClient = this.client.getBlockBlobClient(objectKey);\n        const permissions = this.createBlobSASPermissions();\n        permissions.read = true;\n\n        const expiresOn = this.app.now().plus({ seconds: expiresInSeconds }).toJSDate();\n\n        const options = {\n            expiresOn,\n            permissions,\n            ...payload,\n        };\n\n        return blockBlobClient.generateSasUrl(options);\n    }\n}\n\nmodule.exports = AzureService;\n"],"names":["AzureService","getUploadUrl_","args","objectKey","contentType","expiresInSeconds","DEFAULT_UPLOAD_EXPIRY","payload","fxargs","blockBlobClient","client","getBlockBlobClient","permissions","createBlobSASPermissions","create","write","expiresOn","app","now","plus","seconds","toJSDate","options","generateSasUrl","getDownloadUrl_","DEFAULT_DOWNLOAD_EXPIRY","read","constructor","accountName","accountKey","bucket","containerName","StorageBlob","tryRequire","BlobServiceClient","StorageSharedKeyCredential","BlobSASPermissions","sharedKeyCredential","endpoint","blobServiceClient","getContainerClient","packages","module","exports"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;uBAAuB;wBACwC;;;;;;;;;;;;;;AAE/D,MAAMA;IAwBF,MAAMC,cAAc,GAAGC,IAAI,EAAE;QACzB,MAAM,CAACC,WAAWC,aAAaC,mBAAmBC,6BAAqB,EAAEC,QAAQ,GAAGC,IAAAA,aAAM,EAACN,MAAM;YAC7F;YACA;YACA;YACA;SACH;QAED,MAAMO,kBAAkB,IAAI,CAACC,MAAM,CAACC,kBAAkB,CAACR;QACvD,MAAMS,cAAc,IAAI,CAACC,wBAAwB;QACjDD,YAAYE,MAAM,GAAG;QACrBF,YAAYG,KAAK,GAAG;QAEpB,MAAMC,YAAY,IAAI,CAACC,GAAG,CAACC,GAAG,GAAGC,IAAI,CAAC;YAAEC,SAASf;QAAiB,GAAGgB,QAAQ;QAE7E,MAAMC,UAAU;YACZN;YACAJ;YACAR;YACA,GAAGG,OAAO;QACd;QAEA,OAAOE,gBAAgBc,cAAc,CAACD;IAC1C;IAEA,MAAME,gBAAgB,GAAGtB,IAAI,EAAE;QAC3B,MAAM,CAACC,WAAWE,mBAAmBoB,+BAAuB,EAAElB,QAAQ,GAAGC,IAAAA,aAAM,EAACN,MAAM;YAClF;YACA;YACA;SACH;QAED,MAAMO,kBAAkB,IAAI,CAACC,MAAM,CAACC,kBAAkB,CAACR;QACvD,MAAMS,cAAc,IAAI,CAACC,wBAAwB;QACjDD,YAAYc,IAAI,GAAG;QAEnB,MAAMV,YAAY,IAAI,CAACC,GAAG,CAACC,GAAG,GAAGC,IAAI,CAAC;YAAEC,SAASf;QAAiB,GAAGgB,QAAQ;QAE7E,MAAMC,UAAU;YACZN;YACAJ;YACA,GAAGL,OAAO;QACd;QAEA,OAAOE,gBAAgBc,cAAc,CAACD;IAC1C;IAlEAK,YAAYV,GAAG,EAAEK,OAAO,CAAE;QACtB,MAAM,EAAEM,WAAW,EAAEC,UAAU,EAAEC,QAAQC,aAAa,EAAE,GAAGT;QAC3D,MAAMU,cAAcf,IAAIgB,UAAU,CAAC;QAEnC,IAAI,CAAChB,GAAG,GAAGA;QAEX,MAAM,EAAEiB,iBAAiB,EAAEC,0BAA0B,EAAEC,kBAAkB,EAAE,GAAGJ;QAE9E,sEAAsE;QACtE,mFAAmF;QACnF,MAAMK,sBAAsB,IAAIF,2BAA2BP,aAAaC;QAExE,MAAMS,WAAW,CAAC,QAAQ,EAAEV,YAAY,sBAAsB,CAAC;QAE/D,MAAMW,oBAAoB,IAAIL,kBAAkBI,UAAUD;QAE1D,IAAI,CAAC3B,MAAM,GAAG6B,kBAAkBC,kBAAkB,CAACT;QAEnD,IAAI,CAAClB,wBAAwB,GAAG,IAAM,IAAIuB;IAC9C;AAgDJ;AArEI,iBADEpC,cACKyC,YAAW;IAAC;CAAsB;AAuE7CC,OAAOC,OAAO,GAAG3C"}