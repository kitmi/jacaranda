{"version":3,"sources":["../../../src/lang/entityFeatures/userEditTracking.js"],"sourcesContent":["\"use strict\";\n\nconst FEATURE_NAME = \"userEditTracking\";\n\n/**\n * A rule specifies the entity to automatically record the creation time\n * @module EntityFeature_UserEditTracking\n */\n\n/**\n * Initialize the feature\n * @param {Entity} entity - Entity to apply this feature\n * @param {array} options - Field options\n */\nfunction feature(entity, [option]) {\n    const options = {\n        userEntity: \"user\",\n        uidSource: \"state.user.id\",\n        trackCreate: \"createdBy\",\n        trackUpdate: \"updatedBy\",\n        revisionField: \"revision\",\n        addFieldsOnly: false,\n        ...option,\n    };\n\n    const {\n        userEntity: userEntityName,\n        uidSource,\n        trackCreate,\n        trackUpdate,\n        revisionField,\n        addFieldsOnly,\n        migrationUser,\n    } = options;\n\n    if (!trackCreate && !trackUpdate) {\n        entity.linker.log(\n            \"warn\",\n            'Since both \"trackCreate\" and \"trackUpdate\" are disabled, the \"userEditTracking\" feature will not take any effect.'\n        );\n        return;\n    }\n\n    //todo: cross scheam support\n    const fields = {};\n\n    if (trackCreate) {\n        fields[\"createdBy\"] = trackCreate;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackCreate,\n            fieldProps: {\n                readOnly: true,\n                writeOnce: true,\n            },\n        });\n    }\n\n    if (trackUpdate) {\n        entity.once(\"afterAddingFields\", () => {\n            entity.addField(revisionField, {\n                type: \"integer\",\n                default: 0,\n            });\n        });\n\n        fields[\"updatedBy\"] = trackUpdate;\n        fields[\"revision\"] = revisionField;\n\n        entity.info.associations || (entity.info.associations = []);\n        entity.info.associations.push({\n            type: \"refersTo\",\n            destEntity: userEntityName,\n            srcField: trackUpdate,\n            fieldProps: {\n                readOnly: true,\n                optional: true,\n            },\n        });\n    }\n\n    if (!addFieldsOnly) {\n        entity.addFeature(FEATURE_NAME, {\n            fields,\n            uidSource,\n            migrationUser,\n        });\n    }\n}\n\nmodule.exports = feature;\n"],"names":["FEATURE_NAME","feature","entity","option","options","userEntity","uidSource","trackCreate","trackUpdate","revisionField","addFieldsOnly","userEntityName","migrationUser","linker","log","fields","info","associations","push","type","destEntity","srcField","fieldProps","readOnly","writeOnce","once","addField","default","optional","addFeature","module","exports"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA;AAEA,MAAMA,eAAe;AAErB;;;CAGC,GAED;;;;CAIC,GACD,SAASC,QAAQC,MAAM,EAAE,CAACC,OAAO;IAC7B,MAAMC,UAAU;QACZC,YAAY;QACZC,WAAW;QACXC,aAAa;QACbC,aAAa;QACbC,eAAe;QACfC,eAAe;QACf,GAAGP,MAAM;IACb;IAEA,MAAM,EACFE,YAAYM,cAAc,EAC1BL,SAAS,EACTC,WAAW,EACXC,WAAW,EACXC,aAAa,EACbC,aAAa,EACbE,aAAa,EAChB,GAAGR;IAEJ,IAAI,CAACG,eAAe,CAACC,aAAa;QAC9BN,OAAOW,MAAM,CAACC,GAAG,CACb,QACA;QAEJ;IACJ;IAEA,4BAA4B;IAC5B,MAAMC,SAAS,CAAC;IAEhB,IAAIR,aAAa;QACbQ,MAAM,CAAC,YAAY,GAAGR;QAEtBL,OAAOc,IAAI,CAACC,YAAY,IAAKf,CAAAA,OAAOc,IAAI,CAACC,YAAY,GAAG,EAAE,AAAD;QACzDf,OAAOc,IAAI,CAACC,YAAY,CAACC,IAAI,CAAC;YAC1BC,MAAM;YACNC,YAAYT;YACZU,UAAUd;YACVe,YAAY;gBACRC,UAAU;gBACVC,WAAW;YACf;QACJ;IACJ;IAEA,IAAIhB,aAAa;QACbN,OAAOuB,IAAI,CAAC,qBAAqB;YAC7BvB,OAAOwB,QAAQ,CAACjB,eAAe;gBAC3BU,MAAM;gBACNQ,SAAS;YACb;QACJ;QAEAZ,MAAM,CAAC,YAAY,GAAGP;QACtBO,MAAM,CAAC,WAAW,GAAGN;QAErBP,OAAOc,IAAI,CAACC,YAAY,IAAKf,CAAAA,OAAOc,IAAI,CAACC,YAAY,GAAG,EAAE,AAAD;QACzDf,OAAOc,IAAI,CAACC,YAAY,CAACC,IAAI,CAAC;YAC1BC,MAAM;YACNC,YAAYT;YACZU,UAAUb;YACVc,YAAY;gBACRC,UAAU;gBACVK,UAAU;YACd;QACJ;IACJ;IAEA,IAAI,CAAClB,eAAe;QAChBR,OAAO2B,UAAU,CAAC7B,cAAc;YAC5Be;YACAT;YACAM;QACJ;IACJ;AACJ;AAEAkB,OAAOC,OAAO,GAAG9B"}