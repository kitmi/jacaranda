/*
data: {
    id: 111,
    url: 'https://git.wsjn.hk/wj-lab/test-lab/pulls/4',
    number: 4,
    user: {
      id: 3,
      login: 'rockie',
      login_name: '',
      full_name: 'Rockie Guo',
      email: 'rockie@wsjn.hk',
      avatar_url: 'https://git.wsjn.hk/avatar/b984478430b410520f176ba13916fe3f',
      language: '',
      is_admin: false,
      last_login: '0001-01-01T00:00:00Z',
      created: '2023-07-11T18:37:44+08:00',
      restricted: false,
      active: false,
      prohibit_login: false,
      location: '',
      website: '',
      description: '',
      visibility: 'public',
      followers_count: 0,
      following_count: 0,
      starred_repos_count: 0,
      username: 'rockie'
    },
    title: 'Auto-created pull request from dev to main',
    body: '',
    labels: [],
    milestone: null,
    assignee: null,
    assignees: null,
    requested_reviewers: null,
    state: 'open',
    is_locked: false,
    comments: 0,
    html_url: 'https://git.wsjn.hk/wj-lab/test-lab/pulls/4',
    diff_url: 'https://git.wsjn.hk/wj-lab/test-lab/pulls/4.diff',
    patch_url: 'https://git.wsjn.hk/wj-lab/test-lab/pulls/4.patch',
    mergeable: true,
    merged: false,
    merged_at: null,
    merge_commit_sha: null,
    merged_by: null,
    allow_maintainer_edit: false,
    base: {
      label: 'main',
      ref: 'main',
      sha: 'ebae398350119aad15abaac8104f3c2817927ad5',
      repo_id: 69,
      repo: {
        id: 69,
        owner: {
          id: 11,
          login: 'wj-lab',
          login_name: '',
          full_name: '',
          email: '',
          avatar_url: 'https://git.wsjn.hk/avatars/2abf15af69b57bc9fd9285a26ed0e5aa43450de526eda402ecfd3552f71c511b',
          language: '',
          is_admin: false,
          last_login: '0001-01-01T00:00:00Z',
          created: '2023-10-03T12:30:13+08:00',
          restricted: false,
          active: false,
          prohibit_login: false,
          location: '',
          website: '',
          description: '',
          visibility: 'private',
          followers_count: 0,
          following_count: 0,
          starred_repos_count: 0,
          username: 'wj-lab'
        },
        name: 'test-lab',
        full_name: 'wj-lab/test-lab',
        description: '',
        empty: false,
        private: true,
        fork: false,
        template: false,
        parent: null,
        mirror: false,
        size: 172,
        language: '',
        languages_url: 'https://git.wsjn.hk/api/v1/repos/wj-lab/test-lab/languages',
        html_url: 'https://git.wsjn.hk/wj-lab/test-lab',
        url: 'https://git.wsjn.hk/api/v1/repos/wj-lab/test-lab',
        link: '',
        ssh_url: 'ssh://git@git.wsjn.hk:2222/wj-lab/test-lab.git',
        clone_url: 'https://git.wsjn.hk/wj-lab/test-lab.git',
        original_url: '',
        website: '',
        stars_count: 0,
        forks_count: 0,
        watchers_count: 2,
        open_issues_count: 0,
        open_pr_counter: 0,
        release_counter: 0,
        default_branch: 'main',
        archived: false,
        created_at: '2024-05-27T10:19:37+08:00',
        updated_at: '2024-07-11T16:22:00+08:00',
        archived_at: '1970-01-01T08:00:00+08:00',
        permissions: { admin: true, push: true, pull: true },
        has_issues: true,
        internal_tracker: {
          enable_time_tracker: true,
          allow_only_contributors_to_track_time: true,
          enable_issue_dependencies: true
        },
        has_wiki: true,
        has_pull_requests: true,
        has_projects: true,
        has_releases: true,
        has_packages: true,
        has_actions: false,
        ignore_whitespace_conflicts: false,
        allow_merge_commits: true,
        allow_rebase: true,
        allow_rebase_explicit: true,
        allow_squash_merge: true,
        allow_rebase_update: true,
        default_delete_branch_after_merge: false,
        default_merge_style: 'merge',
        default_allow_maintainer_edit: false,
        avatar_url: '',
        internal: false,
        mirror_interval: '',
        mirror_updated: '0001-01-01T00:00:00Z',
        repo_transfer: null
      }
    },
    head: {
      label: 'dev',
      ref: 'dev',
      sha: '4944f361ef742df858bb1f172455c7f6665fba18',
      repo_id: 69,
      repo: {
        id: 69,
        owner: {
          id: 11,
          login: 'wj-lab',
          login_name: '',
          full_name: '',
          email: '',
          avatar_url: 'https://git.wsjn.hk/avatars/2abf15af69b57bc9fd9285a26ed0e5aa43450de526eda402ecfd3552f71c511b',
          language: '',
          is_admin: false,
          last_login: '0001-01-01T00:00:00Z',
          created: '2023-10-03T12:30:13+08:00',
          restricted: false,
          active: false,
          prohibit_login: false,
          location: '',
          website: '',
          description: '',
          visibility: 'private',
          followers_count: 0,
          following_count: 0,
          starred_repos_count: 0,
          username: 'wj-lab'
        },
        name: 'test-lab',
        full_name: 'wj-lab/test-lab',
        description: '',
        empty: false,
        private: true,
        fork: false,
        template: false,
        parent: null,
        mirror: false,
        size: 172,
        language: '',
        languages_url: 'https://git.wsjn.hk/api/v1/repos/wj-lab/test-lab/languages',
        html_url: 'https://git.wsjn.hk/wj-lab/test-lab',
        url: 'https://git.wsjn.hk/api/v1/repos/wj-lab/test-lab',
        link: '',
        ssh_url: 'ssh://git@git.wsjn.hk:2222/wj-lab/test-lab.git',
        clone_url: 'https://git.wsjn.hk/wj-lab/test-lab.git',
        original_url: '',
        website: '',
        stars_count: 0,
        forks_count: 0,
        watchers_count: 2,
        open_issues_count: 0,
        open_pr_counter: 0,
        release_counter: 0,
        default_branch: 'main',
        archived: false,
        created_at: '2024-05-27T10:19:37+08:00',
        updated_at: '2024-07-11T16:22:00+08:00',
        archived_at: '1970-01-01T08:00:00+08:00',
        permissions: { admin: true, push: true, pull: true },
        has_issues: true,
        internal_tracker: {
          enable_time_tracker: true,
          allow_only_contributors_to_track_time: true,
          enable_issue_dependencies: true
        },
        has_wiki: true,
        has_pull_requests: true,
        has_projects: true,
        has_releases: true,
        has_packages: true,
        has_actions: false,
        ignore_whitespace_conflicts: false,
        allow_merge_commits: true,
        allow_rebase: true,
        allow_rebase_explicit: true,
        allow_squash_merge: true,
        allow_rebase_update: true,
        default_delete_branch_after_merge: false,
        default_merge_style: 'merge',
        default_allow_maintainer_edit: false,
        avatar_url: '',
        internal: false,
        mirror_interval: '',
        mirror_updated: '0001-01-01T00:00:00Z',
        repo_transfer: null
      }
    },
    merge_base: '05b4a6729212ffed067fa5253e58984984e62f2e',
    due_date: null,
    created_at: '2024-07-13T14:14:40+08:00',
    updated_at: '2024-07-13T14:14:40+08:00',
    closed_at: null,
    pin_order: 0
}
*/

/**
 * Create pull request
 * @param {ServiceContainer} app
 * @returns {Promise}
 */
module.exports = async (app) => {
    app.log('verbose', `${app.name} pr`);

    const { owner, repo, from, to, title, number, merge } = app.commandLine.argv;

    const gitea = app.getService('gitea');

    let pr;

    try {
        const res = await gitea.repos.repoCreatePullRequest(owner, repo, {
            title,
            head: from,
            base: to,
        });

        pr = res.data;
    } catch (e) {
        if (e instanceof Error) {
            throw e;
        }

        throw new Error(`Failed to create pull request, status: ${e.status}, text: ${e.statusText}`);
    }

    if (number) {
        console.log(pr.number);
        return;
    }

    app.log('info', `Successfully created pull request.`, {
        id: pr.id,
        index: pr.number,
        url: pr.url,
        mergeable: pr.mergeable,
    });

    if (merge) {
        if (!pr.mergeable) {
            throw new Error(`Pull request #${pr.number} is not mergeable.`);
        }

        try {
            await gitea.repos.repoMergePullRequest(owner, repo, pr.number, {
                Do: 'merge',
            });
        } catch (e) {
            if (e instanceof Error) {
                throw e;
            }

            throw new Error(`Failed to merge pull request, status: ${e.status}, text: ${e.statusText}`);
        }

        app.log('info', `Successfully merged pull request.`, {
            id: pr.id,
            index: pr.number,
            url: pr.url,
        });
    }
};
